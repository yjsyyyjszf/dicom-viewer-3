{"ast":null,"code":"var _jsxFileName = \"/media/mohammad/work/websites/cornerstone/dicom-viewer/src/components/DicomViewer.js\";\nimport React from \"react\";\nimport { connect } from 'react-redux';\nimport Button from '@material-ui/core/Button';\nimport Dialog from '@material-ui/core/Dialog';\nimport DialogActions from '@material-ui/core/DialogActions';\nimport DialogContent from '@material-ui/core/DialogContent';\nimport DialogContentText from '@material-ui/core/DialogContentText';\nimport DialogTitle from '@material-ui/core/DialogTitle';\nimport Link from '@material-ui/core/Link';\nimport Typography from '@material-ui/core/Typography';\nimport Hammer from \"hammerjs\";\nimport * as cornerstone from \"cornerstone-core\";\nimport * as cornerstoneTools from \"cornerstone-tools\";\nimport * as cornerstoneMath from \"cornerstone-math\";\nimport * as cornerstoneFileImageLoader from \"cornerstone-file-image-loader\";\nimport * as cornerstoneWebImageLoader from \"cornerstone-web-image-loader\";\nimport * as cornerstoneWADOImageLoader from \"cornerstone-wado-image-loader\";\nimport * as dicomParser from 'dicom-parser';\nimport * as blobUtil from 'blob-util';\nimport { uids } from '../constants/uids';\nimport { SETTINGS_SAVEAS } from '../constants/settings';\nimport OpenUrlDlg from './OpenUrlDlg';\nimport CinePlayer from './CinePlayer';\nimport { isMobile } from 'react-device-detect';\nimport { import as csTools } from 'cornerstone-tools';\nimport db from '../db/db';\nimport fs from '../fs/fs';\nimport { clearStore, dcmIsOpen, activeDcm, dcmTool, activeMeasurements, doFsRefresh } from '../actions';\nimport { capitalize, getFileName, getSettingsOverlay, isFileImage, isFsFileImage, isUrlImage, getSettingsSaveInto } from '../functions';\nconst scrollToIndex = csTools('util/scrollToIndex');\n/*\nfunction getBlobUrl(url) {\n  const baseUrl = window.URL || window.webkitURL;\n  const blob = new Blob([`importScripts('${url}')`], {type: \"application/javascript\"});\n  return baseUrl.createObjectURL(blob);\n}\n\nlet webWorkerUrl = getBlobUrl(\n  \"https://unpkg.com/cornerstone-wado-image-loader@3.0.0/dist/cornerstoneWADOImageLoaderWebWorker.min.js\"\n)\nlet codecsUrl = getBlobUrl(\n  \"https://unpkg.com/cornerstone-wado-image-loader@3.0.0/dist/cornerstoneWADOImageLoaderCodecs.js\"\n  // \"https://unpkg.com/cornerstone-wado-image-loader/dist/cornerstoneWADOImageLoaderCodecs.js\"\n)\n// See componentDidMount line 110 for initialization, registration\n\nconst config = {\n  maxWebWorkers: 4, //\n  //startWebWorkersOnDemand: true, //\n  webWorkerPath: webWorkerUrl,\n  //webWorkerTaskPaths: [], //\n  taskConfiguration: {\n    decodeTask: {\n      //loadCodecsOnStartup: true, //\n      //initializeCodecsOnStartup: false, //\n      codecsPath: codecsUrl,\n      //usePDFJS: false, //\n      //strict: true //\n    }\n  }\n}\nvar config = {\n  maxWebWorkers: navigator.hardwareConcurrency || 1,\n  startWebWorkersOnDemand: false,\n}\n*/\n\ncornerstoneTools.external.cornerstone = cornerstone;\ncornerstoneTools.external.cornerstoneMath = cornerstoneMath;\ncornerstoneFileImageLoader.external.cornerstone = cornerstone;\ncornerstoneWebImageLoader.external.cornerstone = cornerstone;\ncornerstoneWADOImageLoader.external.cornerstone = cornerstone; //cornerstoneWADOImageLoader.webWorkerManager.initialize(config)\n\ncornerstoneWADOImageLoader.external.dicomParser = dicomParser;\ncornerstoneTools.external.Hammer = Hammer;\ncornerstoneTools.init(); //console.log({ cornerstone })\n//console.log({ cornerstoneWADOImageLoader })\n//console.log({ dicomParser })\n\nclass DicomViewer extends React.Component {\n  constructor(props) {\n    super(props);\n    this.state = {\n      visibleOpenUrlDlg: false,\n      progress: null,\n      visibleCinePlayer: false,\n      errorOnOpenImage: null,\n      errorOnCors: false,\n      frame: 1,\n      inPlay: false,\n      viewport: null\n    };\n\n    this.onOpenUrl = e => {\n      const eventData = e.detail;\n      this.setState({\n        progress: eventData.percentComplete\n      });\n    };\n\n    this.showOpenUrlDlg = url => {\n      this.setState({\n        visibleOpenUrlDlg: true\n      }, () => {\n        cornerstone.events.addEventListener('cornerstoneimageloadprogress', this.onOpenUrl);\n        this.loadImage(undefined, url);\n      });\n    };\n\n    this.hideOpenUrlDlg = () => {\n      this.setState({\n        visibleOpenUrlDlg: false,\n        progress: null\n      });\n    };\n\n    this.measurementSave = measure => {\n      this.measurements.push(measure);\n    };\n\n    this.measurementClear = () => {\n      this.measurements.splice(0, this.measurements.length);\n    };\n\n    this.measurementRemove = index => {\n      //console.log('this.measurements: ', this.measurements)\n      this.measurements.splice(index, 1);\n    };\n\n    this.getTransferSyntax = () => {\n      const value = this.image.data.string('x00020010');\n      return value + ' [' + uids[value] + ']';\n    };\n\n    this.getSopClass = () => {\n      const value = this.image.data.string('x00080016');\n      return value + ' [' + uids[value] + ']';\n    };\n\n    this.getSopInstanceUID = () => {\n      const value = this.image.data.string('x00080018');\n      return value;\n    };\n\n    this.getPixelRepresentation = () => {\n      const value = this.image.data.uint16('x00280103');\n      if (value === undefined) return;\n      return value + (value === 0 ? ' (unsigned)' : ' (signed)');\n    };\n\n    this.getPlanarConfiguration = () => {\n      const value = this.image.data.uint16('x00280006');\n      if (value === undefined) return;\n      return value + (value === 0 ? ' (pixel)' : ' (plane)');\n    };\n\n    this.onImageLoaded = e => {//console.log('cornerstoneimageloaded: ')\n    };\n\n    this.onImageRendered = e => {\n      //console.log('cornerstoneimagerendered: ', e.target)\n      //console.log('cornerstoneimagerendered, plane: ', this.mprPlane)\n      //const viewport = cornerstone.getViewport(this.dicomImage)\n      const viewport = cornerstone.getViewport(e.target); //console.log('viewport: ', viewport)\n      //if (this.props.activeDcm !== null)\n      //  console.log('viewport activeDcm: ', cornerstone.getViewport(this.props.activeDcm.element))\n\n      document.getElementById(`mrtopleft-${this.props.index}`).textContent = this.mprIsOrthogonalView() ? `${capitalize(this.mprPlane)}` : `${this.PatientsName}`;\n      document.getElementById(`mrtopright-${this.props.index}`).textContent = `${viewport.displayedArea.brhc.x}x${viewport.displayedArea.brhc.y}`;\n      document.getElementById(`mrbottomleft-${this.props.index}`).textContent = `WW/WC: ${Math.round(viewport.voi.windowWidth)}/${Math.round(viewport.voi.windowCenter)}`;\n      document.getElementById(`mrbottomright-${this.props.index}`).textContent = `Zoom: ${Math.round(viewport.scale.toFixed(2) * 100)}%`;\n      document.getElementById(`mrtopcenter-${this.props.index}`).textContent = ``;\n      document.getElementById(`mrbottomcenter-${this.props.index}`).textContent = ``;\n      document.getElementById(`mrleftcenter-${this.props.index}`).textContent = ``;\n      document.getElementById(`mrrightcenter-${this.props.index}`).textContent = ``;\n\n      if (this.mprPlane === 'sagittal') {\n        document.getElementById(`mrtopcenter-${this.props.index}`).textContent = `S`;\n        document.getElementById(`mrbottomcenter-${this.props.index}`).textContent = `I`;\n        document.getElementById(`mrleftcenter-${this.props.index}`).textContent = `A`;\n        document.getElementById(`mrrightcenter-${this.props.index}`).textContent = `P`;\n      } else if (this.mprPlane === 'axial') {\n        document.getElementById(`mrtopcenter-${this.props.index}`).textContent = `A`;\n        document.getElementById(`mrbottomcenter-${this.props.index}`).textContent = `P`;\n        document.getElementById(`mrleftcenter-${this.props.index}`).textContent = `R`;\n        document.getElementById(`mrrightcenter-${this.props.index}`).textContent = `L`;\n      } else if (this.mprPlane === 'coronal') {\n        document.getElementById(`mrtopcenter-${this.props.index}`).textContent = `S`;\n        document.getElementById(`mrbottomcenter-${this.props.index}`).textContent = `I`;\n        document.getElementById(`mrleftcenter-${this.props.index}`).textContent = `R`;\n        document.getElementById(`mrrightcenter-${this.props.index}`).textContent = `L`;\n      }\n\n      if (this.isDicom && this.state.visibleCinePlayer && this.numberOfFrames > 1) {\n        document.getElementById(`frameLabel-${this.props.index}`).textContent = `${this.state.frame} / ${this.numberOfFrames}`;\n\n        if (this.state.inPlay) {\n          let frame = this.state.frame === this.numberOfFrames ? 1 : this.state.frame + 1;\n          this.setState({\n            frame: frame\n          });\n        }\n      }\n    };\n\n    this.onMeasurementModified = e => {//console.log('cornerstonetoolsmeasurementmodified: ', e.detail.measurementData)\n    };\n\n    this.onMeasurementAdded = e => {\n      //console.log('cornerstonetoolsmeasurementadded: ', e.detail.measurementData)\n      if (this.props.tool !== \"Angle\") return;\n      const measure = {\n        tool: this.props.tool,\n        note: '',\n        data: e.detail.measurementData\n      };\n      this.measurementSave(measure);\n      this.props.setActiveMeasurements(this.measurements);\n    };\n\n    this.onMeasurementCompleted = e => {\n      //console.log('cornerstonetoolsmeasurementcompleted: ', e.detail.measurementData)\n      const measure = {\n        tool: this.props.tool,\n        note: '',\n        data: e.detail.measurementData\n      };\n\n      if (this.props.tool === \"FreehandRoi\") {\n        setTimeout(() => {\n          this.measurementSave(measure);\n          this.props.setActiveMeasurements(this.measurements);\n        }, 500);\n      } else {\n        this.measurementSave(measure);\n        this.props.setActiveMeasurements(this.measurements);\n      }\n    };\n\n    this.onErrorOpenImageClose = () => {\n      this.setState({\n        errorOnOpenImage: null\n      });\n    };\n\n    this.onErrorCorsClose = () => {\n      this.setState({\n        errorOnCors: false\n      });\n    };\n\n    this.displayImageFromFiles = index => {\n      // console.log('displayImageFromFiles: ', index)\n      const image = this.props.files[index].image;\n      const imageId = this.props.files[index].imageId;\n      this.filename = this.props.files[index].name;\n      const element = this.dicomImage;\n      element.addEventListener(\"cornerstonenewimage\", this.onNewImage);\n      element.addEventListener(\"cornerstoneimagerendered\", this.onImageRendered);\n      element.addEventListener(\"cornerstonetoolsmeasurementadded\", this.onMeasurementAdded);\n      element.addEventListener(\"cornerstonetoolsmeasurementmodified\", this.onMeasurementModified);\n      element.addEventListener(\"cornerstonetoolsmeasurementcompleted\", this.onMeasurementCompleted);\n      cornerstone.enable(element);\n      this.image = image;\n      this.isDicom = true;\n      this.PatientsName = image.data.string('x00100010');\n      this.sopInstanceUid = this.getSopInstanceUID();\n      let stack = {\n        currentImageIdIndex: 0,\n        imageIds: \"\"\n      };\n      this.numberOfFrames = image.data.intString('x00280008');\n\n      if (this.numberOfFrames > 0) {\n        let imageIds = [];\n\n        for (var i = 0; i < this.numberOfFrames; ++i) {\n          imageIds.push(imageId + \"?frame=\" + i);\n        }\n\n        stack.imageIds = imageIds;\n      }\n\n      cornerstone.displayImage(element, image);\n      /*const viewport = cornerstone.getViewport(this.dicomImage)\n      const lut =  cornerstone.generateLut(this.image, viewport.voi.windowWidth, viewport.voi.windowCenter, viewport.invert, viewport.modalityLUT, viewport.voiLUT)\n      this.props.setLutStore(lut)*/\n\n      this.mprPlanePosition();\n      this.enableTool();\n\n      if (this.numberOfFrames > 1) {\n        cornerstoneTools.addStackStateManager(element, ['stack', 'playClip']);\n        cornerstoneTools.addToolState(element, 'stack', stack);\n        this.setState({\n          frame: 1\n        });\n      } // Load the possible measurements from DB and save in the store \n\n\n      db.measurement.where('sopinstanceuid').equals(this.sopInstanceUid).each(measure => {\n        console.log('load measure from db: ', measure);\n        this.measurementSave(measure);\n        cornerstoneTools.addToolState(element, measure.tool, measure.data);\n        this.runTool(measure.tool);\n        cornerstone.updateImage(element);\n        cornerstoneTools.setToolEnabled(measure.tool);\n      }).then(() => {\n        this.props.setActiveMeasurements(this.measurements);\n        this.props.setActiveDcm({\n          image: this.image,\n          element: this.dicomImage,\n          isDicom: this.isDicom\n        });\n        this.props.setIsOpenStore({\n          index: this.props.index,\n          value: true\n        });\n      }); //this.overlayImage()\n    };\n\n    this.loadImageFromCanvas = canvas => {\n      console.log('loadImageFromCanvas, dcmViewer: ', this.props.index);\n      const element = this.dicomImage;\n      element.addEventListener(\"cornerstonenewimage\", this.onNewImage);\n      element.addEventListener(\"cornerstoneimagerendered\", this.onImageRendered);\n      element.addEventListener(\"cornerstonetoolsmeasurementadded\", this.onMeasurementAdded);\n      element.addEventListener(\"cornerstonetoolsmeasurementmodified\", this.onMeasurementModified);\n      element.addEventListener(\"cornerstonetoolsmeasurementcompleted\", this.onMeasurementCompleted);\n      cornerstone.enable(element);\n      const imageId = cornerstoneFileImageLoader.fileManager.addCanvas(canvas);\n      cornerstone.loadImage(imageId).then(image => {\n        //this.t1 = performance.now()\n        //console.log(`performance load image: ${this.t1-this.t0} milliseconds`)\n        console.log('loadImageFromCanvas, image: ', image);\n        this.image = image;\n        this.isDicom = false;\n        cornerstone.displayImage(element, image);\n        this.enableTool(); //this.props.setActiveDcm({image: this.image, element: this.dicomImage, isDicom: this.isDicom})\n\n        this.props.setIsOpenStore({\n          index: this.props.index,\n          value: true\n        }); //this.t2 = performance.now()\n        //console.log(`performance: ${this.t2-this.t1} milliseconds`)\n        //this.overlayImage()\n      }, e => {\n        console.log('error', e);\n        this.setState({\n          errorOnOpenImage: \"This is not a valid canvas.\"\n        });\n      });\n    };\n\n    this.loadImageFromCustomObject = (columns, rows, pixelData) => {\n      //console.log('loadImageFromCustomObject: ')\n      const element = this.dicomImage;\n      element.addEventListener(\"cornerstonenewimage\", this.onNewImage);\n      element.addEventListener(\"cornerstoneimagerendered\", this.onImageRendered);\n      element.addEventListener(\"cornerstonetoolsmeasurementadded\", this.onMeasurementAdded);\n      element.addEventListener(\"cornerstonetoolsmeasurementmodified\", this.onMeasurementModified);\n      element.addEventListener(\"cornerstonetoolsmeasurementcompleted\", this.onMeasurementCompleted);\n      cornerstone.enable(element);\n      let customObj = {\n        rows: rows,\n        columns: columns,\n        pixelData: pixelData,\n        image: this.originImage\n      };\n      const imageId = cornerstoneFileImageLoader.fileManager.addCustom(customObj);\n      cornerstone.loadImage(imageId).then(image => {\n        //console.log('loadImageFromCustomObject, image: ', image)\n        this.image = image;\n        this.isDicom = true;\n        cornerstone.displayImage(element, image); //this.enableTool()\n\n        this.props.setIsOpenStore({\n          index: this.props.index,\n          value: true\n        });\n      }, e => {\n        console.log('error', e);\n        this.setState({\n          errorOnOpenImage: \"This is not a valid canvas.\"\n        });\n      });\n    };\n\n    this.loadImage = (localfile, url = undefined, fsItem = undefined) => {\n      console.log('loadImage, localfile: ', localfile);\n      console.log('loadImage, fsItem: ', fsItem);\n      console.log('loadImage, url: ', url);\n      if (localfile === undefined && url === undefined && fsItem === undefined) return;\n\n      if (fsItem !== undefined) {\n        this.fsItem = fsItem;\n      } else if (localfile !== undefined) {\n        this.localfile = localfile;\n      } else {\n        this.localurl = url;\n      }\n\n      const element = this.dicomImage;\n      element.addEventListener(\"cornerstonenewimage\", this.onNewImage);\n      element.addEventListener(\"cornerstoneimagerendered\", this.onImageRendered);\n      element.addEventListener(\"cornerstonetoolsmeasurementadded\", this.onMeasurementAdded);\n      element.addEventListener(\"cornerstonetoolsmeasurementmodified\", this.onMeasurementModified);\n      element.addEventListener(\"cornerstonetoolsmeasurementcompleted\", this.onMeasurementCompleted);\n      let imageId = undefined;\n      cornerstone.enable(element);\n      let size = 0;\n\n      if (localfile === undefined && isUrlImage(url)) {\n        // check if it's a simple image [jpeg or png] from url\n        //console.log('image: ', file)\n        cornerstone.loadImage(url).then(image => {\n          //console.log('loadImage, image from url: ', image)\n          this.hideOpenUrlDlg();\n          this.image = image;\n          this.isDicom = false;\n          cornerstone.displayImage(element, image);\n          this.enableTool();\n          this.props.setActiveDcm({\n            image: this.image,\n            element: this.dicomImage,\n            isDicom: this.isDicom\n          });\n          this.props.isOpenStore(true);\n        }, e => {\n          console.log('error', e);\n          this.setState({\n            errorOnOpenImage: \"This is not a valid JPG or PNG file.\"\n          });\n        });\n      } else if (localfile !== undefined && isFileImage(localfile) || fsItem !== undefined && isFsFileImage(fsItem)) {\n        // otherwise try to open as local image file (JPEG, PNG) \n        if (fsItem !== undefined) {\n          imageId = cornerstoneFileImageLoader.fileManager.addBuffer(fsItem.data);\n        } else {\n          imageId = cornerstoneFileImageLoader.fileManager.add(localfile);\n        }\n\n        cornerstone.loadImage(imageId).then(image => {\n          console.log('loadImage, image from local: ', image);\n          this.image = image;\n          this.isDicom = false;\n          this.PatientsName = '';\n          console.log(\"image data:\" + image.data);\n          cornerstone.displayImage(element, image);\n          this.enableTool();\n          this.props.setActiveDcm({\n            image: this.image,\n            element: this.dicomImage,\n            isDicom: this.isDicom\n          }); //this.props.isOpenStore(true)\n\n          this.props.setIsOpenStore({\n            index: this.props.index,\n            value: true\n          });\n        }, e => {\n          console.log('error', e);\n          this.setState({\n            errorOnOpenImage: \"This is not a valid JPG or PNG file.\"\n          });\n        });\n      } else {\n        // otherwise try to open as Dicom file\n        if (fsItem !== undefined) {\n          imageId = cornerstoneWADOImageLoader.wadouri.fileManager.addBuffer(fsItem.data);\n          this.filename = fsItem.name;\n          size = fsItem.size;\n        } else if (localfile !== undefined) {\n          imageId = cornerstoneWADOImageLoader.wadouri.fileManager.add(localfile);\n          this.filename = localfile.name;\n          size = localfile.size;\n        } else {\n          // it's a web dicom image\n          imageId = \"wadouri:\" + url;\n        } //console.log('loadImage, imageId: ', imageId)\n\n\n        cornerstone.loadAndCacheImage(imageId).then(image => {\n          //console.log('loadImage, image: ', image)\n          //let pixelDataElement = image.data.elements.x7fe00010\n          //console.log('loadImage, pixelDataElement: ', pixelDataElement)\n          //console.log('loadImage, getPixelData: ', image.getPixelData())\n          this.hideOpenUrlDlg();\n          this.image = image;\n          this.isDicom = true;\n          this.PatientsName = image.data.string('x00100010');\n          this.sopInstanceUid = this.getSopInstanceUID();\n          let stack = {\n            currentImageIdIndex: 0,\n            imageIds: \"\"\n          };\n          this.numberOfFrames = image.data.intString('x00280008');\n\n          if (this.numberOfFrames > 0) {\n            let imageIds = [];\n\n            for (var i = 0; i < this.numberOfFrames; ++i) {\n              imageIds.push(imageId + \"?frame=\" + i);\n            }\n\n            stack.imageIds = imageIds;\n          }\n\n          cornerstone.displayImage(element, image); //cornerstoneTools.mouseInput.enable(element);\n          //cornerstoneTools.mouseWheelInput.enable(element);\n\n          this.enableTool();\n          /*const viewport = cornerstone.getViewport(this.dicomImage)\n          const lut =  cornerstone.generateLut(this.image, viewport.voi.windowWidth, viewport.voi.windowCenter, viewport.invert, viewport.modalityLUT, viewport.voiLUT)\n          console.log('lut: ', lut)*/\n\n          if (this.numberOfFrames > 1) {\n            cornerstoneTools.addStackStateManager(element, ['stack', 'playClip']);\n            cornerstoneTools.addToolState(element, 'stack', stack); //cornerstoneTools.setToolActive('StackScrollMouseWheel', { })\n\n            this.setState({\n              frame: 1\n            });\n          } // Load the possible measurements from DB and save in the store \n\n\n          db.measurement.where('sopinstanceuid').equals(this.sopInstanceUid).each(measure => {\n            console.log('load measure from db: ', measure); //this.props.measurementStore(measure)\n\n            this.measurementSave(measure);\n            cornerstoneTools.addToolState(element, measure.tool, measure.data);\n            this.runTool(measure.tool);\n            cornerstone.updateImage(element);\n            cornerstoneTools.setToolEnabled(measure.tool);\n          }).then(() => {\n            //console.log('this.measurements: ', this.measurements)\n            this.props.setActiveMeasurements(this.measurements);\n            this.props.setActiveDcm({\n              name: this.filename,\n              size: size,\n              image: this.image,\n              element: this.dicomImage,\n              isDicom: this.isDicom\n            });\n            this.props.setIsOpenStore({\n              index: this.props.index,\n              value: true\n            });\n          });\n        }, e => {\n          console.log('error', e);\n          this.hideOpenUrlDlg(); //console.log('toString: ', e.error.toString())\n\n          const error = e.error.toString();\n\n          if (error === '[object XMLHttpRequest]') {\n            this.setState({\n              errorOnCors: true\n            });\n          } else {\n            const pos = error.indexOf(\":\");\n            this.setState({\n              errorOnOpenImage: pos < 0 ? e.error : error.substring(pos + 1)\n            });\n          }\n        });\n      }\n    };\n\n    this.enableTool = (toolName, mouseButtonNumber) => {\n      // Enable all tools we want to use with this element\n      const WwwcTool = cornerstoneTools.WwwcTool;\n      const LengthTool = cornerstoneTools['LengthTool'];\n      const PanTool = cornerstoneTools.PanTool;\n      const ZoomTouchPinchTool = cornerstoneTools.ZoomTouchPinchTool;\n      const ZoomTool = cornerstoneTools.ZoomTool;\n      const ProbeTool = cornerstoneTools.ProbeTool;\n      const EllipticalRoiTool = cornerstoneTools.EllipticalRoiTool;\n      const RectangleRoiTool = cornerstoneTools.RectangleRoiTool;\n      const FreehandRoiTool = cornerstoneTools.FreehandRoiTool;\n      const AngleTool = cornerstoneTools.AngleTool;\n      const MagnifyTool = cornerstoneTools.MagnifyTool;\n      const StackScrollMouseWheelTool = cornerstoneTools.StackScrollMouseWheelTool;\n      cornerstoneTools.addTool(MagnifyTool);\n      cornerstoneTools.addTool(AngleTool);\n      cornerstoneTools.addTool(WwwcTool);\n      cornerstoneTools.addTool(LengthTool);\n      cornerstoneTools.addTool(PanTool);\n      cornerstoneTools.addTool(ZoomTouchPinchTool);\n      cornerstoneTools.addTool(ZoomTool);\n      cornerstoneTools.addTool(ProbeTool);\n      cornerstoneTools.addTool(EllipticalRoiTool);\n      cornerstoneTools.addTool(RectangleRoiTool);\n      cornerstoneTools.addTool(FreehandRoiTool);\n      cornerstoneTools.addTool(StackScrollMouseWheelTool);\n    };\n\n    this.disableAllTools = () => {\n      cornerstoneTools.setToolEnabled('Length');\n      cornerstoneTools.setToolEnabled('Pan');\n      cornerstoneTools.setToolEnabled('Magnify');\n      cornerstoneTools.setToolEnabled('Angle');\n      cornerstoneTools.setToolEnabled('RectangleRoi');\n      cornerstoneTools.setToolEnabled('Wwwc');\n      cornerstoneTools.setToolEnabled('ZoomTouchPinch');\n      cornerstoneTools.setToolEnabled('Probe');\n      cornerstoneTools.setToolEnabled('EllipticalRoi');\n      cornerstoneTools.setToolEnabled('FreehandRoi');\n      cornerstoneTools.setToolEnabled('StackScrollMouseWheel');\n    };\n\n    this.runTool = (toolName, opt) => {\n      //console.log('run tool: ', toolName)\n      // this.disableAllTools()\n      switch (toolName) {\n        case 'openimage':\n          {\n            //console.log('openimage: ', opt)\n            //console.log('openimage, this.dicomImage: ', this.dicomImage)\n            cornerstone.disable(this.dicomImage);\n            this.displayImageFromFiles(opt);\n            break;\n          }\n\n        case 'openLocalFs':\n          {\n            console.log('openLocalFs: ', opt);\n            cornerstone.disable(this.dicomImage);\n            this.loadImage(opt);\n            break;\n          }\n\n        case 'openSandboxFs':\n          {\n            //console.log('openSandboxFs: ', opt)\n            cornerstone.disable(this.dicomImage); //this.setState({ file: opt })\n\n            this.loadImage(undefined, undefined, opt);\n            break;\n          }\n\n        case 'openurl':\n          {\n            //console.log('run tool opt: ', opt)  \n            this.showOpenUrlDlg(opt);\n            break;\n          }\n\n        case 'clear':\n          {\n            this.setState({\n              visibleCinePlayer: false\n            });\n            this.mprPlane = ''; //this.props.clearingStore()\n\n            cornerstone.disable(this.dicomImage);\n            break;\n          }\n\n        case 'notool':\n          {\n            this.disableAllTools(); //const element = this.dicomImage\n            //cornerstoneTools.clearToolState(element, 'Length')\n            //const toolStateManager = cornerstoneTools.getElementToolStateManager(element)\n            //console.log('toolStateManager.toolState: ', toolStateManager.toolState)\n\n            /*\n            const toolState = toolStateManager.toolState\n            // const allTools = Object.keys(toolState).map(key => toolState[key])\n            let key = Object.keys(toolState)[0]\n            let allTools = toolState[key]\n            //console.log('allTools: ', allTools)\n             for (let [tool, data] of Object.entries(allTools)) {\n              //console.log(`${tool}: `, data)\n              let key = Object.keys(data)[0]\n              let tools = data[key]\n              //console.log('tools: ', tools)\n              tools.forEach(item => {\n                //console.log('tool: ', tool)\n                //console.log(item)\n                const measure = {\n                  tool: tool,\n                  note: '',\n                  data: item\n                }\n                console.log('measure: ', measure)\n                this.props.measurementStore(measure)\n              })\n            }\n            */\n            //const toolState = toolStateManager.get(element, 'Length')\n            //console.log('toolState: ', toolState)\n\n            /*\n            const measurementData = {\n              visible: true,\n              active: true,\n              invalidated: true,\n              handles: {\n                  start: {\n                      x: 100,\n                      y: 100,\n                      highlight: true,\n                      active: false\n                  },\n                  end: {\n                      x: 200,\n                      y: 200,\n                      highlight: true,\n                      active: true\n                  },\n                  textBox: {\n                      active: false,\n                      hasMoved: false,\n                      movesIndependently: false,\n                      drawnIndependently: true,\n                      allowedOutsideImage: true,\n                      hasBoundingBox: true\n                  }\n                }\n            }\n            cornerstoneTools.addToolState(element, 'RectangleRoi', measurementData)    \n            cornerstoneTools.setToolActive('RectangleRoi', { mouseButtonMask: 1 })\n            */\n            //cornerstone.updateImage(element)   \n\n            break;\n          }\n\n        case 'Wwwc':\n          {\n            cornerstoneTools.setToolActive('Wwwc', {\n              mouseButtonMask: 1\n            });\n            break;\n          }\n\n        case 'Pan':\n          {\n            cornerstoneTools.setToolActive('Pan', {\n              mouseButtonMask: 1\n            });\n            break;\n          }\n\n        case 'Zoom':\n          {\n            cornerstoneTools.setToolActive(isMobile ? 'ZoomTouchPinch' : 'Zoom', {\n              mouseButtonMask: 1\n            });\n            break;\n          }\n\n        case 'Length':\n          {\n            cornerstoneTools.setToolActive('Length', isMobile ? {\n              isTouchActive: true\n            } : {\n              mouseButtonMask: 1\n            });\n            break;\n          }\n\n        case 'Probe':\n          {\n            cornerstoneTools.setToolActive('Probe', {\n              mouseButtonMask: 1\n            });\n            break;\n          }\n\n        case 'EllipticalRoi':\n          {\n            cornerstoneTools.setToolActive('EllipticalRoi', {\n              mouseButtonMask: 1\n            });\n            break;\n          }\n\n        case 'RectangleRoi':\n          {\n            cornerstoneTools.setToolActive('RectangleRoi', {\n              mouseButtonMask: 1\n            });\n            break;\n          }\n\n        case 'Angle':\n          {\n            cornerstoneTools.setToolActive('Angle', {\n              mouseButtonMask: 1\n            });\n            break;\n          }\n\n        case 'Magnify':\n          {\n            cornerstoneTools.setToolActive('Magnify', {\n              mouseButtonMask: 1\n            });\n            break;\n          }\n\n        case 'FreehandRoi':\n          {\n            cornerstoneTools.setToolActive('FreehandRoi', {\n              mouseButtonMask: 1\n            });\n            break;\n          }\n\n        case 'Invert':\n          {\n            const element = this.dicomImage;\n            const viewport = cornerstone.getViewport(element);\n            viewport.invert = !viewport.invert;\n            cornerstone.setViewport(element, viewport);\n            break;\n          }\n\n        case 'saveas':\n          {\n            let type = localStorage.getItem(SETTINGS_SAVEAS);\n\n            if (getSettingsSaveInto() === 'local') {\n              // cornerstoneTools.SaveAs(this.dicomImage, `${this.filename}.${type}`, `image/${type}`)   \n              const element = this.dicomImage;\n              const viewport = cornerstone.getViewport(element);\n              const canvas = document.getElementsByClassName('cornerstone-canvas')[this.props.activeDcmIndex];\n              const zoom = viewport.scale.toFixed(2);\n              const cols = this.image.columns * zoom;\n              const rows = this.image.rows * zoom;\n              let myCanvas = document.createElement('canvas');\n              myCanvas = this.cropCanvas(canvas, Math.round(canvas.width / 2 - cols / 2), Math.round(canvas.height / 2 - rows / 2), cols, rows);\n              let a = document.createElement(\"a\");\n              a.href = myCanvas.toDataURL(`image/${type}`);\n              a.download = `${this.filename}.${type}`;\n              document.body.appendChild(a); // Required for this to work in FireFox\n\n              a.click();\n            } else {\n              // store image into sandbox file system\n              const element = this.dicomImage;\n              const viewport = cornerstone.getViewport(element);\n              const canvas = document.getElementsByClassName('cornerstone-canvas')[this.props.activeDcmIndex];\n              const zoom = viewport.scale.toFixed(2);\n              const cols = this.image.columns * zoom;\n              const rows = this.image.rows * zoom;\n              let myCanvas = document.createElement('canvas');\n              myCanvas = this.cropCanvas(canvas, Math.round(canvas.width / 2 - cols / 2), Math.round(canvas.height / 2 - rows / 2), cols, rows);\n              blobUtil.canvasToBlob(myCanvas, `image/${type}`).then(blob => {\n                blobUtil.blobToArrayBuffer(blob).then(arrayBuffer => {\n                  const name = `${getFileName(this.filename)}-MPR-${this.mprPlane}`;\n                  let newName = name;\n                  let counter = 1;\n                  let done = false;\n\n                  do {\n                    let filename = `${newName}.${type}`;\n                    const checkName = this.props.fsCurrentList.find(e => e.name === filename);\n\n                    if (checkName === undefined) {\n                      fs.transaction('rw', fs.files, async () => {\n                        await fs.files.add({\n                          parent: this.props.fsCurrentDir,\n                          name: filename,\n                          type: type,\n                          size: arrayBuffer.byteLength,\n                          data: arrayBuffer\n                        });\n                      }).then(() => {\n                        this.props.makeFsRefresh();\n                      });\n                      done = true;\n                    } else {\n                      newName = `${name} - ${counter}`;\n                      counter++;\n                    }\n                  } while (!done);\n                });\n              });\n            }\n\n            break;\n          }\n\n        case 'cine':\n          {\n            this.setState({\n              visibleCinePlayer: !this.state.visibleCinePlayer\n            });\n            break;\n          }\n\n        case 'reset':\n          {\n            this.reset();\n            break;\n          }\n\n        case 'removetool':\n          {\n            console.log('removetool index: ', opt);\n            const element = this.dicomImage;\n            cornerstoneTools.removeToolState(element, this.measurements[opt].tool, this.measurements[opt].data);\n            cornerstone.updateImage(element); //this.props.measurementRemoveStore(opt)\n\n            this.measurementRemove(opt);\n            this.props.setActiveMeasurements(this.measurements);\n            break;\n          }\n\n        case 'removetools':\n          {\n            const element = this.dicomImage; // for each measurement remove it \n\n            this.measurements.forEach(measure => {\n              cornerstoneTools.clearToolState(element, measure.tool);\n            });\n            cornerstone.updateImage(element);\n            this.measurementClear(); // also remove all measurements from db\n\n            db.measurement.where('sopinstanceuid').equals(this.sopInstanceUid).delete();\n            this.props.setActiveMeasurements(this.measurements);\n            break;\n          }\n\n        case 'savetools':\n          {\n            // first, remove eventually previous measurements from db\n            db.measurement.where('sopinstanceuid').equals(this.sopInstanceUid).delete(); // then save all the current measurements\n\n            this.measurements.forEach(measure => {\n              try {\n                db.measurement.add({\n                  sopinstanceuid: this.sopInstanceUid,\n                  tool: measure.tool,\n                  note: measure.note,\n                  data: measure.data\n                });\n              } catch (error) {\n                console.error(error);\n              }\n            });\n            break;\n          }\n\n        default:\n          {\n            break;\n          }\n      }\n    };\n\n    this.cropCanvas = (canvas, x, y, width, height) => {\n      console.log(`canvas: ${canvas.width}, ${canvas.height}`);\n      console.log(`x, y: ${x}, ${y}`);\n      console.log(`width, height: ${width}, ${height}`); // create a temp canvas\n\n      const newCanvas = document.createElement('canvas'); // set its dimensions\n\n      newCanvas.width = width;\n      newCanvas.height = height; // draw the canvas in the new resized temp canvas \n\n      newCanvas.getContext('2d').drawImage(canvas, x, y, width, height, 0, 0, width, height);\n      return newCanvas;\n    };\n\n    this.changeTool = (toolName, value) => {\n      console.log('change tool, value: ', toolName, value);\n\n      switch (toolName) {\n        case 'Wwwc':\n          if (value === 1) {\n            cornerstoneTools.setToolActive('Wwwc', {\n              mouseButtonMask: 1\n            });\n          } else if (value === 0) {\n            cornerstoneTools.setToolPassive('Wwwc');\n          }\n\n          break;\n\n        case 'Pan':\n          if (value === 1) {\n            cornerstoneTools.setToolActive('Pan', {\n              mouseButtonMask: 1\n            });\n          } else if (value === 0) {\n            cornerstoneTools.setToolPassive('Pan');\n          }\n\n          break;\n\n        case 'Zoom':\n          if (value === 1) {\n            cornerstoneTools.setToolActive(isMobile ? 'ZoomTouchPinch' : 'Zoom', {\n              mouseButtonMask: 1\n            });\n          } else if (value === 0) {\n            cornerstoneTools.setToolPassive(isMobile ? 'ZoomTouchPinch' : 'Zoom');\n          }\n\n          break;\n\n        case 'Length':\n          if (value === 1) {\n            cornerstoneTools.setToolActive('Length', isMobile ? {\n              isTouchActive: true\n            } : {\n              mouseButtonMask: 1\n            });\n          } else if (value === 0) {\n            cornerstoneTools.setToolPassive('Length');\n          }\n\n          break;\n\n        case 'Probe':\n          if (value === 1) {\n            cornerstoneTools.setToolActive('Probe', {\n              mouseButtonMask: 1\n            });\n          } else if (value === 0) {\n            cornerstoneTools.setToolPassive('Probe');\n          }\n\n          break;\n\n        case 'Angle':\n          if (value === 1) {\n            cornerstoneTools.setToolActive('Angle', {\n              mouseButtonMask: 1\n            });\n          } else if (value === 0) {\n            cornerstoneTools.setToolPassive('Angle');\n          }\n\n          break;\n\n        case 'Magnify':\n          if (value === 1) {\n            cornerstoneTools.setToolActive('Magnify', {\n              mouseButtonMask: 1\n            });\n          } else if (value === 0) {\n            cornerstoneTools.setToolPassive('Magnify');\n          }\n\n          break;\n\n        case 'EllipticalRoi':\n          if (value === 1) {\n            cornerstoneTools.setToolActive('EllipticalRoi', {\n              mouseButtonMask: 1\n            });\n          } else if (value === 0) {\n            cornerstoneTools.setToolPassive('EllipticalRoi');\n          }\n\n          break;\n\n        case 'RectangleRoi':\n          if (value === 1) {\n            cornerstoneTools.setToolActive('RectangleRoi', {\n              mouseButtonMask: 1\n            });\n          } else if (value === 0) {\n            cornerstoneTools.setToolPassive('RectangleRoi');\n          }\n\n          break;\n\n        case 'FreehandRoi':\n          if (value === 1) {\n            cornerstoneTools.setToolActive('FreehandRoi', {\n              mouseButtonMask: 1\n            });\n          } else if (value === 0) {\n            cornerstoneTools.setToolPassive('FreehandRoi');\n          }\n\n          break;\n\n        default:\n          break;\n      }\n    };\n\n    this.runCinePlayer = cmdName => {\n      //console.log('this.state.frame: ', this.state.frame)\n      const element = this.dicomImage;\n\n      switch (cmdName) {\n        case 'firstframe':\n          {\n            let frame = 1;\n            this.setState({\n              frame: frame\n            });\n            scrollToIndex(element, 0);\n            break;\n          }\n\n        case 'previousframe':\n          {\n            if (this.state.frame > 1) {\n              let frame = this.state.frame - 1;\n              this.setState({\n                frame: frame\n              });\n              scrollToIndex(element, frame - 1);\n            }\n\n            break;\n          }\n\n        case 'play':\n          {\n            cornerstoneTools.playClip(element, 30);\n            this.setState({\n              inPlay: true\n            });\n            break;\n          }\n\n        case 'pause':\n          {\n            cornerstoneTools.stopClip(element);\n            this.setState({\n              inPlay: false\n            });\n            break;\n          }\n\n        case 'nextframe':\n          {\n            if (this.state.frame < this.numberOfFrames) {\n              let frame = this.state.frame + 1;\n              this.setState({\n                frame: frame\n              });\n              scrollToIndex(element, frame - 1);\n            }\n\n            break;\n          }\n\n        case 'lastframe':\n          {\n            let frame = this.numberOfFrames;\n            this.setState({\n              frame: frame\n            });\n            scrollToIndex(element, frame - 1);\n            break;\n          }\n\n        default:\n          break;\n      }\n    };\n\n    this.reset = () => {\n      const element = this.dicomImage;\n      const defaultViewport = cornerstone.getDefaultViewportForImage(element, this.image);\n      let viewport = cornerstone.getViewport(element);\n      viewport.voi.windowWidth = defaultViewport.voi.windowWidth;\n      viewport.voi.windowCenter = defaultViewport.voi.windowCenter;\n      viewport.invert = false;\n      cornerstone.setViewport(element, viewport);\n    };\n\n    this.mprPlanePosition = () => {\n      //console.log(\"mprPlanePosition: \")\n      try {\n        if (!this.isDicom) return this.mprPlane; // console.log(\"image data:\" + this.image.data);\n\n        const imageOrientation = this.image.data.string('x00200037').split('\\\\');\n        let v = new Array(6).fill(0);\n        v[0] = parseFloat(imageOrientation[0]); // the x direction cosines of the first row X\n\n        v[1] = parseFloat(imageOrientation[1]); // the y direction cosines of the first row X\n\n        v[2] = parseFloat(imageOrientation[2]); // the z direction cosines of the first row X\n\n        v[3] = parseFloat(imageOrientation[3]); // the x direction cosines of the first column Y\n\n        v[4] = parseFloat(imageOrientation[4]); // the y direction cosines of the first column Y\n\n        v[5] = parseFloat(imageOrientation[5]); // the z direction cosines of the first column Y\n\n        v = v.map(x => Math.round(x));\n        let p = [v[1] * v[5] - v[2] * v[4], v[2] * v[3] - v[0] * v[5], v[0] * v[4] - v[1] * v[3]]; // cross product of X x Y\n\n        p = p.map(x => Math.abs(x));\n\n        if (p[0] === 1) {\n          this.mprPlane = 'sagittal';\n        } else if (p[1] === 1) {\n          this.mprPlane = 'coronal';\n        } else if (p[2] === 1) {\n          this.mprPlane = 'axial';\n        }\n      } catch (error) {\n        // it's not possible to build MPR\n        this.mprPlane = '';\n      }\n\n      return this.mprPlane;\n    };\n\n    this.transpose = matrix => {\n      return Object.keys(matrix[0]).map(colNumber => matrix.map(rowNumber => rowNumber[colNumber]));\n    };\n\n    this.mprRenderYZPlane = (filename, origin, x, mprData) => {\n      if (this.volume === null) return;\n      this.filename = filename;\n      cornerstone.disable(this.dicomImage); //console.log(`mprRenderYZPlane, origin: ${origin}, x: ${x}`)\n      //console.log('mprRenderYZPlane, volume: ', this.volume)\n\n      if (origin === 'sagittal') this.mprPlane = 'coronal';else if (origin === 'axial') this.mprPlane = 'sagittal';else this.mprPlane = 'sagittal';\n      this.xSize = this.props.files[0].columns;\n      this.ySize = this.props.files[0].rows;\n      this.zSize = mprData.zDim;\n      const i = Math.round(x / this.xSize * this.props.files.length);\n      this.originImage = this.props.files[i].image;\n\n      if (origin === 'sagittal') {\n        let xoffset = Math.floor(this.xSize / 2) - Math.floor(this.zSize / 2);\n        let plane = new Int16Array(this.xSize * this.ySize);\n\n        for (let y = 0; y < this.ySize; y++) for (let z = 0; z < this.zSize; z++) plane[z + this.ySize * y + xoffset] = this.volume[z][x + this.ySize * y];\n\n        this.loadImageFromCustomObject(this.xSize, this.ySize, plane);\n      } else if (origin === 'coronal') {\n        let xoffset = Math.floor(this.xSize / 2) - Math.floor(this.zSize / 2);\n        let plane = new Int16Array(this.xSize * this.ySize);\n\n        for (let y = 0; y < this.ySize; y++) for (let z = 0; z < this.zSize; z++) plane[z + this.ySize * y + xoffset] = this.volume[z][x + this.ySize * y];\n\n        this.loadImageFromCustomObject(this.xSize, this.ySize, plane);\n      } else {\n        // axial\n        const yzPlane = this.mprBuildYZPlane(x);\n        this.loadImageFromCustomObject(this.ySize, this.zSize, yzPlane);\n      }\n    };\n\n    this.mprBuildYZPlane = x => {\n      //console.log(`mprBuildYZPlane, ySize: ${this.ySize}, zSize: ${this.zSize} `)\n      let plane = new Int16Array(this.ySize * this.zSize);\n\n      for (var y = 0; y < this.ySize; y++) for (var z = 0; z < this.zSize; z++) plane[y + this.ySize * z] = this.volume[z][x + this.ySize * y]; //console.log('mprBuildYZPlane, plane: ', plane)\n\n\n      return plane;\n    };\n\n    this.mprRenderXZPlane = (filename, origin, y, mprData) => {\n      if (this.volume === null) return;\n      this.filename = filename;\n      cornerstone.disable(this.dicomImage); //console.log(`mprRenderXZPlane, origin: ${origin}, y: ${y}`)\n      //console.log('mprRenderXZPlane, volume: ', this.volume)\n\n      if (origin === 'sagittal') this.mprPlane = 'axial';else if (origin === 'axial') this.mprPlane = 'coronal';else this.mprPlane = 'axial';\n      this.xSize = this.props.files[0].columns;\n      this.ySize = this.props.files[0].rows;\n      this.zSize = mprData.zDim;\n      const i = Math.trunc(y / this.ySize * this.props.files.length);\n      this.originImage = this.props.files[i].image;\n\n      if (origin === 'sagittal') {\n        let xoffset = Math.floor(this.xSize / 2) - Math.floor(this.zSize / 2);\n        let plane = new Int16Array(this.xSize * this.ySize);\n\n        for (let x = 0; x < this.xSize; x++) for (let z = 0; z < this.zSize; z++) plane[z + this.xSize * x + xoffset] = this.volume[z][x + this.xSize * y];\n\n        this.loadImageFromCustomObject(this.xSize, this.ySize, plane);\n      } else {\n        const xzPlane = this.mprBuildXZPlane(y);\n        this.loadImageFromCustomObject(this.xSize, this.zSize, xzPlane);\n      }\n    };\n\n    this.mprBuildXZPlane = y => {\n      //console.log(`mprBuildXZPlane, xSize: ${this.xSize}, zSize: ${this.zSize} `)\n      let plane = new Int16Array(this.xSize * this.zSize);\n\n      for (let x = 0; x < this.xSize; x++) for (let z = 0; z < this.zSize; z++) plane[x + this.xSize * z] = this.volume[z][x + this.xSize * y]; //console.log('mprBuildXZPlane, plane: ', plane)    \n\n\n      return plane;\n    };\n\n    this.mprIsOrthogonalView = () => {\n      //console.log('mprIsOrthogonalView: ', this.mprPlane)\n      return this.mprPlane !== '' && this.props.layout[0] === 1 && this.props.layout[1] === 3;\n    };\n\n    this.dicomImageRef = el => {\n      this.dicomImage = el;\n    };\n\n    this.onImageClick = () => {\n      console.log('onImageClick: ');\n    };\n\n    this.filename = '';\n    this.localfile = null;\n    this.localurl = null;\n    this.fsItem = null;\n    this.dicomImage = null;\n    this.imageId = null;\n    this.image = null;\n    this.isDicom = false;\n    this.numberOfFrames = 1;\n    this.measurements = [];\n    this.xSize = 0;\n    this.ySize = 0;\n    this.zSize = 0;\n    this.volume = null;\n    this.originImage = null;\n    this.mprPlane = '';\n  }\n\n  componentDidMount() {\n    this.props.runTool(this);\n    this.props.changeTool(this);\n    cornerstone.events.addEventListener('cornerstoneimageloaded', this.onImageLoaded);\n    const dcmRef = this.props.dcmRef;\n    dcmRef(this);\n  }\n\n  componentWillUnmount() {\n    this.props.runTool(undefined);\n    this.props.changeTool(undefined);\n    const dcmRef = this.props.dcmRef;\n    dcmRef(undefined);\n  }\n\n  componentDidUpdate(previousProps) {\n    //console.log('dicomviewer - componentDidUpdate: ')\n\n    /*if (this.props.files !== null) {\n      console.log('this.props.files[0]: ', this.props.files[0])\n      console.log('this.props.files: ', this.props.files)\n    }*/\n\n    /*if (this.props.volume !== null) {\n      console.log('volume set: ', this.props.volume)\n      this.volume = this.props.volume\n    }*/\n    const isOpen = this.props.isOpen[this.props.index];\n\n    if (this.props.layout !== previousProps.layout && isOpen) {\n      cornerstone.resize(this.dicomImage);\n    }\n  }\n\n  render() {\n    //console.log('DicomViewer render: ')\n    //this.props.visible ? document.body.style = 'background: #000000;' : document.body.style = 'background: $md-grey-700;'\n    const isOpen = this.props.isOpen[this.props.index]; //const visibleHistogram = this.state.visibleHistogram\n\n    const visibleOpenUrlDlg = this.state.visibleOpenUrlDlg;\n    const errorOnOpenImage = this.state.errorOnOpenImage;\n    const progress = this.state.progress;\n    const styleContainer = {\n      width: '100%',\n      height: '100%',\n      border: this.props.activeDcmIndex === this.props.index && (this.props.layout[0] > 1 || this.props.layout[1] > 1) ? 'solid 1px #AAAAAA' : null,\n      position: 'relative'\n    };\n    const styleDicomImage = {\n      width: '100%',\n      height: '100%',\n      position: 'relative'\n    };\n    const overlay = getSettingsOverlay();\n    return React.createElement(\"div\", {\n      className: \"container\",\n      style: styleContainer,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 1352\n      },\n      __self: this\n    }, visibleOpenUrlDlg ? React.createElement(OpenUrlDlg, {\n      progress: progress,\n      onClose: this.hideOpenUrlDlg,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 1354\n      },\n      __self: this\n    }) : null, React.createElement(Dialog, {\n      open: errorOnOpenImage !== null,\n      onClose: this.onErrorOpenImageClose,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 1356\n      },\n      __self: this\n    }, React.createElement(DialogTitle, {\n      id: \"alert-dialog-title\",\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 1360\n      },\n      __self: this\n    }, \"Error on opening image\"), React.createElement(DialogContent, {\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 1361\n      },\n      __self: this\n    }, React.createElement(DialogContentText, {\n      id: \"alert-dialog-description\",\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 1362\n      },\n      __self: this\n    }, this.state.errorOnOpenImage)), React.createElement(DialogActions, {\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 1366\n      },\n      __self: this\n    }, React.createElement(Button, {\n      onClick: this.onErrorOpenImageClose,\n      autoFocus: true,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 1367\n      },\n      __self: this\n    }, \"Ok\"))), React.createElement(Dialog, {\n      open: this.state.errorOnCors,\n      onClose: this.onErrorCorsClose,\n      \"aria-labelledby\": \"alert-dialog-title\",\n      \"aria-describedby\": \"alert-dialog-description\",\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 1373\n      },\n      __self: this\n    }, React.createElement(DialogTitle, {\n      id: \"alert-dialog-title\",\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 1379\n      },\n      __self: this\n    }, \"Error on loading image\"), React.createElement(DialogContent, {\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 1380\n      },\n      __self: this\n    }, React.createElement(DialogContentText, {\n      id: \"alert-dialog-description\",\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 1381\n      },\n      __self: this\n    }, React.createElement(Typography, {\n      gutterBottom: true,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 1382\n      },\n      __self: this\n    }, \"CORS or Cross Origin Resource Sharing is a browser security policy that prevents javascript from loading data from a server with a different base URL than the server that served up the javascript file.\"), React.createElement(Typography, {\n      gutterBottom: true,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 1387\n      },\n      __self: this\n    }, \"See the \\xA0\", React.createElement(Link, {\n      href: \"http://enable-cors.org/\",\n      target: \"_blank\",\n      color: \"textPrimary\",\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 1389\n      },\n      __self: this\n    }, \"Enable CORS site\"), \"\\xA0 for information about CORS.\"))), React.createElement(DialogActions, {\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 1396\n      },\n      __self: this\n    }, React.createElement(Button, {\n      onClick: this.onErrorCorsClose,\n      autoFocus: true,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 1397\n      },\n      __self: this\n    }, \"Ok\"))), React.createElement(\"div\", {\n      style: {\n        width: '100%',\n        height: '100%',\n        position: \"relative\",\n        color: '#FFFFFF',\n        textShadow: '1px 1px #000000'\n      },\n      onContextMenu: () => false,\n      className: \"cornerstone-enabled-image\",\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 1403\n      },\n      __self: this\n    }, React.createElement(\"div\", {\n      ref: this.dicomImageRef,\n      style: styleDicomImage,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 1414\n      },\n      __self: this\n    }), React.createElement(\"div\", {\n      id: `mrtopleft-${this.props.index}`,\n      style: {\n        position: \"absolute\",\n        top: 0,\n        left: 3,\n        display: isOpen && overlay ? \"\" : \"none\"\n      },\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 1419\n      },\n      __self: this\n    }), React.createElement(\"div\", {\n      id: `mrtopright-${this.props.index}`,\n      style: {\n        position: \"absolute\",\n        top: 0,\n        right: 3,\n        display: isOpen && overlay ? \"\" : \"none\"\n      },\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 1425\n      },\n      __self: this\n    }), React.createElement(\"div\", {\n      id: `mrbottomright-${this.props.index}`,\n      style: {\n        position: \"absolute\",\n        bottom: 0,\n        right: 3,\n        display: isOpen && overlay ? \"\" : \"none\"\n      },\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 1431\n      },\n      __self: this\n    }), React.createElement(\"div\", {\n      id: `mrbottomleft-${this.props.index}`,\n      style: {\n        position: \"absolute\",\n        bottom: 0,\n        left: 3,\n        display: isOpen && overlay ? \"\" : \"none\"\n      },\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 1437\n      },\n      __self: this\n    }), React.createElement(\"div\", {\n      id: `mrtopcenter-${this.props.index}`,\n      style: {\n        position: \"absolute\",\n        top: 0,\n        width: '60px',\n        left: '50%',\n        marginLeft: '0px',\n        display: isOpen && overlay ? \"\" : \"none\"\n      },\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 1444\n      },\n      __self: this\n    }), React.createElement(\"div\", {\n      id: `mrleftcenter-${this.props.index}`,\n      style: {\n        position: \"absolute\",\n        top: '50%',\n        width: '30px',\n        left: 3,\n        marginLeft: '0px',\n        display: isOpen && overlay ? \"\" : \"none\"\n      },\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 1451\n      },\n      __self: this\n    }), React.createElement(\"div\", {\n      id: `mrrightcenter-${this.props.index}`,\n      style: {\n        position: \"absolute\",\n        top: '50%',\n        width: '30px',\n        right: 3,\n        marginRight: '-20px',\n        display: isOpen && overlay ? \"\" : \"none\"\n      },\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 1458\n      },\n      __self: this\n    }), React.createElement(\"div\", {\n      id: `mrbottomcenter-${this.props.index}`,\n      style: {\n        position: \"absolute\",\n        bottom: 0,\n        width: '60px',\n        left: '50%',\n        marginLeft: '0px',\n        display: isOpen && overlay ? \"\" : \"none\"\n      },\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 1465\n      },\n      __self: this\n    }), this.state.visibleCinePlayer && this.numberOfFrames > 1 ? React.createElement(\"div\", {\n      style: {\n        position: \"absolute\",\n        width: '100%',\n        bottom: 0,\n        textAlign: 'center'\n      },\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 1473\n      },\n      __self: this\n    }, React.createElement(\"div\", {\n      style: {\n        margin: '0 auto',\n        width: '240px',\n        backgroundColor: 'rgba(136, 136, 136, 0.5)'\n      },\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 1474\n      },\n      __self: this\n    }, React.createElement(CinePlayer, {\n      runCinePlayer: this.runCinePlayer,\n      inPlay: this.state.inPlay,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 1475\n      },\n      __self: this\n    }), React.createElement(\"div\", {\n      id: `frameLabel-${this.props.index}`,\n      style: {\n        width: 230,\n        margin: '0 auto',\n        marginTop: -10,\n        textAlign: \"center\"\n      },\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 1476\n      },\n      __self: this\n    }, this.state.frame, \" / \", this.numberOfFrames))) : null));\n  }\n\n}\n\nconst mapStateToProps = state => {\n  return {\n    files: state.files,\n    url: state.url,\n    isOpen: state.isOpen,\n    tool: state.tool,\n    activeDcmIndex: state.activeDcmIndex,\n    activeDcm: state.activeDcm,\n    measurements: state.measurements,\n    layout: state.layout,\n    fsCurrentDir: state.fsCurrentDir,\n    fsCurrentList: state.fsCurrentList,\n    volume: state.volume,\n    lut: state.lut //sandboxedFile: state.sandboxedFile,\n\n  };\n};\n\nconst mapDispatchToProps = dispatch => {\n  return {\n    clearingStore: () => dispatch(clearStore()),\n    setIsOpenStore: value => dispatch(dcmIsOpen(value)),\n    toolStore: tool => dispatch(dcmTool(tool)),\n    setActiveDcm: dcm => dispatch(activeDcm(dcm)),\n    setActiveMeasurements: measurements => dispatch(activeMeasurements(measurements)),\n    makeFsRefresh: dcm => dispatch(doFsRefresh()) //setLutStore: (lut) => dispatch(setLut(lut)),\n\n  };\n};\n\nexport default connect(mapStateToProps, mapDispatchToProps)(DicomViewer);","map":{"version":3,"sources":["/media/mohammad/work/websites/cornerstone/dicom-viewer/src/components/DicomViewer.js"],"names":["React","connect","Button","Dialog","DialogActions","DialogContent","DialogContentText","DialogTitle","Link","Typography","Hammer","cornerstone","cornerstoneTools","cornerstoneMath","cornerstoneFileImageLoader","cornerstoneWebImageLoader","cornerstoneWADOImageLoader","dicomParser","blobUtil","uids","SETTINGS_SAVEAS","OpenUrlDlg","CinePlayer","isMobile","import","csTools","db","fs","clearStore","dcmIsOpen","activeDcm","dcmTool","activeMeasurements","doFsRefresh","capitalize","getFileName","getSettingsOverlay","isFileImage","isFsFileImage","isUrlImage","getSettingsSaveInto","scrollToIndex","external","init","DicomViewer","Component","constructor","props","state","visibleOpenUrlDlg","progress","visibleCinePlayer","errorOnOpenImage","errorOnCors","frame","inPlay","viewport","onOpenUrl","e","eventData","detail","setState","percentComplete","showOpenUrlDlg","url","events","addEventListener","loadImage","undefined","hideOpenUrlDlg","measurementSave","measure","measurements","push","measurementClear","splice","length","measurementRemove","index","getTransferSyntax","value","image","data","string","getSopClass","getSopInstanceUID","getPixelRepresentation","uint16","getPlanarConfiguration","onImageLoaded","onImageRendered","getViewport","target","document","getElementById","textContent","mprIsOrthogonalView","mprPlane","PatientsName","displayedArea","brhc","x","y","Math","round","voi","windowWidth","windowCenter","scale","toFixed","isDicom","numberOfFrames","onMeasurementModified","onMeasurementAdded","tool","note","measurementData","setActiveMeasurements","onMeasurementCompleted","setTimeout","onErrorOpenImageClose","onErrorCorsClose","displayImageFromFiles","files","imageId","filename","name","element","dicomImage","onNewImage","enable","sopInstanceUid","stack","currentImageIdIndex","imageIds","intString","i","displayImage","mprPlanePosition","enableTool","addStackStateManager","addToolState","measurement","where","equals","each","console","log","runTool","updateImage","setToolEnabled","then","setActiveDcm","setIsOpenStore","loadImageFromCanvas","canvas","fileManager","addCanvas","loadImageFromCustomObject","columns","rows","pixelData","customObj","originImage","addCustom","localfile","fsItem","localurl","size","isOpenStore","addBuffer","add","wadouri","loadAndCacheImage","error","toString","pos","indexOf","substring","toolName","mouseButtonNumber","WwwcTool","LengthTool","PanTool","ZoomTouchPinchTool","ZoomTool","ProbeTool","EllipticalRoiTool","RectangleRoiTool","FreehandRoiTool","AngleTool","MagnifyTool","StackScrollMouseWheelTool","addTool","disableAllTools","opt","disable","setToolActive","mouseButtonMask","isTouchActive","invert","setViewport","type","localStorage","getItem","getElementsByClassName","activeDcmIndex","zoom","cols","myCanvas","createElement","cropCanvas","width","height","a","href","toDataURL","download","body","appendChild","click","canvasToBlob","blob","blobToArrayBuffer","arrayBuffer","newName","counter","done","checkName","fsCurrentList","find","transaction","parent","fsCurrentDir","byteLength","makeFsRefresh","reset","removeToolState","forEach","clearToolState","delete","sopinstanceuid","newCanvas","getContext","drawImage","changeTool","setToolPassive","runCinePlayer","cmdName","playClip","stopClip","defaultViewport","getDefaultViewportForImage","imageOrientation","split","v","Array","fill","parseFloat","map","p","abs","transpose","matrix","Object","keys","colNumber","rowNumber","mprRenderYZPlane","origin","mprData","volume","xSize","ySize","zSize","zDim","xoffset","floor","plane","Int16Array","z","yzPlane","mprBuildYZPlane","mprRenderXZPlane","trunc","xzPlane","mprBuildXZPlane","layout","dicomImageRef","el","onImageClick","componentDidMount","dcmRef","componentWillUnmount","componentDidUpdate","previousProps","isOpen","resize","render","styleContainer","border","position","styleDicomImage","overlay","color","textShadow","top","left","display","right","bottom","marginLeft","marginRight","textAlign","margin","backgroundColor","marginTop","mapStateToProps","lut","mapDispatchToProps","dispatch","clearingStore","toolStore","dcm"],"mappings":"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","sourcesContent":["import React from \"react\"\nimport {connect} from 'react-redux'\nimport Button from '@material-ui/core/Button'\nimport Dialog from '@material-ui/core/Dialog'\nimport DialogActions from '@material-ui/core/DialogActions'\nimport DialogContent from '@material-ui/core/DialogContent'\nimport DialogContentText from '@material-ui/core/DialogContentText'\nimport DialogTitle from '@material-ui/core/DialogTitle'\nimport Link from '@material-ui/core/Link'\nimport Typography from '@material-ui/core/Typography'\nimport Hammer from \"hammerjs\"\nimport * as cornerstone from \"cornerstone-core\"\nimport * as cornerstoneTools from \"cornerstone-tools\"\nimport * as cornerstoneMath from \"cornerstone-math\"\nimport * as cornerstoneFileImageLoader from \"cornerstone-file-image-loader\"\nimport * as cornerstoneWebImageLoader from \"cornerstone-web-image-loader\"\nimport * as cornerstoneWADOImageLoader from \"cornerstone-wado-image-loader\"\nimport * as dicomParser from 'dicom-parser'\nimport * as blobUtil from 'blob-util'\nimport {uids} from '../constants/uids'\nimport { SETTINGS_SAVEAS } from '../constants/settings'\nimport OpenUrlDlg from './OpenUrlDlg'\nimport CinePlayer from './CinePlayer'\nimport { isMobile } from 'react-device-detect'\nimport { import as csTools } from 'cornerstone-tools'\nimport db from '../db/db'\nimport fs from '../fs/fs'\nimport {\n  clearStore, \n  dcmIsOpen, \n  activeDcm, \n  dcmTool, \n  activeMeasurements,\n  doFsRefresh} \nfrom '../actions'\nimport {\n  capitalize,\n  getFileName,\n  getSettingsOverlay,\n  isFileImage,\n  isFsFileImage,\n  isUrlImage,\n  getSettingsSaveInto\n} from '../functions'\n\nconst scrollToIndex = csTools('util/scrollToIndex');\n\n/*\nfunction getBlobUrl(url) {\n  const baseUrl = window.URL || window.webkitURL;\n  const blob = new Blob([`importScripts('${url}')`], {type: \"application/javascript\"});\n  return baseUrl.createObjectURL(blob);\n}\n\nlet webWorkerUrl = getBlobUrl(\n  \"https://unpkg.com/cornerstone-wado-image-loader@3.0.0/dist/cornerstoneWADOImageLoaderWebWorker.min.js\"\n)\nlet codecsUrl = getBlobUrl(\n  \"https://unpkg.com/cornerstone-wado-image-loader@3.0.0/dist/cornerstoneWADOImageLoaderCodecs.js\"\n  // \"https://unpkg.com/cornerstone-wado-image-loader/dist/cornerstoneWADOImageLoaderCodecs.js\"\n)\n// See componentDidMount line 110 for initialization, registration\n\nconst config = {\n  maxWebWorkers: 4, //\n  //startWebWorkersOnDemand: true, //\n  webWorkerPath: webWorkerUrl,\n  //webWorkerTaskPaths: [], //\n  taskConfiguration: {\n    decodeTask: {\n      //loadCodecsOnStartup: true, //\n      //initializeCodecsOnStartup: false, //\n      codecsPath: codecsUrl,\n      //usePDFJS: false, //\n      //strict: true //\n    }\n  }\n}\nvar config = {\n  maxWebWorkers: navigator.hardwareConcurrency || 1,\n  startWebWorkersOnDemand: false,\n}\n*/\ncornerstoneTools.external.cornerstone = cornerstone;\ncornerstoneTools.external.cornerstoneMath = cornerstoneMath;\ncornerstoneFileImageLoader.external.cornerstone = cornerstone;\ncornerstoneWebImageLoader.external.cornerstone = cornerstone;\ncornerstoneWADOImageLoader.external.cornerstone = cornerstone;\n//cornerstoneWADOImageLoader.webWorkerManager.initialize(config)\ncornerstoneWADOImageLoader.external.dicomParser = dicomParser;\ncornerstoneTools.external.Hammer = Hammer;\ncornerstoneTools.init();\n\n//console.log({ cornerstone })\n//console.log({ cornerstoneWADOImageLoader })\n//console.log({ dicomParser })\n\nclass DicomViewer extends React.Component {\n    constructor(props) {\n      super(props);\n      this.filename = '';\n      this.localfile = null;\n      this.localurl = null;\n      this.fsItem = null;\n      this.dicomImage = null;\n      this.imageId = null;\n      this.image = null;\n      this.isDicom = false;\n      this.numberOfFrames = 1;\n      this.measurements = [];\n      this.xSize = 0;\n      this.ySize = 0;\n      this.zSize = 0;\n      this.volume = null;\n      this.originImage = null;\n      this.mprPlane = ''\n    }\n\n    state = {\n      visibleOpenUrlDlg: false,\n      progress: null,\n      visibleCinePlayer: false,\n      errorOnOpenImage: null,\n      errorOnCors: false,\n      frame: 1,\n      inPlay: false,\n      viewport: null,\n    };\n\n    componentDidMount() {\n      this.props.runTool(this);\n      this.props.changeTool(this);\n      cornerstone.events.addEventListener('cornerstoneimageloaded', this.onImageLoaded);\n      const { dcmRef } = this.props;\n      dcmRef(this)          \n      \n    }\n\n    componentWillUnmount() {\n      this.props.runTool(undefined);\n      this.props.changeTool(undefined);\n      const { dcmRef } = this.props;\n      dcmRef(undefined)            \n    }\n\n    componentDidUpdate(previousProps) {\n      //console.log('dicomviewer - componentDidUpdate: ')\n      /*if (this.props.files !== null) {\n        console.log('this.props.files[0]: ', this.props.files[0])\n        console.log('this.props.files: ', this.props.files)\n      }*/\n      /*if (this.props.volume !== null) {\n        console.log('volume set: ', this.props.volume)\n        this.volume = this.props.volume\n      }*/\n      const isOpen = this.props.isOpen[this.props.index];\n      if (this.props.layout !== previousProps.layout && isOpen) {\n        cornerstone.resize(this.dicomImage)\n      }\n    }\n  \n    onOpenUrl = (e) => {\n      const eventData = e.detail;\n      this.setState({ progress: eventData.percentComplete })\n    };\n\n    showOpenUrlDlg = (url) => {\n      this.setState({ visibleOpenUrlDlg: true }, () => {\n        cornerstone.events.addEventListener('cornerstoneimageloadprogress', this.onOpenUrl);\n        this.loadImage(undefined, url)\n      })\n    };\n  \n    hideOpenUrlDlg = () => {\n      this.setState({ visibleOpenUrlDlg: false, progress: null })\n    };\n\n    measurementSave = (measure) => {\n      this.measurements.push(measure) \n    };\n\n    measurementClear = () => {\n      this.measurements.splice(0, this.measurements.length)\n    };\n\n    measurementRemove = (index) => {\n      //console.log('this.measurements: ', this.measurements)\n      this.measurements.splice(index, 1)\n    };\n\n    getTransferSyntax = () => {\n      const value = this.image.data.string('x00020010');\n      return value + ' [' + uids[value] + ']'\n    };\n\n    getSopClass = () => {\n      const value = this.image.data.string('x00080016');\n      return value + ' [' + uids[value] + ']'\n    };\n\n    getSopInstanceUID = () => {\n      const value = this.image.data.string('x00080018');\n      return value\n    };\n\n    getPixelRepresentation = () => {\n      const value = this.image.data.uint16('x00280103');\n      if (value === undefined) return;\n      return value + (value === 0 ? ' (unsigned)' : ' (signed)')\n    };\n\n    getPlanarConfiguration = () => {\n      const value = this.image.data.uint16('x00280006');\n      if (value === undefined) return;\n      return value + (value === 0 ? ' (pixel)' : ' (plane)')\n    };\n   \n    onImageLoaded = (e) => {\n      //console.log('cornerstoneimageloaded: ')\n    };\n\n    // Listen for changes to the viewport so we can update the text overlays in the corner\n    onImageRendered = (e) => {\n      //console.log('cornerstoneimagerendered: ', e.target)\n      //console.log('cornerstoneimagerendered, plane: ', this.mprPlane)\n\n      //const viewport = cornerstone.getViewport(this.dicomImage)\n      const viewport = cornerstone.getViewport(e.target);\n\n      //console.log('viewport: ', viewport)\n\n      //if (this.props.activeDcm !== null)\n      //  console.log('viewport activeDcm: ', cornerstone.getViewport(this.props.activeDcm.element))\n\n      document.getElementById(\n        `mrtopleft-${this.props.index}`\n      ).textContent = this.mprIsOrthogonalView() ? `${capitalize(this.mprPlane)}` : `${this.PatientsName}`;\n\n      document.getElementById(\n        `mrtopright-${this.props.index}`\n      ).textContent = `${viewport.displayedArea.brhc.x}x${viewport.displayedArea.brhc.y}`;\n\n      document.getElementById(\n        `mrbottomleft-${this.props.index}`\n      ).textContent = `WW/WC: ${Math.round(viewport.voi.windowWidth)}/${Math.round(viewport.voi.windowCenter)}`;\n\n      document.getElementById(\n        `mrbottomright-${this.props.index}`\n      ).textContent = `Zoom: ${Math.round(viewport.scale.toFixed(2)*100)}%`;\n\n      document.getElementById(\n        `mrtopcenter-${this.props.index}`\n      ).textContent = ``;\n      document.getElementById(\n        `mrbottomcenter-${this.props.index}`\n      ).textContent = ``;\n      document.getElementById(\n        `mrleftcenter-${this.props.index}`\n      ).textContent = ``;\n      document.getElementById(\n        `mrrightcenter-${this.props.index}`\n      ).textContent = ``;\n\n      if (this.mprPlane === 'sagittal') {\n        document.getElementById(\n          `mrtopcenter-${this.props.index}`\n        ).textContent = `S`;\n        document.getElementById(\n          `mrbottomcenter-${this.props.index}`\n        ).textContent = `I`;\n        document.getElementById(\n          `mrleftcenter-${this.props.index}`\n        ).textContent = `A`;\n        document.getElementById(\n          `mrrightcenter-${this.props.index}`\n        ).textContent = `P`  \n\n      } else if (this.mprPlane === 'axial') {\n        document.getElementById(\n          `mrtopcenter-${this.props.index}`\n        ).textContent = `A`;\n        document.getElementById(\n          `mrbottomcenter-${this.props.index}`\n        ).textContent = `P`;\n        document.getElementById(\n          `mrleftcenter-${this.props.index}`\n        ).textContent = `R`;\n        document.getElementById(\n          `mrrightcenter-${this.props.index}`\n        ).textContent = `L`    \n\n      } else if (this.mprPlane === 'coronal') {\n        document.getElementById(\n          `mrtopcenter-${this.props.index}`\n        ).textContent = `S`;\n        document.getElementById(\n          `mrbottomcenter-${this.props.index}`\n        ).textContent = `I`;\n        document.getElementById(\n          `mrleftcenter-${this.props.index}`\n        ).textContent = `R`;\n        document.getElementById(\n          `mrrightcenter-${this.props.index}`\n        ).textContent = `L`                    \n      }    \n\n      if (this.isDicom && this.state.visibleCinePlayer && this.numberOfFrames > 1) {\n        document.getElementById(\n          `frameLabel-${this.props.index}`\n        ).textContent = `${this.state.frame} / ${this.numberOfFrames}`;\n        if (this.state.inPlay) {\n          let frame = this.state.frame === this.numberOfFrames ? 1 : this.state.frame+1;\n          this.setState({frame: frame})\n        }\n      }\n    };\n\n    onMeasurementModified = (e) => {\n      //console.log('cornerstonetoolsmeasurementmodified: ', e.detail.measurementData)\n      \n    };\n\n    onMeasurementAdded = (e) => {\n      //console.log('cornerstonetoolsmeasurementadded: ', e.detail.measurementData)\n      if (this.props.tool !== \"Angle\") return;\n      const measure = {\n        tool: this.props.tool,\n        note: '',\n        data: e.detail.measurementData\n      };\n      this.measurementSave(measure);\n      this.props.setActiveMeasurements(this.measurements)      \n    };\n\n    onMeasurementCompleted = (e) => {\n      //console.log('cornerstonetoolsmeasurementcompleted: ', e.detail.measurementData)\n      const measure = {\n        tool: this.props.tool,\n        note: '',\n        data: e.detail.measurementData\n      };\n      if (this.props.tool === \"FreehandRoi\") {\n        setTimeout(() => {\n          this.measurementSave(measure);\n          this.props.setActiveMeasurements(this.measurements)\n        }, 500)\n      } else {\n        this.measurementSave(measure);\n        this.props.setActiveMeasurements(this.measurements)\n      }\n    };\n    \n    onErrorOpenImageClose = () => {\n      this.setState({errorOnOpenImage: null})\n    };\n\n    onErrorCorsClose = () => {\n      this.setState({errorOnCors: false})\n    };\n\n    /*overlayImage = () => {\n      const viewport = cornerstone.getViewport(this.dicomImage)\n\n      if (this.isDicom) document.getElementById(\n        `mrtopleft-${this.props.index}`\n      ).textContent = `${this.PatientsName}`\n\n      document.getElementById(\n        `mrtopright-${this.props.index}`\n      ).textContent = `${viewport.displayedArea.brhc.x}x${viewport.displayedArea.brhc.y}`\n\n      document.getElementById(\n        `mrbottomleft-${this.props.index}`\n      ).textContent = `WW/WC: ${Math.round(viewport.voi.windowWidth)}/${Math.round(viewport.voi.windowCenter)}`\n\n      document.getElementById(\n        `mrbottomright-${this.props.index}`\n      ).textContent = `Zoom: ${Math.round(viewport.scale.toFixed(2)*100)}%`\n\n      if (this.isDicom && this.state.visibleCinePlayer && this.numberOfFrames > 1) {\n        document.getElementById(\n          `frameLabel-${this.props.index}`\n        ).textContent = `${this.state.frame} / ${this.numberOfFrames}`\n        if (this.state.inPlay) {\n          let frame = this.state.frame === this.numberOfFrames ? 1 : this.state.frame+1\n          this.setState({frame: frame})\n        }\n      }\n    }*/\n\n    displayImageFromFiles = (index) => {\n      // console.log('displayImageFromFiles: ', index)\n\n      const image = this.props.files[index].image;\n      const imageId = this.props.files[index].imageId;\n      this.filename = this.props.files[index].name;\n\n      const element = this.dicomImage;\n      element.addEventListener(\"cornerstonenewimage\", this.onNewImage);\n      element.addEventListener(\"cornerstoneimagerendered\", this.onImageRendered);\n      element.addEventListener(\"cornerstonetoolsmeasurementadded\", this.onMeasurementAdded);\n      element.addEventListener(\"cornerstonetoolsmeasurementmodified\", this.onMeasurementModified);\n      element.addEventListener(\"cornerstonetoolsmeasurementcompleted\", this.onMeasurementCompleted);\n      cornerstone.enable(element);\n\n      this.image = image;\n\n      this.isDicom = true;\n      \n      this.PatientsName = image.data.string('x00100010');\n      this.sopInstanceUid = this.getSopInstanceUID();\n\n      let stack = { currentImageIdIndex: 0, imageIds: \"\" };\n      this.numberOfFrames = image.data.intString('x00280008');\n      if (this.numberOfFrames > 0) {\n        let imageIds = [];\n        for(var i=0; i < this.numberOfFrames; ++i) {\n          imageIds.push(imageId + \"?frame=\"+i)\n        }\t\n        stack.imageIds = imageIds\n      }\n\n      cornerstone.displayImage(element, image);\n\n      /*const viewport = cornerstone.getViewport(this.dicomImage)\n      const lut =  cornerstone.generateLut(this.image, viewport.voi.windowWidth, viewport.voi.windowCenter, viewport.invert, viewport.modalityLUT, viewport.voiLUT)\n      this.props.setLutStore(lut)*/\n      this.mprPlanePosition();\n      \n      this.enableTool();\n\n      if (this.numberOfFrames > 1) {\n        cornerstoneTools.addStackStateManager(element, ['stack', 'playClip']);    \n        cornerstoneTools.addToolState(element, 'stack', stack);\n        this.setState({frame: 1})\n      }\n\n      // Load the possible measurements from DB and save in the store \n      db.measurement.where('sopinstanceuid').equals(this.sopInstanceUid).each(measure => {\n        console.log('load measure from db: ', measure);\n        this.measurementSave(measure);\n        cornerstoneTools.addToolState(element, measure.tool, measure.data);\n        this.runTool(measure.tool);\n        cornerstone.updateImage(element);\n        cornerstoneTools.setToolEnabled(measure.tool)\n      }).then(() => {\n        this.props.setActiveMeasurements(this.measurements);\n        this.props.setActiveDcm({image: this.image, element: this.dicomImage, isDicom: this.isDicom});\n        this.props.setIsOpenStore({index: this.props.index, value: true})        \n      })   \n      \n      //this.overlayImage()\n      \n    };\n\n    loadImageFromCanvas = (canvas) => {\n      console.log('loadImageFromCanvas, dcmViewer: ', this.props.index);\n\n      const element = this.dicomImage;\n      element.addEventListener(\"cornerstonenewimage\", this.onNewImage);\n      element.addEventListener(\"cornerstoneimagerendered\", this.onImageRendered);\n      element.addEventListener(\"cornerstonetoolsmeasurementadded\", this.onMeasurementAdded);\n      element.addEventListener(\"cornerstonetoolsmeasurementmodified\", this.onMeasurementModified);\n      element.addEventListener(\"cornerstonetoolsmeasurementcompleted\", this.onMeasurementCompleted);\n      cornerstone.enable(element);\n\n      const imageId = cornerstoneFileImageLoader.fileManager.addCanvas(canvas);\n\n      cornerstone.loadImage(imageId).then(image => {\n        //this.t1 = performance.now()\n        //console.log(`performance load image: ${this.t1-this.t0} milliseconds`)\n\n        console.log('loadImageFromCanvas, image: ', image);\n\n        this.image = image;\n\n        this.isDicom = false;\n\n        cornerstone.displayImage(element, image);\n\n        this.enableTool();\n\n        //this.props.setActiveDcm({image: this.image, element: this.dicomImage, isDicom: this.isDicom})\n        this.props.setIsOpenStore({index: this.props.index, value: true})\n\n        //this.t2 = performance.now()\n        //console.log(`performance: ${this.t2-this.t1} milliseconds`)\n\n        //this.overlayImage()\n\n      }, (e) => {\n        console.log('error', e);\n        this.setState({errorOnOpenImage: \"This is not a valid canvas.\"})\n      })\n    };\n\n    loadImageFromCustomObject = (columns, rows, pixelData) => {\n      //console.log('loadImageFromCustomObject: ')\n\n      const element = this.dicomImage;\n      element.addEventListener(\"cornerstonenewimage\", this.onNewImage);\n      element.addEventListener(\"cornerstoneimagerendered\", this.onImageRendered);\n      element.addEventListener(\"cornerstonetoolsmeasurementadded\", this.onMeasurementAdded);\n      element.addEventListener(\"cornerstonetoolsmeasurementmodified\", this.onMeasurementModified);\n      element.addEventListener(\"cornerstonetoolsmeasurementcompleted\", this.onMeasurementCompleted);\n      cornerstone.enable(element);\n      \n      let customObj = {\n        rows: rows,\n        columns: columns,\n        pixelData: pixelData,\n        image: this.originImage,\n      };\n\n      const imageId = cornerstoneFileImageLoader.fileManager.addCustom(customObj);\n\n      cornerstone.loadImage(imageId).then(image => {\n        //console.log('loadImageFromCustomObject, image: ', image)\n\n        this.image = image;\n\n        this.isDicom = true;\n\n        cornerstone.displayImage(element, image);\n\n        //this.enableTool()\n\n        this.props.setIsOpenStore({index: this.props.index, value: true})\n\n      }, (e) => {\n        console.log('error', e);\n        this.setState({errorOnOpenImage: \"This is not a valid canvas.\"})\n      })\n    };\n\n    loadImage = (localfile, url=undefined, fsItem=undefined) => {\n      console.log('loadImage, localfile: ', localfile);\n      console.log('loadImage, fsItem: ', fsItem);\n      console.log('loadImage, url: ', url);\n\n      if (localfile === undefined && url === undefined && fsItem === undefined) return;\n      \n      if (fsItem !== undefined) {\n        this.fsItem = fsItem\n      } else if (localfile !== undefined) {\n        this.localfile = localfile\n      } else {\n        this.localurl = url\n      }\n \n      const element = this.dicomImage;\n\n      element.addEventListener(\"cornerstonenewimage\", this.onNewImage);\n      element.addEventListener(\"cornerstoneimagerendered\", this.onImageRendered);\n      element.addEventListener(\"cornerstonetoolsmeasurementadded\", this.onMeasurementAdded);\n      element.addEventListener(\"cornerstonetoolsmeasurementmodified\", this.onMeasurementModified);\n      element.addEventListener(\"cornerstonetoolsmeasurementcompleted\", this.onMeasurementCompleted);\n\n      let imageId = undefined;\n\n      cornerstone.enable(element);\n\n      let size = 0;\n\n      if (localfile === undefined && isUrlImage(url)) { // check if it's a simple image [jpeg or png] from url\n        //console.log('image: ', file)\n        cornerstone.loadImage(url).then(image => {\n          //console.log('loadImage, image from url: ', image)\n\n          this.hideOpenUrlDlg();\n\n          this.image = image;\n\n          this.isDicom = false;\n\n          cornerstone.displayImage(element, image);\n          \n          this.enableTool();\n\n          this.props.setActiveDcm({image: this.image, element: this.dicomImage, isDicom: this.isDicom});\n          this.props.isOpenStore(true)\n\n        }, (e) => {\n          console.log('error', e);\n          this.setState({errorOnOpenImage: \"This is not a valid JPG or PNG file.\"})\n        })\n\n      } else if ((localfile !== undefined && isFileImage(localfile)) || (fsItem !== undefined && isFsFileImage(fsItem))) { // otherwise try to open as local image file (JPEG, PNG) \n        if (fsItem !== undefined) {\n          imageId = cornerstoneFileImageLoader.fileManager.addBuffer(fsItem.data)\n        } else {\n          imageId = cornerstoneFileImageLoader.fileManager.add(localfile)\n        }\n        cornerstone.loadImage(imageId).then(image => {\n          console.log('loadImage, image from local: ', image);\n\n          this.image = image;\n          this.isDicom = false;\n          this.PatientsName = '';\n          console.log(\"image data:\" + image.data);\n          cornerstone.displayImage(element, image);\n          \n          this.enableTool();\n\n          this.props.setActiveDcm({image: this.image, element: this.dicomImage, isDicom: this.isDicom});\n          //this.props.isOpenStore(true)\n          this.props.setIsOpenStore({index: this.props.index, value: true})\n\n        }, (e) => {\n          console.log('error', e);\n          this.setState({errorOnOpenImage: \"This is not a valid JPG or PNG file.\"})\n        })\n\n      } else { // otherwise try to open as Dicom file\n\n        if (fsItem !== undefined) {\n          imageId = cornerstoneWADOImageLoader.wadouri.fileManager.addBuffer(fsItem.data);\n          this.filename = fsItem.name;\n          size = fsItem.size\n        } else if (localfile !== undefined) {\n          imageId = cornerstoneWADOImageLoader.wadouri.fileManager.add(localfile);\n          this.filename = localfile.name;\n          size = localfile.size\n        } else { // it's a web dicom image\n          imageId = \"wadouri:\"+url\n        }\n  \n        //console.log('loadImage, imageId: ', imageId)\n\n        cornerstone.loadAndCacheImage(imageId).then(image => {\n          //console.log('loadImage, image: ', image)\n          //let pixelDataElement = image.data.elements.x7fe00010\n          //console.log('loadImage, pixelDataElement: ', pixelDataElement)\n          //console.log('loadImage, getPixelData: ', image.getPixelData())\n          \n          this.hideOpenUrlDlg();\n\n          this.image = image;\n\n          this.isDicom = true;\n          \n          this.PatientsName = image.data.string('x00100010');\n          this.sopInstanceUid = this.getSopInstanceUID();\n\n          let stack = { currentImageIdIndex: 0, imageIds: \"\" };\n          this.numberOfFrames = image.data.intString('x00280008');\n          if (this.numberOfFrames > 0) {\n            let imageIds = [];\n            for(var i=0; i < this.numberOfFrames; ++i) {\n              imageIds.push(imageId + \"?frame=\"+i)\n            }\t\n            stack.imageIds = imageIds\n          }\n\n          cornerstone.displayImage(element, image);\n          //cornerstoneTools.mouseInput.enable(element);\n          //cornerstoneTools.mouseWheelInput.enable(element);\n\n          this.enableTool();\n\n          /*const viewport = cornerstone.getViewport(this.dicomImage)\n          const lut =  cornerstone.generateLut(this.image, viewport.voi.windowWidth, viewport.voi.windowCenter, viewport.invert, viewport.modalityLUT, viewport.voiLUT)\n          console.log('lut: ', lut)*/\n\n          if (this.numberOfFrames > 1) {\n            cornerstoneTools.addStackStateManager(element, ['stack', 'playClip']);    \n            cornerstoneTools.addToolState(element, 'stack', stack);\n            //cornerstoneTools.setToolActive('StackScrollMouseWheel', { })\n            this.setState({frame: 1})\n          }\n  \n          // Load the possible measurements from DB and save in the store \n          db.measurement.where('sopinstanceuid').equals(this.sopInstanceUid).each(measure => {\n            console.log('load measure from db: ', measure);\n            //this.props.measurementStore(measure)\n            this.measurementSave(measure);\n            cornerstoneTools.addToolState(element, measure.tool, measure.data);\n            this.runTool(measure.tool);\n            cornerstone.updateImage(element);\n            cornerstoneTools.setToolEnabled(measure.tool)\n          }).then(() => {\n            //console.log('this.measurements: ', this.measurements)\n            this.props.setActiveMeasurements(this.measurements);\n            this.props.setActiveDcm({name: this.filename, size: size, image: this.image, element: this.dicomImage, isDicom: this.isDicom});\n            this.props.setIsOpenStore({index: this.props.index, value: true})            \n          })       \n\n        }, (e) => {\n          console.log('error', e);\n          this.hideOpenUrlDlg();\n          //console.log('toString: ', e.error.toString())\n          const error = e.error.toString();\n          if (error === '[object XMLHttpRequest]') {\n            this.setState({errorOnCors: true})\n          } else {\n            const pos = error.indexOf(\":\");\n            this.setState({errorOnOpenImage: pos < 0 ? e.error : error.substring(pos+1)})            \n          } \n        })\n      }\n    };\n  \n    enableTool = (toolName, mouseButtonNumber) => {\n      // Enable all tools we want to use with this element\n      const WwwcTool = cornerstoneTools.WwwcTool;\n      const LengthTool = cornerstoneTools['LengthTool'];\n      const PanTool = cornerstoneTools.PanTool;\n      const ZoomTouchPinchTool = cornerstoneTools.ZoomTouchPinchTool;\n      const ZoomTool = cornerstoneTools.ZoomTool;\n      const ProbeTool = cornerstoneTools.ProbeTool;\n      const EllipticalRoiTool = cornerstoneTools.EllipticalRoiTool;\n      const RectangleRoiTool = cornerstoneTools.RectangleRoiTool;\n      const FreehandRoiTool = cornerstoneTools.FreehandRoiTool;\n      const AngleTool = cornerstoneTools.AngleTool;\n      const MagnifyTool = cornerstoneTools.MagnifyTool;\n      const StackScrollMouseWheelTool = cornerstoneTools.StackScrollMouseWheelTool;\n\n      cornerstoneTools.addTool(MagnifyTool);\n      cornerstoneTools.addTool(AngleTool);\n      cornerstoneTools.addTool(WwwcTool);\n      cornerstoneTools.addTool(LengthTool);\n      cornerstoneTools.addTool(PanTool);\n      cornerstoneTools.addTool(ZoomTouchPinchTool);\n      cornerstoneTools.addTool(ZoomTool);\n      cornerstoneTools.addTool(ProbeTool);\n      cornerstoneTools.addTool(EllipticalRoiTool);\n      cornerstoneTools.addTool(RectangleRoiTool);\n      cornerstoneTools.addTool(FreehandRoiTool);\n      cornerstoneTools.addTool(StackScrollMouseWheelTool)      \n    };\n  \n    // helper function used by the tool button handlers to disable the active tool\n    // before making a new tool active\n    disableAllTools = () => {\n      cornerstoneTools.setToolEnabled('Length');\n      cornerstoneTools.setToolEnabled('Pan');\n      cornerstoneTools.setToolEnabled('Magnify');\n      cornerstoneTools.setToolEnabled('Angle');\n      cornerstoneTools.setToolEnabled('RectangleRoi');\n      cornerstoneTools.setToolEnabled('Wwwc');\n      cornerstoneTools.setToolEnabled('ZoomTouchPinch');\n      cornerstoneTools.setToolEnabled('Probe');\n      cornerstoneTools.setToolEnabled('EllipticalRoi');\n      cornerstoneTools.setToolEnabled('FreehandRoi');\n      cornerstoneTools.setToolEnabled('StackScrollMouseWheel')\n    };\n  \n    runTool = (toolName, opt) => {\n      //console.log('run tool: ', toolName)\n      // this.disableAllTools()\n      switch (toolName) {\n        case 'openimage': {\n          //console.log('openimage: ', opt)\n          //console.log('openimage, this.dicomImage: ', this.dicomImage)\n          cornerstone.disable(this.dicomImage);\n          this.displayImageFromFiles(opt);\n          break   \n        }\n        case 'openLocalFs': {\n          console.log('openLocalFs: ', opt);\n          cornerstone.disable(this.dicomImage);\n          this.loadImage(opt);\n          break   \n        } \n        case 'openSandboxFs': {\n          //console.log('openSandboxFs: ', opt)\n          cornerstone.disable(this.dicomImage);\n          //this.setState({ file: opt })\n          this.loadImage(undefined, undefined, opt);\n          break   \n        }         \n        case 'openurl': {\n          //console.log('run tool opt: ', opt)  \n          this.showOpenUrlDlg(opt);\n          break                 \n        }\n        case 'clear': {\n          this.setState({ visibleCinePlayer: false });\n          this.mprPlane = '';\n          //this.props.clearingStore()\n          cornerstone.disable(this.dicomImage);\n          break\n        }  \n        case 'notool': {\n          this.disableAllTools();\n\n          //const element = this.dicomImage\n\n          //cornerstoneTools.clearToolState(element, 'Length')\n          \n          //const toolStateManager = cornerstoneTools.getElementToolStateManager(element)\n          //console.log('toolStateManager.toolState: ', toolStateManager.toolState)\n          /*\n          const toolState = toolStateManager.toolState\n          // const allTools = Object.keys(toolState).map(key => toolState[key])\n          let key = Object.keys(toolState)[0]\n          let allTools = toolState[key]\n          //console.log('allTools: ', allTools)\n\n          for (let [tool, data] of Object.entries(allTools)) {\n            //console.log(`${tool}: `, data)\n            let key = Object.keys(data)[0]\n            let tools = data[key]\n            //console.log('tools: ', tools)\n            tools.forEach(item => {\n              //console.log('tool: ', tool)\n              //console.log(item)\n              const measure = {\n                tool: tool,\n                note: '',\n                data: item\n              }\n              console.log('measure: ', measure)\n              this.props.measurementStore(measure)\n            })\n          }\n          */\n          //const toolState = toolStateManager.get(element, 'Length')\n          //console.log('toolState: ', toolState)\n\n          /*\n          const measurementData = {\n            visible: true,\n            active: true,\n            invalidated: true,\n            handles: {\n                start: {\n                    x: 100,\n                    y: 100,\n                    highlight: true,\n                    active: false\n                },\n                end: {\n                    x: 200,\n                    y: 200,\n                    highlight: true,\n                    active: true\n                },\n                textBox: {\n                    active: false,\n                    hasMoved: false,\n                    movesIndependently: false,\n                    drawnIndependently: true,\n                    allowedOutsideImage: true,\n                    hasBoundingBox: true\n                }\n              }\n          }\n          cornerstoneTools.addToolState(element, 'RectangleRoi', measurementData)    \n          cornerstoneTools.setToolActive('RectangleRoi', { mouseButtonMask: 1 })\n          */  \n          //cornerstone.updateImage(element)   \n          break\n        }\n        case 'Wwwc': {\n          cornerstoneTools.setToolActive('Wwwc', { mouseButtonMask: 1 });\n          break\n        }  \n        case 'Pan': {\n          cornerstoneTools.setToolActive('Pan', { mouseButtonMask: 1 });\n          break   \n        }  \n        case 'Zoom': {\n          cornerstoneTools.setToolActive(isMobile ? 'ZoomTouchPinch' : 'Zoom', { mouseButtonMask: 1 });\n          break\n        }\n        case 'Length': {\n          cornerstoneTools.setToolActive('Length', isMobile ? { isTouchActive: true } : { mouseButtonMask: 1 });\n          break  \n        }\n        case 'Probe': {\n            cornerstoneTools.setToolActive('Probe', { mouseButtonMask: 1 });\n          break\n        }\n        case 'EllipticalRoi': {\n          cornerstoneTools.setToolActive('EllipticalRoi', { mouseButtonMask: 1 });\n          break   \n        }\n        case 'RectangleRoi': {\n          cornerstoneTools.setToolActive('RectangleRoi', { mouseButtonMask: 1 });\n          break  \n        }\n        case 'Angle': {\n          cornerstoneTools.setToolActive('Angle', { mouseButtonMask: 1 });\n          break \n        }\n        case 'Magnify': {\n          cornerstoneTools.setToolActive('Magnify', { mouseButtonMask: 1 });\n          break  \n        }\n        case 'FreehandRoi': {\n          cornerstoneTools.setToolActive('FreehandRoi', { mouseButtonMask: 1 });\n          break \n        }\n        case 'Invert': {\n          const element = this.dicomImage;\n          const viewport = cornerstone.getViewport(element);\n          viewport.invert = !viewport.invert;\n          cornerstone.setViewport(element, viewport);\n          break \n        }         \n        case 'saveas': {\n            let type = localStorage.getItem(SETTINGS_SAVEAS);\n            if (getSettingsSaveInto() === 'local') {\n              // cornerstoneTools.SaveAs(this.dicomImage, `${this.filename}.${type}`, `image/${type}`)   \n              const element = this.dicomImage;\n              const viewport = cornerstone.getViewport(element);\n              const canvas = document.getElementsByClassName('cornerstone-canvas')[this.props.activeDcmIndex];\n              const zoom = viewport.scale.toFixed(2);\n              const cols = this.image.columns * zoom;\n              const rows = this.image.rows * zoom;\n\n              let myCanvas = document.createElement('canvas');\n              myCanvas = this.cropCanvas(canvas, \n                Math.round(canvas.width / 2 - cols / 2), \n                Math.round(canvas.height / 2 - rows / 2), \n                cols, rows);\n\n              let a = document.createElement(\"a\");\n              a.href = myCanvas.toDataURL(`image/${type}`);\n              a.download = `${this.filename}.${type}`;\n              document.body.appendChild(a); // Required for this to work in FireFox\n              a.click()           \n\n            } else { // store image into sandbox file system\n              const element = this.dicomImage;\n              const viewport = cornerstone.getViewport(element);\n              const canvas = document.getElementsByClassName('cornerstone-canvas')[this.props.activeDcmIndex];\n              const zoom = viewport.scale.toFixed(2);\n              const cols = this.image.columns * zoom;\n              const rows = this.image.rows * zoom;\n\n              let myCanvas = document.createElement('canvas');\n              myCanvas = this.cropCanvas(canvas, \n                Math.round(canvas.width / 2 - cols / 2), \n                Math.round(canvas.height / 2 - rows / 2), \n                cols, rows);\n              \n              blobUtil.canvasToBlob(myCanvas, `image/${type}`).then(blob => {\n                blobUtil.blobToArrayBuffer(blob).then(arrayBuffer => {\n                  const name = `${getFileName(this.filename)}-MPR-${this.mprPlane}`;\n                  let newName = name;\n                  let counter = 1;\n                  let done = false;\n                  do {\n                      let filename = `${newName}.${type}`;\n                      const checkName = this.props.fsCurrentList.find(e => e.name === filename);\n                      if (checkName === undefined) {\n                          fs.transaction('rw', fs.files, async () => {\n                              await fs.files.add({\n                                  parent: this.props.fsCurrentDir,\n                                  name: filename,\n                                  type: type,\n                                  size: arrayBuffer.byteLength,\n                                  data: arrayBuffer\n                              })\n                          }).then(() => {\n                            this.props.makeFsRefresh()\n                          });\n                          done = true\n                      } else {\n                          newName = `${name} - ${counter}`;\n                          counter++\n                      }\n                  } while (!done)\n                })\n              })\n            }  \n          break\n        }\n        case 'cine': {\n          this.setState({ visibleCinePlayer: !this.state.visibleCinePlayer });\n          break\n        }\n        case 'reset': {\n          this.reset();\n          break\n        }\n        case 'removetool': {\n          console.log('removetool index: ', opt);\n          const element = this.dicomImage;\n          cornerstoneTools.removeToolState(element, this.measurements[opt].tool, this.measurements[opt].data);\n          cornerstone.updateImage(element);\n          //this.props.measurementRemoveStore(opt)\n          this.measurementRemove(opt);\n          this.props.setActiveMeasurements(this.measurements);\n          break\n        }  \n        case 'removetools': {   \n          const element = this.dicomImage;\n          // for each measurement remove it \n          this.measurements.forEach(measure => {\n            cornerstoneTools.clearToolState(element, measure.tool)         \n          });\n          cornerstone.updateImage(element);\n          this.measurementClear();\n          // also remove all measurements from db\n          db.measurement.where('sopinstanceuid').equals(this.sopInstanceUid).delete();\n          this.props.setActiveMeasurements(this.measurements);\n          break\n        }  \n        case 'savetools': {\n          // first, remove eventually previous measurements from db\n          db.measurement.where('sopinstanceuid').equals(this.sopInstanceUid).delete();\n          // then save all the current measurements\n          this.measurements.forEach(measure => {\n            try {\n              db.measurement.add({\n                sopinstanceuid: this.sopInstanceUid, \n                tool: measure.tool,\n                note: measure.note,\n                data: measure.data\n              })\n            } catch(error) {\n              console.error(error)\n            }                       \n          });\n          break\n        }\n        default: {\n          break\n        }\n      }\n    };\n\n    cropCanvas = (canvas, x, y, width, height) => {\n      console.log(`canvas: ${canvas.width}, ${canvas.height}`);\n      console.log(`x, y: ${x}, ${y}`);\n      console.log(`width, height: ${width}, ${height}`);\n\n      // create a temp canvas\n      const newCanvas = document.createElement('canvas');\n      // set its dimensions\n      newCanvas.width = width;\n      newCanvas.height = height;\n      // draw the canvas in the new resized temp canvas \n      newCanvas.getContext('2d').drawImage(canvas, x, y, width, height, 0, 0, width, height);\n      return newCanvas\n    };\n\n    changeTool = (toolName, value) => {\n      console.log('change tool, value: ', toolName, value);\n\n      switch (toolName) {\n        case 'Wwwc':\n          if (value === 1) {\n            cornerstoneTools.setToolActive('Wwwc', { mouseButtonMask: 1 })\n          } else if (value === 0) {\n            cornerstoneTools.setToolPassive('Wwwc')\n          }\n          break;\n        case 'Pan':\n          if (value === 1) {\n            cornerstoneTools.setToolActive('Pan', { mouseButtonMask: 1 })\n          } else if (value === 0) {\n            cornerstoneTools.setToolPassive('Pan')\n          }\n          break;\n        case 'Zoom':\n          if (value === 1) {\n            cornerstoneTools.setToolActive(isMobile ? 'ZoomTouchPinch' : 'Zoom', { mouseButtonMask: 1 })\n          } else if (value === 0) {\n            cornerstoneTools.setToolPassive(isMobile ? 'ZoomTouchPinch' : 'Zoom')\n          }\n          break;\n        case 'Length':\n          if (value === 1) {\n            cornerstoneTools.setToolActive('Length', isMobile ? { isTouchActive: true } : { mouseButtonMask: 1 })\n          } else if (value === 0) {\n            cornerstoneTools.setToolPassive('Length')\n          }\n          break;\n        case 'Probe':\n          if (value === 1) {\n            cornerstoneTools.setToolActive('Probe', { mouseButtonMask: 1 })\n          } else if (value === 0) {\n            cornerstoneTools.setToolPassive('Probe')\n          }\n          break;\n        case 'Angle':\n          if (value === 1) {\n            cornerstoneTools.setToolActive('Angle', { mouseButtonMask: 1 })\n          } else if (value === 0) {\n            cornerstoneTools.setToolPassive('Angle')\n          }          \n          break;\n        case 'Magnify':\n          if (value === 1) {\n            cornerstoneTools.setToolActive('Magnify', { mouseButtonMask: 1 })\n          } else if (value === 0) {\n            cornerstoneTools.setToolPassive('Magnify')\n          }          \n          break;\n        case 'EllipticalRoi':\n          if (value === 1) {\n            cornerstoneTools.setToolActive('EllipticalRoi', { mouseButtonMask: 1 })\n          } else if (value === 0) {\n            cornerstoneTools.setToolPassive('EllipticalRoi')\n          }\n          break;\n        case 'RectangleRoi':\n          if (value === 1) {\n            cornerstoneTools.setToolActive('RectangleRoi', { mouseButtonMask: 1 })\n          } else if (value === 0) {\n            cornerstoneTools.setToolPassive('RectangleRoi')\n          }\n          break;\n        case 'FreehandRoi':\n          if (value === 1) {\n            cornerstoneTools.setToolActive('FreehandRoi', { mouseButtonMask: 1 })\n          } else if (value === 0) {\n            cornerstoneTools.setToolPassive('FreehandRoi')\n          }\n          break;\n        default:\n            break\n        }  \n    };\n\n    runCinePlayer = (cmdName) => {\n      //console.log('this.state.frame: ', this.state.frame)\n      const element = this.dicomImage;\n      switch (cmdName) {\n        case 'firstframe': {\n          let frame = 1;\n          this.setState({frame: frame});\n          scrollToIndex(element, 0);\n          break\n        }\n        case 'previousframe': {\n          if (this.state.frame > 1) {\n            let frame = this.state.frame-1;\n            this.setState({frame: frame});\n            scrollToIndex(element, frame-1)       \n          }\n          break\n        }\n        case 'play': {\n          cornerstoneTools.playClip(element, 30);\n          this.setState({inPlay: true});\n          break\n        }\n        case 'pause': {\n            cornerstoneTools.stopClip(element);\n            this.setState({inPlay: false});\n          break\n        }\n        case 'nextframe': {\n          if (this.state.frame < this.numberOfFrames) {\n            let frame = this.state.frame+1;\n            this.setState({frame: frame});\n            scrollToIndex(element, frame-1)\n          }\n          break  \n        }\n        case 'lastframe': {\n          let frame = this.numberOfFrames;\n          this.setState({frame: frame});\n          scrollToIndex(element, frame-1);\n          break    \n        }                       \n        default:\n          break\n      }\n    };\n\n    reset = () => {\n      const element = this.dicomImage;\n      const defaultViewport = cornerstone.getDefaultViewportForImage(element, this.image);\n      let viewport = cornerstone.getViewport(element);\n      viewport.voi.windowWidth = defaultViewport.voi.windowWidth;\n      viewport.voi.windowCenter = defaultViewport.voi.windowCenter;\n      viewport.invert = false;\n      cornerstone.setViewport(element, viewport)\n    };\n\n    // -------------------------------------------------------------------------------------------- MPR\n\n    mprPlanePosition = () => {\n      //console.log(\"mprPlanePosition: \")\n      try {\n        if (!this.isDicom) return this.mprPlane;\n        // console.log(\"image data:\" + this.image.data);\n        const imageOrientation = this.image.data.string('x00200037').split('\\\\');\n        let v = new Array(6).fill(0);\n        v[0] = parseFloat(imageOrientation[0]); // the x direction cosines of the first row X\n        v[1] = parseFloat(imageOrientation[1]); // the y direction cosines of the first row X\n        v[2] = parseFloat(imageOrientation[2]); // the z direction cosines of the first row X\n        v[3] = parseFloat(imageOrientation[3]); // the x direction cosines of the first column Y\n        v[4] = parseFloat(imageOrientation[4]); // the y direction cosines of the first column Y\n        v[5] = parseFloat(imageOrientation[5]); // the z direction cosines of the first column Y\n        v = v.map((x) => Math.round(x));\n        let p = [v[1]*v[5] - v[2]*v[4], v[2]*v[3] - v[0]*v[5], v[0]*v[4] - v[1]*v[3]]; // cross product of X x Y\n        p = p.map((x) => Math.abs(x));\n        if (p[0] === 1) {\n          this.mprPlane = 'sagittal'\n        } else if (p[1] === 1) {\n          this.mprPlane = 'coronal'\n        } else if (p[2] === 1) {\n          this.mprPlane = 'axial'\n        }\n      } catch(error) { // it's not possible to build MPR\n        this.mprPlane = ''\n      } \n      return this.mprPlane \n    };\n\n    transpose = (matrix) => {\n      return Object.keys(matrix[0]).map(colNumber => matrix.map(rowNumber => rowNumber[colNumber]));\n    };\n\n    mprRenderYZPlane = (filename, origin, x, mprData) => {\n      if (this.volume === null) return;\n      this.filename = filename;\n      cornerstone.disable(this.dicomImage);\n      //console.log(`mprRenderYZPlane, origin: ${origin}, x: ${x}`)\n      //console.log('mprRenderYZPlane, volume: ', this.volume)\n\n      if (origin === 'sagittal') \n        this.mprPlane = 'coronal';\n      else if (origin === 'axial') \n        this.mprPlane = 'sagittal';\n      else\n        this.mprPlane = 'sagittal';\n\n      this.xSize = this.props.files[0].columns;\n      this.ySize = this.props.files[0].rows;\n      this.zSize = mprData.zDim;\n\n      const i = Math.round(x / this.xSize * this.props.files.length);\n      this.originImage = this.props.files[i].image;\n\n      if (origin === 'sagittal') {\n        let xoffset = Math.floor(this.xSize / 2) - Math.floor(this.zSize / 2);\n        let plane = new Int16Array(this.xSize * this.ySize);\n        for (let y = 0; y < this.ySize; y++) \n          for (let z = 0; z < this.zSize; z++) \n            plane[z + this.ySize * y + xoffset] = this.volume[z][x + this.ySize * y];\n        this.loadImageFromCustomObject(this.xSize, this.ySize, plane)\n\n      } else if (origin === 'coronal') {\n        let xoffset = Math.floor(this.xSize / 2) - Math.floor(this.zSize / 2);\n        let plane = new Int16Array(this.xSize * this.ySize);\n        for (let y = 0; y < this.ySize; y++) \n          for (let z = 0; z < this.zSize; z++) \n            plane[z + this.ySize * y + xoffset] = this.volume[z][x + this.ySize * y];\n        this.loadImageFromCustomObject(this.xSize, this.ySize, plane)\n\n      } else { // axial\n        const yzPlane = this.mprBuildYZPlane(x);\n        this.loadImageFromCustomObject(this.ySize, this.zSize, yzPlane)\n      }\n    };\n\n    mprBuildYZPlane = (x) => {\n      //console.log(`mprBuildYZPlane, ySize: ${this.ySize}, zSize: ${this.zSize} `)\n      let plane = new Int16Array(this.ySize * this.zSize);\n      for (var y = 0; y < this.ySize; y++) \n        for (var z = 0; z < this.zSize; z++) \n          plane[y + this.ySize * z] = this.volume[z][x + this.ySize * y];\n      //console.log('mprBuildYZPlane, plane: ', plane)\n      return plane\n    };\n\n    mprRenderXZPlane = (filename, origin, y, mprData) => {\n      if (this.volume === null) return;\n      this.filename = filename;\n      cornerstone.disable(this.dicomImage);\n      //console.log(`mprRenderXZPlane, origin: ${origin}, y: ${y}`)\n      //console.log('mprRenderXZPlane, volume: ', this.volume)\n\n      if (origin === 'sagittal') \n        this.mprPlane = 'axial';\n      else if (origin === 'axial') \n        this.mprPlane = 'coronal';\n      else\n        this.mprPlane = 'axial';\n\n      this.xSize = this.props.files[0].columns;\n      this.ySize = this.props.files[0].rows;\n      this.zSize = mprData.zDim;\n\n      const i = Math.trunc(y / this.ySize * this.props.files.length);\n      this.originImage = this.props.files[i].image;\n\n      if (origin === 'sagittal') {\n        let xoffset = Math.floor(this.xSize / 2) - Math.floor(this.zSize / 2);\n        let plane = new Int16Array(this.xSize * this.ySize);\n        for (let x = 0; x < this.xSize; x++) \n          for (let z = 0; z < this.zSize; z++)\n            plane[z + this.xSize * x + xoffset] = this.volume[z][x + this.xSize * y];\n        this.loadImageFromCustomObject(this.xSize, this.ySize, plane)\n\n      } else {\n        const xzPlane = this.mprBuildXZPlane(y);\n        this.loadImageFromCustomObject(this.xSize, this.zSize, xzPlane)\n      }\n    };\n  \n    mprBuildXZPlane = (y) => {\n      //console.log(`mprBuildXZPlane, xSize: ${this.xSize}, zSize: ${this.zSize} `)\n      let plane = new Int16Array(this.xSize * this.zSize);\n      for (let x = 0; x < this.xSize; x++) \n        for (let z = 0; z < this.zSize; z++)\n          plane[x + this.xSize * z] = this.volume[z][x + this.xSize * y];\n      //console.log('mprBuildXZPlane, plane: ', plane)    \n      return plane\n    };\n\n    mprIsOrthogonalView = () => {\n      //console.log('mprIsOrthogonalView: ', this.mprPlane)\n      return (this.mprPlane !== '' && this.props.layout[0] === 1 && this.props.layout[1] === 3)\n    };\n\n    // -------------------------------------------------------------------------------------------- MPR\n    \n    dicomImageRef = el => {\n      this.dicomImage = el\n    };\n\n    onImageClick = () => {\n      console.log('onImageClick: ')\n    };\n    \n    render() {\n      //console.log('DicomViewer render: ')\n\n      //this.props.visible ? document.body.style = 'background: #000000;' : document.body.style = 'background: $md-grey-700;'\n\n      const isOpen = this.props.isOpen[this.props.index];\n      //const visibleHistogram = this.state.visibleHistogram\n      const visibleOpenUrlDlg = this.state.visibleOpenUrlDlg;\n      const errorOnOpenImage = this.state.errorOnOpenImage;\n      const progress = this.state.progress;\n\n      const styleContainer = {\n        width: '100%', \n        height: '100%', \n        border: this.props.activeDcmIndex === this.props.index && (this.props.layout[0] > 1 || this.props.layout[1] > 1) ? 'solid 1px #AAAAAA' : null,\n        position: 'relative',\n      };\n\n      const styleDicomImage = {\n        width: '100%', \n        height: '100%', \n        position: 'relative',\n      };\n\n      const overlay = getSettingsOverlay();\n\n      return ( \n        <div className=\"container\" style={styleContainer} >\n\n          {visibleOpenUrlDlg ? <OpenUrlDlg progress={progress} onClose={this.hideOpenUrlDlg} /> : null}\n\n          <Dialog\n            open={errorOnOpenImage !== null}\n            onClose={this.onErrorOpenImageClose}\n          >\n            <DialogTitle id=\"alert-dialog-title\">{\"Error on opening image\"}</DialogTitle>\n            <DialogContent>\n              <DialogContentText id=\"alert-dialog-description\">\n                {this.state.errorOnOpenImage}\n              </DialogContentText>\n            </DialogContent>\n            <DialogActions>\n              <Button onClick={this.onErrorOpenImageClose} autoFocus>\n                Ok\n              </Button>\n            </DialogActions>\n          </Dialog>\n\n          <Dialog\n            open={this.state.errorOnCors}\n            onClose={this.onErrorCorsClose}\n            aria-labelledby=\"alert-dialog-title\"\n            aria-describedby=\"alert-dialog-description\"\n          >\n            <DialogTitle id=\"alert-dialog-title\">{\"Error on loading image\"}</DialogTitle>\n            <DialogContent>\n              <DialogContentText id=\"alert-dialog-description\">\n                <Typography gutterBottom>\n                  CORS or Cross Origin Resource Sharing is a browser security policy \n                  that prevents javascript from loading data from a server with a different base URL \n                  than the server that served up the javascript file. \n                </Typography> \n                <Typography gutterBottom>\n                  See the &nbsp; \n                  <Link href=\"http://enable-cors.org/\" target='_blank' color='textPrimary'>\n                    Enable CORS site\n                  </Link>\n                  &nbsp; for information about CORS.                     \n                </Typography>                                \n              </DialogContentText>\n            </DialogContent>\n            <DialogActions>\n              <Button onClick={this.onErrorCorsClose} autoFocus>\n                Ok\n              </Button>\n            </DialogActions>\n          </Dialog>\n\n          <div\n            style={{\n              width: '100%', \n              height: '100%', \n              position: \"relative\",\n              color: '#FFFFFF',\n              textShadow: '1px 1px #000000'\n            }}\n            onContextMenu={() => false}\n            className=\"cornerstone-enabled-image\"\n          >\n            <div \n              ref={this.dicomImageRef} style={styleDicomImage}\n            >\n            </div>\n\n            <div\n              id={`mrtopleft-${this.props.index}`}\n              style={{ position: \"absolute\", top: 0, left: 3, display: isOpen && overlay ? \"\" : \"none\" }}\n            >\n              \n            </div>\n            <div\n              id={`mrtopright-${this.props.index}`}\n              style={{ position: \"absolute\", top: 0, right: 3, display: isOpen && overlay ? \"\" : \"none\" }}\n            >\n              \n            </div>\n            <div\n              id={`mrbottomright-${this.props.index}`}\n              style={{ position: \"absolute\", bottom: 0, right: 3, display: isOpen && overlay ? \"\" : \"none\" }}\n            >\n              \n            </div>\n            <div\n              id={`mrbottomleft-${this.props.index}`}\n              style={{ position: \"absolute\", bottom: 0, left: 3, display: isOpen && overlay ? \"\" : \"none\" }}\n            >\n              \n            </div>   \n\n            <div\n              id={`mrtopcenter-${this.props.index}`}\n              style={{ position: \"absolute\", top: 0, width: '60px', left: '50%', marginLeft: '0px', display: isOpen && overlay ? \"\" : \"none\" }}\n            >\n              \n            </div>\n\n            <div\n              id={`mrleftcenter-${this.props.index}`}\n              style={{ position: \"absolute\", top: '50%', width: '30px', left: 3, marginLeft: '0px', display: isOpen && overlay ? \"\" : \"none\" }}\n            >\n              \n            </div>    \n\n            <div\n              id={`mrrightcenter-${this.props.index}`}\n              style={{ position: \"absolute\", top: '50%', width: '30px', right: 3, marginRight: '-20px', display: isOpen && overlay ? \"\" : \"none\" }}\n            >\n              \n            </div>                \n\n            <div\n              id={`mrbottomcenter-${this.props.index}`}\n              style={{ position: \"absolute\", bottom: 0, width: '60px', left: '50%', marginLeft: '0px', display: isOpen && overlay ? \"\" : \"none\" }}\n            >\n              \n            </div>\n\n            { this.state.visibleCinePlayer && this.numberOfFrames > 1 ? (\n              <div style={{position:\"absolute\", width:'100%', bottom:0, textAlign:'center'}}>\n                <div style={{margin:'0 auto', width:'240px', backgroundColor:'rgba(136, 136, 136, 0.5)'}}>\n                  <CinePlayer runCinePlayer={this.runCinePlayer} inPlay={this.state.inPlay} />  \n                  <div \n                    id={`frameLabel-${this.props.index}`}\n                    style={{ width:230, margin:'0 auto', marginTop:-10, textAlign:\"center\" }}\n                  >\n                    {this.state.frame} / {this.numberOfFrames}\n                  </div> \n                </div>               \n              </div> \n              ) : null\n            }  \n            {/*<div style={{position:\"absolute\", width:'100%', height:'100%', top:0, left:0}}></div>*/}\n          </div>\n        </div>\n      )\n    }\n  }\n  \nconst mapStateToProps = (state) => {\n  return {\n    files: state.files,\n    url: state.url,\n    isOpen: state.isOpen,\n    tool: state.tool,\n    activeDcmIndex: state.activeDcmIndex,\n    activeDcm: state.activeDcm,\n    measurements: state.measurements,\n    layout: state.layout,\n    fsCurrentDir: state.fsCurrentDir,\n    fsCurrentList: state.fsCurrentList,\n    volume: state.volume,\n    lut: state.lut,\n    //sandboxedFile: state.sandboxedFile,\n  }\n};\n\nconst mapDispatchToProps = (dispatch) => {\n  return {\n    clearingStore: () => dispatch(clearStore()),\n    setIsOpenStore: (value) => dispatch(dcmIsOpen(value)),\n    toolStore: (tool) => dispatch(dcmTool(tool)),\n    setActiveDcm: (dcm) => dispatch(activeDcm(dcm)),\n    setActiveMeasurements: (measurements) => dispatch(activeMeasurements(measurements)),\n    makeFsRefresh: (dcm) => dispatch(doFsRefresh()),\n    //setLutStore: (lut) => dispatch(setLut(lut)),\n  }\n};\n\nexport default connect(mapStateToProps, mapDispatchToProps)(DicomViewer)\n"]},"metadata":{},"sourceType":"module"}