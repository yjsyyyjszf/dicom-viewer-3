{"ast":null,"code":"var _jsxFileName = \"/media/mohammad/work/websites/cornerstone/dicom-viewer/src/components/DicomViewer.js\";\nimport React from \"react\";\nimport { connect } from 'react-redux';\nimport Button from '@material-ui/core/Button';\nimport Dialog from '@material-ui/core/Dialog';\nimport DialogActions from '@material-ui/core/DialogActions';\nimport DialogContent from '@material-ui/core/DialogContent';\nimport DialogContentText from '@material-ui/core/DialogContentText';\nimport DialogTitle from '@material-ui/core/DialogTitle';\nimport Link from '@material-ui/core/Link';\nimport Typography from '@material-ui/core/Typography';\nimport Hammer from \"hammerjs\";\nimport * as cornerstone from \"cornerstone-core\";\nimport * as cornerstoneTools from \"cornerstone-tools\";\nimport * as cornerstoneMath from \"cornerstone-math\";\nimport * as cornerstoneFileImageLoader from \"cornerstone-file-image-loader\";\nimport * as cornerstoneWebImageLoader from \"cornerstone-web-image-loader\";\nimport * as cornerstoneWADOImageLoader from \"cornerstone-wado-image-loader\";\nimport * as dicomParser from 'dicom-parser';\nimport * as blobUtil from 'blob-util';\nimport { uids } from '../constants/uids';\nimport { SETTINGS_SAVEAS } from '../constants/settings';\nimport OpenUrlDlg from './OpenUrlDlg';\nimport CinePlayer from './CinePlayer';\nimport { isMobile } from 'react-device-detect';\nimport { import as csTools } from 'cornerstone-tools';\nimport db from '../db/db';\nimport fs from '../fs/fs';\nimport { clearStore, dcmIsOpen, activeDcm, dcmTool, activeMeasurements, doFsRefresh } from '../actions';\nimport { capitalize, getFileName, getSettingsOverlay, isFileImage, isFsFileImage, isUrlImage, getSettingsSaveInto } from '../functions';\nconst scrollToIndex = csTools('util/scrollToIndex');\n/*\nfunction getBlobUrl(url) {\n  const baseUrl = window.URL || window.webkitURL;\n  const blob = new Blob([`importScripts('${url}')`], {type: \"application/javascript\"});\n  return baseUrl.createObjectURL(blob);\n}\n\nlet webWorkerUrl = getBlobUrl(\n  \"https://unpkg.com/cornerstone-wado-image-loader@3.0.0/dist/cornerstoneWADOImageLoaderWebWorker.min.js\"\n)\nlet codecsUrl = getBlobUrl(\n  \"https://unpkg.com/cornerstone-wado-image-loader@3.0.0/dist/cornerstoneWADOImageLoaderCodecs.js\"\n  // \"https://unpkg.com/cornerstone-wado-image-loader/dist/cornerstoneWADOImageLoaderCodecs.js\"\n)\n// See componentDidMount line 110 for initialization, registration\n\nconst config = {\n  maxWebWorkers: 4, //\n  //startWebWorkersOnDemand: true, //\n  webWorkerPath: webWorkerUrl,\n  //webWorkerTaskPaths: [], //\n  taskConfiguration: {\n    decodeTask: {\n      //loadCodecsOnStartup: true, //\n      //initializeCodecsOnStartup: false, //\n      codecsPath: codecsUrl,\n      //usePDFJS: false, //\n      //strict: true //\n    }\n  }\n}\nvar config = {\n  maxWebWorkers: navigator.hardwareConcurrency || 1,\n  startWebWorkersOnDemand: false,\n}\n*/\n\ncornerstoneTools.external.cornerstone = cornerstone;\ncornerstoneTools.external.cornerstoneMath = cornerstoneMath;\ncornerstoneFileImageLoader.external.cornerstone = cornerstone;\ncornerstoneWebImageLoader.external.cornerstone = cornerstone;\ncornerstoneWADOImageLoader.external.cornerstone = cornerstone; //cornerstoneWADOImageLoader.webWorkerManager.initialize(config)\n\ncornerstoneWADOImageLoader.external.dicomParser = dicomParser;\ncornerstoneTools.external.Hammer = Hammer;\ncornerstoneTools.init(); //console.log({ cornerstone })\n//console.log({ cornerstoneWADOImageLoader })\n//console.log({ dicomParser })\n\nclass DicomViewer extends React.Component {\n  constructor(props) {\n    super(props);\n    this.state = {\n      visibleOpenUrlDlg: false,\n      progress: null,\n      visibleCinePlayer: false,\n      errorOnOpenImage: null,\n      errorOnCors: false,\n      frame: 1,\n      inPlay: false,\n      viewport: null\n    };\n\n    this.onOpenUrl = e => {\n      const eventData = e.detail;\n      this.setState({\n        progress: eventData.percentComplete\n      });\n    };\n\n    this.showOpenUrlDlg = url => {\n      this.setState({\n        visibleOpenUrlDlg: true\n      }, () => {\n        cornerstone.events.addEventListener('cornerstoneimageloadprogress', this.onOpenUrl);\n        this.loadImage(undefined, url);\n      });\n    };\n\n    this.hideOpenUrlDlg = () => {\n      this.setState({\n        visibleOpenUrlDlg: false,\n        progress: null\n      });\n    };\n\n    this.measurementSave = measure => {\n      this.measurements.push(measure);\n    };\n\n    this.measurementClear = () => {\n      this.measurements.splice(0, this.measurements.length);\n    };\n\n    this.measurementRemove = index => {\n      //console.log('this.measurements: ', this.measurements)\n      this.measurements.splice(index, 1);\n    };\n\n    this.getTransferSyntax = () => {\n      const value = this.image.data.string('x00020010');\n      return value + ' [' + uids[value] + ']';\n    };\n\n    this.getSopClass = () => {\n      const value = this.image.data.string('x00080016');\n      return value + ' [' + uids[value] + ']';\n    };\n\n    this.getSopInstanceUID = () => {\n      const value = this.image.data.string('x00080018');\n      return value;\n    };\n\n    this.getPixelRepresentation = () => {\n      const value = this.image.data.uint16('x00280103');\n      if (value === undefined) return;\n      return value + (value === 0 ? ' (unsigned)' : ' (signed)');\n    };\n\n    this.getPlanarConfiguration = () => {\n      const value = this.image.data.uint16('x00280006');\n      if (value === undefined) return;\n      return value + (value === 0 ? ' (pixel)' : ' (plane)');\n    };\n\n    this.onImageLoaded = e => {//console.log('cornerstoneimageloaded: ')\n    };\n\n    this.onImageRendered = e => {\n      //console.log('cornerstoneimagerendered: ', e.target)\n      //console.log('cornerstoneimagerendered, plane: ', this.mprPlane)\n      //const viewport = cornerstone.getViewport(this.dicomImage)\n      const viewport = cornerstone.getViewport(e.target); //console.log('viewport: ', viewport)\n      //if (this.props.activeDcm !== null)\n      //  console.log('viewport activeDcm: ', cornerstone.getViewport(this.props.activeDcm.element))\n\n      console.log(\"props.index : \", this.props.index);\n      document.getElementById(`mrtopleft-${this.props.index}`).textContent = this.mprIsOrthogonalView() ? `${capitalize(this.mprPlane)}` : `${this.PatientsName}`;\n      document.getElementById(`mrtopright-${this.props.index}`).textContent = `${viewport.displayedArea.brhc.x}x${viewport.displayedArea.brhc.y}`;\n      document.getElementById(`mrbottomleft-${this.props.index}`).textContent = `WW/WC: ${Math.round(viewport.voi.windowWidth)}/${Math.round(viewport.voi.windowCenter)}`;\n      document.getElementById(`mrbottomright-${this.props.index}`).textContent = `Zoom: ${Math.round(viewport.scale.toFixed(2) * 100)}%`;\n      document.getElementById(`mrtopcenter-${this.props.index}`).textContent = ``;\n      document.getElementById(`mrbottomcenter-${this.props.index}`).textContent = ``;\n      document.getElementById(`mrleftcenter-${this.props.index}`).textContent = ``;\n      document.getElementById(`mrrightcenter-${this.props.index}`).textContent = ``;\n\n      if (this.mprPlane === 'sagittal') {\n        document.getElementById(`mrtopcenter-${this.props.index}`).textContent = `S`;\n        document.getElementById(`mrbottomcenter-${this.props.index}`).textContent = `I`;\n        document.getElementById(`mrleftcenter-${this.props.index}`).textContent = `A`;\n        document.getElementById(`mrrightcenter-${this.props.index}`).textContent = `P`;\n      } else if (this.mprPlane === 'axial') {\n        document.getElementById(`mrtopcenter-${this.props.index}`).textContent = `A`;\n        document.getElementById(`mrbottomcenter-${this.props.index}`).textContent = `P`;\n        document.getElementById(`mrleftcenter-${this.props.index}`).textContent = `R`;\n        document.getElementById(`mrrightcenter-${this.props.index}`).textContent = `L`;\n      } else if (this.mprPlane === 'coronal') {\n        document.getElementById(`mrtopcenter-${this.props.index}`).textContent = `S`;\n        document.getElementById(`mrbottomcenter-${this.props.index}`).textContent = `I`;\n        document.getElementById(`mrleftcenter-${this.props.index}`).textContent = `R`;\n        document.getElementById(`mrrightcenter-${this.props.index}`).textContent = `L`;\n      }\n\n      if (this.isDicom && this.state.visibleCinePlayer && this.numberOfFrames > 1) {\n        document.getElementById(`frameLabel-${this.props.index}`).textContent = `${this.state.frame} / ${this.numberOfFrames}`;\n\n        if (this.state.inPlay) {\n          let frame = this.state.frame === this.numberOfFrames ? 1 : this.state.frame + 1;\n          this.setState({\n            frame: frame\n          });\n        }\n      }\n    };\n\n    this.onMeasurementModified = e => {//console.log('cornerstonetoolsmeasurementmodified: ', e.detail.measurementData)\n    };\n\n    this.onMeasurementAdded = e => {\n      //console.log('cornerstonetoolsmeasurementadded: ', e.detail.measurementData)\n      if (this.props.tool !== \"Angle\") return;\n      const measure = {\n        tool: this.props.tool,\n        note: '',\n        data: e.detail.measurementData\n      };\n      this.measurementSave(measure);\n      this.props.setActiveMeasurements(this.measurements);\n    };\n\n    this.onMeasurementCompleted = e => {\n      //console.log('cornerstonetoolsmeasurementcompleted: ', e.detail.measurementData)\n      const measure = {\n        tool: this.props.tool,\n        note: '',\n        data: e.detail.measurementData\n      };\n\n      if (this.props.tool === \"FreehandRoi\") {\n        setTimeout(() => {\n          this.measurementSave(measure);\n          this.props.setActiveMeasurements(this.measurements);\n        }, 500);\n      } else {\n        this.measurementSave(measure);\n        this.props.setActiveMeasurements(this.measurements);\n      }\n    };\n\n    this.onErrorOpenImageClose = () => {\n      this.setState({\n        errorOnOpenImage: null\n      });\n    };\n\n    this.onErrorCorsClose = () => {\n      this.setState({\n        errorOnCors: false\n      });\n    };\n\n    this.displayImageFromFilesByImage = (index, image) => {\n      const element = this.dicomImage;\n      cornerstone.enable(element);\n      cornerstone.displayImage(element, image);\n    };\n\n    this.displayImageFromFiles = index => {\n      // console.log('displayImageFromFiles: ', index);\n      // console.log('files: ', this.props.files);\n      const image = this.props.files[index].image;\n      const imageId = this.props.files[index].imageId;\n      this.filename = this.props.files[index].name;\n      const element = this.dicomImage;\n      element.addEventListener(\"cornerstonenewimage\", this.onNewImage);\n      element.addEventListener(\"cornerstoneimagerendered\", this.onImageRendered);\n      element.addEventListener(\"cornerstonetoolsmeasurementadded\", this.onMeasurementAdded);\n      element.addEventListener(\"cornerstonetoolsmeasurementmodified\", this.onMeasurementModified);\n      element.addEventListener(\"cornerstonetoolsmeasurementcompleted\", this.onMeasurementCompleted);\n      cornerstone.enable(element);\n      this.image = image;\n      this.isDicom = true;\n      this.PatientsName = image.data.string('x00100010');\n      this.sopInstanceUid = this.getSopInstanceUID();\n      let stack = {\n        currentImageIdIndex: 0,\n        imageIds: \"\"\n      };\n      this.numberOfFrames = image.data.intString('x00280008');\n\n      if (this.numberOfFrames > 0) {\n        let imageIds = [];\n\n        for (var i = 0; i < this.numberOfFrames; ++i) {\n          imageIds.push(imageId + \"?frame=\" + i);\n        }\n\n        stack.imageIds = imageIds;\n      }\n\n      cornerstone.displayImage(element, image);\n      /*const viewport = cornerstone.getViewport(this.dicomImage)\n      const lut =  cornerstone.generateLut(this.image, viewport.voi.windowWidth, viewport.voi.windowCenter, viewport.invert, viewport.modalityLUT, viewport.voiLUT)\n      this.props.setLutStore(lut)*/\n\n      this.mprPlanePosition();\n      this.enableTool();\n\n      if (this.numberOfFrames > 1) {\n        cornerstoneTools.addStackStateManager(element, ['stack', 'playClip']);\n        cornerstoneTools.addToolState(element, 'stack', stack);\n        this.setState({\n          frame: 1\n        });\n      } // Load the possible measurements from DB and save in the store \n\n\n      db.measurement.where('sopinstanceuid').equals(this.sopInstanceUid).each(measure => {\n        console.log('load measure from db: ', measure);\n        this.measurementSave(measure);\n        cornerstoneTools.addToolState(element, measure.tool, measure.data);\n        this.runTool(measure.tool);\n        cornerstone.updateImage(element);\n        cornerstoneTools.setToolEnabled(measure.tool);\n      }).then(() => {\n        this.props.setActiveMeasurements(this.measurements);\n        this.props.setActiveDcm({\n          image: this.image,\n          element: this.dicomImage,\n          isDicom: this.isDicom\n        });\n        this.props.setIsOpenStore({\n          index: this.props.index,\n          value: true\n        });\n      }); //this.overlayImage()\n    };\n\n    this.loadImageFromCanvas = canvas => {\n      console.log('loadImageFromCanvas, dcmViewer: ', this.props.index);\n      const element = this.dicomImage;\n      element.addEventListener(\"cornerstonenewimage\", this.onNewImage);\n      element.addEventListener(\"cornerstoneimagerendered\", this.onImageRendered);\n      element.addEventListener(\"cornerstonetoolsmeasurementadded\", this.onMeasurementAdded);\n      element.addEventListener(\"cornerstonetoolsmeasurementmodified\", this.onMeasurementModified);\n      element.addEventListener(\"cornerstonetoolsmeasurementcompleted\", this.onMeasurementCompleted);\n      cornerstone.enable(element);\n      const imageId = cornerstoneFileImageLoader.fileManager.addCanvas(canvas);\n      cornerstone.loadImage(imageId).then(image => {\n        //this.t1 = performance.now()\n        //console.log(`performance load image: ${this.t1-this.t0} milliseconds`)\n        console.log('loadImageFromCanvas, image: ', image);\n        this.image = image;\n        this.isDicom = false;\n        cornerstone.displayImage(element, image);\n        this.enableTool(); //this.props.setActiveDcm({image: this.image, element: this.dicomImage, isDicom: this.isDicom})\n\n        this.props.setIsOpenStore({\n          index: this.props.index,\n          value: true\n        }); //this.t2 = performance.now()\n        //console.log(`performance: ${this.t2-this.t1} milliseconds`)\n        //this.overlayImage()\n      }, e => {\n        console.log('error', e);\n        this.setState({\n          errorOnOpenImage: \"This is not a valid canvas.\"\n        });\n      });\n    };\n\n    this.loadImageFromCustomObject = (columns, rows, pixelData) => {\n      //console.log('loadImageFromCustomObject: ')\n      const element = this.dicomImage;\n      element.addEventListener(\"cornerstonenewimage\", this.onNewImage);\n      element.addEventListener(\"cornerstoneimagerendered\", this.onImageRendered);\n      element.addEventListener(\"cornerstonetoolsmeasurementadded\", this.onMeasurementAdded);\n      element.addEventListener(\"cornerstonetoolsmeasurementmodified\", this.onMeasurementModified);\n      element.addEventListener(\"cornerstonetoolsmeasurementcompleted\", this.onMeasurementCompleted);\n      cornerstone.enable(element);\n      let customObj = {\n        rows: rows,\n        columns: columns,\n        pixelData: pixelData,\n        image: this.originImage\n      };\n      const imageId = cornerstoneFileImageLoader.fileManager.addCustom(customObj);\n      cornerstone.loadImage(imageId).then(image => {\n        //console.log('loadImageFromCustomObject, image: ', image)\n        this.image = image;\n        this.isDicom = true;\n        cornerstone.displayImage(element, image); //this.enableTool()\n\n        this.props.setIsOpenStore({\n          index: this.props.index,\n          value: true\n        });\n      }, e => {\n        console.log('error', e);\n        this.setState({\n          errorOnOpenImage: \"This is not a valid canvas.\"\n        });\n      });\n    };\n\n    this.loadImage = (localfile, url = undefined, fsItem = undefined) => {\n      console.log('loadImage, localfile: ', localfile);\n      console.log('loadImage, fsItem: ', fsItem);\n      console.log('loadImage, url: ', url);\n      if (localfile === undefined && url === undefined && fsItem === undefined) return;\n\n      if (fsItem !== undefined) {\n        this.fsItem = fsItem;\n      } else if (localfile !== undefined) {\n        this.localfile = localfile;\n      } else {\n        this.localurl = url;\n      }\n\n      const element = this.dicomImage;\n      element.addEventListener(\"cornerstonenewimage\", this.onNewImage);\n      element.addEventListener(\"cornerstoneimagerendered\", this.onImageRendered);\n      element.addEventListener(\"cornerstonetoolsmeasurementadded\", this.onMeasurementAdded);\n      element.addEventListener(\"cornerstonetoolsmeasurementmodified\", this.onMeasurementModified);\n      element.addEventListener(\"cornerstonetoolsmeasurementcompleted\", this.onMeasurementCompleted);\n      let imageId = undefined;\n      cornerstone.enable(element);\n      let size = 0;\n\n      if (localfile === undefined && isUrlImage(url)) {\n        // check if it's a simple image [jpeg or png] from url\n        //console.log('image: ', file)\n        cornerstone.loadImage(url).then(image => {\n          //console.log('loadImage, image from url: ', image)\n          this.hideOpenUrlDlg();\n          this.image = image;\n          this.isDicom = false;\n          cornerstone.displayImage(element, image);\n          this.enableTool();\n          this.props.setActiveDcm({\n            image: this.image,\n            element: this.dicomImage,\n            isDicom: this.isDicom\n          });\n          this.props.isOpenStore(true);\n        }, e => {\n          console.log('error', e);\n          this.setState({\n            errorOnOpenImage: \"This is not a valid JPG or PNG file.\"\n          });\n        });\n      } else if (localfile !== undefined && isFileImage(localfile) || fsItem !== undefined && isFsFileImage(fsItem)) {\n        // otherwise try to open as local image file (JPEG, PNG) \n        if (fsItem !== undefined) {\n          imageId = cornerstoneFileImageLoader.fileManager.addBuffer(fsItem.data);\n        } else {\n          imageId = cornerstoneFileImageLoader.fileManager.add(localfile);\n        }\n\n        cornerstone.loadImage(imageId).then(image => {\n          // console.log('loadImage, image from local: ', image);\n          this.image = image;\n          this.isDicom = false;\n          this.PatientsName = ''; // console.log(\"image data:\" + image.data);\n\n          cornerstone.displayImage(element, image);\n          this.enableTool();\n          this.props.setActiveDcm({\n            image: this.image,\n            element: this.dicomImage,\n            isDicom: this.isDicom\n          }); //this.props.isOpenStore(true)\n\n          this.props.setIsOpenStore({\n            index: this.props.index,\n            value: true\n          });\n        }, e => {\n          console.log('error', e);\n          this.setState({\n            errorOnOpenImage: \"This is not a valid JPG or PNG file.\"\n          });\n        });\n      } else {\n        // otherwise try to open as Dicom file\n        if (fsItem !== undefined) {\n          imageId = cornerstoneWADOImageLoader.wadouri.fileManager.addBuffer(fsItem.data);\n          this.filename = fsItem.name;\n          size = fsItem.size;\n        } else if (localfile !== undefined) {\n          imageId = cornerstoneWADOImageLoader.wadouri.fileManager.add(localfile);\n          this.filename = localfile.name;\n          size = localfile.size;\n        } else {\n          // it's a web dicom image\n          imageId = \"wadouri:\" + url;\n        } // console.log('loadImage, imageId: ', imageId);\n\n\n        cornerstone.loadAndCacheImage(imageId).then(image => {\n          console.log('loadImage, image: ', image); // let pixelDataElement = image.data.elements.x7fe00010;\n          // console.log('loadImage, pixelDataElement: ', pixelDataElement);\n          // console.log('loadImage, getPixelData: ', image.getPixelData());\n\n          this.hideOpenUrlDlg();\n          this.image = image;\n          this.isDicom = true;\n          let dataSet = dicomParser.parseDicom(image.data.byteArray);\n          console.log('image dataset -----: ' + dataSet.string('x00200011'));\n          console.log('Series Number: ' + image.data.string('x00200011'));\n          this.PatientsName = image.data.string('x00100010');\n          console.log('PatientsName: ' + this.PatientsName);\n          this.sopInstanceUid = this.getSopInstanceUID();\n          let stack = {\n            currentImageIdIndex: 0,\n            imageIds: \"\"\n          };\n          this.numberOfFrames = image.data.intString('x00280008');\n\n          if (this.numberOfFrames > 0) {\n            let imageIds = [];\n\n            for (var i = 0; i < this.numberOfFrames; ++i) {\n              imageIds.push(imageId + \"?frame=\" + i);\n            }\n\n            stack.imageIds = imageIds;\n          }\n\n          cornerstone.displayImage(element, image); //cornerstoneTools.mouseInput.enable(element);\n          //cornerstoneTools.mouseWheelInput.enable(element);\n\n          this.enableTool();\n          /*const viewport = cornerstone.getViewport(this.dicomImage)\n          const lut =  cornerstone.generateLut(this.image, viewport.voi.windowWidth, viewport.voi.windowCenter, viewport.invert, viewport.modalityLUT, viewport.voiLUT)\n          console.log('lut: ', lut)*/\n\n          if (this.numberOfFrames > 1) {\n            cornerstoneTools.addStackStateManager(element, ['stack', 'playClip']);\n            cornerstoneTools.addToolState(element, 'stack', stack); //cornerstoneTools.setToolActive('StackScrollMouseWheel', { })\n\n            this.setState({\n              frame: 1\n            });\n          } // Load the possible measurements from DB and save in the store \n\n\n          db.measurement.where('sopinstanceuid').equals(this.sopInstanceUid).each(measure => {\n            console.log('load measure from db: ', measure); //this.props.measurementStore(measure)\n\n            this.measurementSave(measure);\n            cornerstoneTools.addToolState(element, measure.tool, measure.data);\n            this.runTool(measure.tool);\n            cornerstone.updateImage(element);\n            cornerstoneTools.setToolEnabled(measure.tool);\n          }).then(() => {\n            //console.log('this.measurements: ', this.measurements)\n            this.props.setActiveMeasurements(this.measurements);\n            this.props.setActiveDcm({\n              name: this.filename,\n              size: size,\n              image: this.image,\n              element: this.dicomImage,\n              isDicom: this.isDicom\n            });\n            this.props.setIsOpenStore({\n              index: this.props.index,\n              value: true\n            });\n          });\n        }, e => {\n          console.log('error', e);\n          this.hideOpenUrlDlg(); //console.log('toString: ', e.error.toString())\n\n          const error = e.error.toString();\n\n          if (error === '[object XMLHttpRequest]') {\n            this.setState({\n              errorOnCors: true\n            });\n          } else {\n            const pos = error.indexOf(\":\");\n            this.setState({\n              errorOnOpenImage: pos < 0 ? e.error : error.substring(pos + 1)\n            });\n          }\n        });\n      }\n    };\n\n    this.enableTool = (toolName, mouseButtonNumber) => {\n      // Enable all tools we want to use with this element\n      const WwwcTool = cornerstoneTools.WwwcTool;\n      const LengthTool = cornerstoneTools['LengthTool'];\n      const PanTool = cornerstoneTools.PanTool;\n      const ZoomTouchPinchTool = cornerstoneTools.ZoomTouchPinchTool;\n      const ZoomTool = cornerstoneTools.ZoomTool;\n      const ProbeTool = cornerstoneTools.ProbeTool;\n      const EllipticalRoiTool = cornerstoneTools.EllipticalRoiTool;\n      const RectangleRoiTool = cornerstoneTools.RectangleRoiTool;\n      const FreehandRoiTool = cornerstoneTools.FreehandRoiTool;\n      const AngleTool = cornerstoneTools.AngleTool;\n      const MagnifyTool = cornerstoneTools.MagnifyTool;\n      const StackScrollMouseWheelTool = cornerstoneTools.StackScrollMouseWheelTool;\n      cornerstoneTools.addTool(MagnifyTool);\n      cornerstoneTools.addTool(AngleTool);\n      cornerstoneTools.addTool(WwwcTool);\n      cornerstoneTools.addTool(LengthTool);\n      cornerstoneTools.addTool(PanTool);\n      cornerstoneTools.addTool(ZoomTouchPinchTool);\n      cornerstoneTools.addTool(ZoomTool);\n      cornerstoneTools.addTool(ProbeTool);\n      cornerstoneTools.addTool(EllipticalRoiTool);\n      cornerstoneTools.addTool(RectangleRoiTool);\n      cornerstoneTools.addTool(FreehandRoiTool);\n      cornerstoneTools.addTool(StackScrollMouseWheelTool);\n    };\n\n    this.disableAllTools = () => {\n      cornerstoneTools.setToolEnabled('Length');\n      cornerstoneTools.setToolEnabled('Pan');\n      cornerstoneTools.setToolEnabled('Magnify');\n      cornerstoneTools.setToolEnabled('Angle');\n      cornerstoneTools.setToolEnabled('RectangleRoi');\n      cornerstoneTools.setToolEnabled('Wwwc');\n      cornerstoneTools.setToolEnabled('ZoomTouchPinch');\n      cornerstoneTools.setToolEnabled('Probe');\n      cornerstoneTools.setToolEnabled('EllipticalRoi');\n      cornerstoneTools.setToolEnabled('FreehandRoi');\n      cornerstoneTools.setToolEnabled('StackScrollMouseWheel');\n    };\n\n    this.runTool2 = (index, image) => {\n      cornerstone.disable(this.dicomImage);\n      this.displayImageFromFilesByImage(index, image);\n    };\n\n    this.runTool = (toolName, opt) => {\n      //console.log('run tool: ', toolName)\n      // this.disableAllTools()\n      switch (toolName) {\n        case 'openImage':\n          {\n            cornerstone.disable(this.dicomImage); // this.displayImageFromFilesByImage(opt);\n\n            break;\n          }\n\n        case 'openimage':\n          {\n            //console.log('openimage: ', opt)\n            //console.log('openimage, this.dicomImage: ', this.dicomImage)\n            cornerstone.disable(this.dicomImage);\n            this.displayImageFromFiles(opt);\n            break;\n          }\n\n        case 'openLocalFs':\n          {\n            console.log('openLocalFs: ', opt);\n            cornerstone.disable(this.dicomImage);\n            this.loadImage(opt);\n            break;\n          }\n\n        case 'openSandboxFs':\n          {\n            //console.log('openSandboxFs: ', opt)\n            cornerstone.disable(this.dicomImage); //this.setState({ file: opt })\n\n            this.loadImage(undefined, undefined, opt);\n            break;\n          }\n\n        case 'openurl':\n          {\n            //console.log('run tool opt: ', opt)  \n            this.showOpenUrlDlg(opt);\n            break;\n          }\n\n        case 'clear':\n          {\n            this.setState({\n              visibleCinePlayer: false\n            });\n            this.mprPlane = ''; //this.props.clearingStore()\n\n            cornerstone.disable(this.dicomImage);\n            break;\n          }\n\n        case 'notool':\n          {\n            this.disableAllTools(); //const element = this.dicomImage\n            //cornerstoneTools.clearToolState(element, 'Length')\n            //const toolStateManager = cornerstoneTools.getElementToolStateManager(element)\n            //console.log('toolStateManager.toolState: ', toolStateManager.toolState)\n\n            /*\n            const toolState = toolStateManager.toolState\n            // const allTools = Object.keys(toolState).map(key => toolState[key])\n            let key = Object.keys(toolState)[0]\n            let allTools = toolState[key]\n            //console.log('allTools: ', allTools)\n             for (let [tool, data] of Object.entries(allTools)) {\n              //console.log(`${tool}: `, data)\n              let key = Object.keys(data)[0]\n              let tools = data[key]\n              //console.log('tools: ', tools)\n              tools.forEach(item => {\n                //console.log('tool: ', tool)\n                //console.log(item)\n                const measure = {\n                  tool: tool,\n                  note: '',\n                  data: item\n                }\n                console.log('measure: ', measure)\n                this.props.measurementStore(measure)\n              })\n            }\n            */\n            //const toolState = toolStateManager.get(element, 'Length')\n            //console.log('toolState: ', toolState)\n\n            /*\n            const measurementData = {\n              visible: true,\n              active: true,\n              invalidated: true,\n              handles: {\n                  start: {\n                      x: 100,\n                      y: 100,\n                      highlight: true,\n                      active: false\n                  },\n                  end: {\n                      x: 200,\n                      y: 200,\n                      highlight: true,\n                      active: true\n                  },\n                  textBox: {\n                      active: false,\n                      hasMoved: false,\n                      movesIndependently: false,\n                      drawnIndependently: true,\n                      allowedOutsideImage: true,\n                      hasBoundingBox: true\n                  }\n                }\n            }\n            cornerstoneTools.addToolState(element, 'RectangleRoi', measurementData)    \n            cornerstoneTools.setToolActive('RectangleRoi', { mouseButtonMask: 1 })\n            */\n            //cornerstone.updateImage(element)   \n\n            break;\n          }\n\n        case 'Wwwc':\n          {\n            cornerstoneTools.setToolActive('Wwwc', {\n              mouseButtonMask: 1\n            });\n            break;\n          }\n\n        case 'Pan':\n          {\n            cornerstoneTools.setToolActive('Pan', {\n              mouseButtonMask: 1\n            });\n            break;\n          }\n\n        case 'Zoom':\n          {\n            cornerstoneTools.setToolActive(isMobile ? 'ZoomTouchPinch' : 'Zoom', {\n              mouseButtonMask: 1\n            });\n            break;\n          }\n\n        case 'Length':\n          {\n            cornerstoneTools.setToolActive('Length', isMobile ? {\n              isTouchActive: true\n            } : {\n              mouseButtonMask: 1\n            });\n            break;\n          }\n\n        case 'Probe':\n          {\n            cornerstoneTools.setToolActive('Probe', {\n              mouseButtonMask: 1\n            });\n            break;\n          }\n\n        case 'EllipticalRoi':\n          {\n            cornerstoneTools.setToolActive('EllipticalRoi', {\n              mouseButtonMask: 1\n            });\n            break;\n          }\n\n        case 'RectangleRoi':\n          {\n            cornerstoneTools.setToolActive('RectangleRoi', {\n              mouseButtonMask: 1\n            });\n            break;\n          }\n\n        case 'Angle':\n          {\n            cornerstoneTools.setToolActive('Angle', {\n              mouseButtonMask: 1\n            });\n            break;\n          }\n\n        case 'Magnify':\n          {\n            cornerstoneTools.setToolActive('Magnify', {\n              mouseButtonMask: 1\n            });\n            break;\n          }\n\n        case 'FreehandRoi':\n          {\n            cornerstoneTools.setToolActive('FreehandRoi', {\n              mouseButtonMask: 1\n            });\n            break;\n          }\n\n        case 'Invert':\n          {\n            const element = this.dicomImage;\n            const viewport = cornerstone.getViewport(element);\n            viewport.invert = !viewport.invert;\n            cornerstone.setViewport(element, viewport);\n            break;\n          }\n\n        case 'saveas':\n          {\n            let type = localStorage.getItem(SETTINGS_SAVEAS);\n\n            if (getSettingsSaveInto() === 'local') {\n              // cornerstoneTools.SaveAs(this.dicomImage, `${this.filename}.${type}`, `image/${type}`)   \n              const element = this.dicomImage;\n              const viewport = cornerstone.getViewport(element);\n              const canvas = document.getElementsByClassName('cornerstone-canvas')[this.props.activeDcmIndex];\n              const zoom = viewport.scale.toFixed(2);\n              const cols = this.image.columns * zoom;\n              const rows = this.image.rows * zoom;\n              let myCanvas = document.createElement('canvas');\n              myCanvas = this.cropCanvas(canvas, Math.round(canvas.width / 2 - cols / 2), Math.round(canvas.height / 2 - rows / 2), cols, rows);\n              let a = document.createElement(\"a\");\n              a.href = myCanvas.toDataURL(`image/${type}`);\n              a.download = `${this.filename}.${type}`;\n              document.body.appendChild(a); // Required for this to work in FireFox\n\n              a.click();\n            } else {\n              // store image into sandbox file system\n              const element = this.dicomImage;\n              const viewport = cornerstone.getViewport(element);\n              const canvas = document.getElementsByClassName('cornerstone-canvas')[this.props.activeDcmIndex];\n              const zoom = viewport.scale.toFixed(2);\n              const cols = this.image.columns * zoom;\n              const rows = this.image.rows * zoom;\n              let myCanvas = document.createElement('canvas');\n              myCanvas = this.cropCanvas(canvas, Math.round(canvas.width / 2 - cols / 2), Math.round(canvas.height / 2 - rows / 2), cols, rows);\n              blobUtil.canvasToBlob(myCanvas, `image/${type}`).then(blob => {\n                blobUtil.blobToArrayBuffer(blob).then(arrayBuffer => {\n                  const name = `${getFileName(this.filename)}-MPR-${this.mprPlane}`;\n                  let newName = name;\n                  let counter = 1;\n                  let done = false;\n\n                  do {\n                    let filename = `${newName}.${type}`;\n                    const checkName = this.props.fsCurrentList.find(e => e.name === filename);\n\n                    if (checkName === undefined) {\n                      fs.transaction('rw', fs.files, async () => {\n                        await fs.files.add({\n                          parent: this.props.fsCurrentDir,\n                          name: filename,\n                          type: type,\n                          size: arrayBuffer.byteLength,\n                          data: arrayBuffer\n                        });\n                      }).then(() => {\n                        this.props.makeFsRefresh();\n                      });\n                      done = true;\n                    } else {\n                      newName = `${name} - ${counter}`;\n                      counter++;\n                    }\n                  } while (!done);\n                });\n              });\n            }\n\n            break;\n          }\n\n        case 'cine':\n          {\n            this.setState({\n              visibleCinePlayer: !this.state.visibleCinePlayer\n            });\n            break;\n          }\n\n        case 'reset':\n          {\n            this.reset();\n            break;\n          }\n\n        case 'removetool':\n          {\n            console.log('removetool index: ', opt);\n            const element = this.dicomImage;\n            cornerstoneTools.removeToolState(element, this.measurements[opt].tool, this.measurements[opt].data);\n            cornerstone.updateImage(element); //this.props.measurementRemoveStore(opt)\n\n            this.measurementRemove(opt);\n            this.props.setActiveMeasurements(this.measurements);\n            break;\n          }\n\n        case 'removetools':\n          {\n            const element = this.dicomImage; // for each measurement remove it \n\n            this.measurements.forEach(measure => {\n              cornerstoneTools.clearToolState(element, measure.tool);\n            });\n            cornerstone.updateImage(element);\n            this.measurementClear(); // also remove all measurements from db\n\n            db.measurement.where('sopinstanceuid').equals(this.sopInstanceUid).delete();\n            this.props.setActiveMeasurements(this.measurements);\n            break;\n          }\n\n        case 'savetools':\n          {\n            // first, remove eventually previous measurements from db\n            db.measurement.where('sopinstanceuid').equals(this.sopInstanceUid).delete(); // then save all the current measurements\n\n            this.measurements.forEach(measure => {\n              try {\n                db.measurement.add({\n                  sopinstanceuid: this.sopInstanceUid,\n                  tool: measure.tool,\n                  note: measure.note,\n                  data: measure.data\n                });\n              } catch (error) {\n                console.error(error);\n              }\n            });\n            break;\n          }\n\n        default:\n          {\n            break;\n          }\n      }\n    };\n\n    this.cropCanvas = (canvas, x, y, width, height) => {\n      console.log(`canvas: ${canvas.width}, ${canvas.height}`);\n      console.log(`x, y: ${x}, ${y}`);\n      console.log(`width, height: ${width}, ${height}`); // create a temp canvas\n\n      const newCanvas = document.createElement('canvas'); // set its dimensions\n\n      newCanvas.width = width;\n      newCanvas.height = height; // draw the canvas in the new resized temp canvas \n\n      newCanvas.getContext('2d').drawImage(canvas, x, y, width, height, 0, 0, width, height);\n      return newCanvas;\n    };\n\n    this.changeTool = (toolName, value) => {\n      console.log('change tool, value: ', toolName, value);\n\n      switch (toolName) {\n        case 'Wwwc':\n          if (value === 1) {\n            cornerstoneTools.setToolActive('Wwwc', {\n              mouseButtonMask: 1\n            });\n          } else if (value === 0) {\n            cornerstoneTools.setToolPassive('Wwwc');\n          }\n\n          break;\n\n        case 'Pan':\n          if (value === 1) {\n            cornerstoneTools.setToolActive('Pan', {\n              mouseButtonMask: 1\n            });\n          } else if (value === 0) {\n            cornerstoneTools.setToolPassive('Pan');\n          }\n\n          break;\n\n        case 'Zoom':\n          if (value === 1) {\n            cornerstoneTools.setToolActive(isMobile ? 'ZoomTouchPinch' : 'Zoom', {\n              mouseButtonMask: 1\n            });\n          } else if (value === 0) {\n            cornerstoneTools.setToolPassive(isMobile ? 'ZoomTouchPinch' : 'Zoom');\n          }\n\n          break;\n\n        case 'Length':\n          if (value === 1) {\n            cornerstoneTools.setToolActive('Length', isMobile ? {\n              isTouchActive: true\n            } : {\n              mouseButtonMask: 1\n            });\n          } else if (value === 0) {\n            cornerstoneTools.setToolPassive('Length');\n          }\n\n          break;\n\n        case 'Probe':\n          if (value === 1) {\n            cornerstoneTools.setToolActive('Probe', {\n              mouseButtonMask: 1\n            });\n          } else if (value === 0) {\n            cornerstoneTools.setToolPassive('Probe');\n          }\n\n          break;\n\n        case 'Angle':\n          if (value === 1) {\n            cornerstoneTools.setToolActive('Angle', {\n              mouseButtonMask: 1\n            });\n          } else if (value === 0) {\n            cornerstoneTools.setToolPassive('Angle');\n          }\n\n          break;\n\n        case 'Magnify':\n          if (value === 1) {\n            cornerstoneTools.setToolActive('Magnify', {\n              mouseButtonMask: 1\n            });\n          } else if (value === 0) {\n            cornerstoneTools.setToolPassive('Magnify');\n          }\n\n          break;\n\n        case 'EllipticalRoi':\n          if (value === 1) {\n            cornerstoneTools.setToolActive('EllipticalRoi', {\n              mouseButtonMask: 1\n            });\n          } else if (value === 0) {\n            cornerstoneTools.setToolPassive('EllipticalRoi');\n          }\n\n          break;\n\n        case 'RectangleRoi':\n          if (value === 1) {\n            cornerstoneTools.setToolActive('RectangleRoi', {\n              mouseButtonMask: 1\n            });\n          } else if (value === 0) {\n            cornerstoneTools.setToolPassive('RectangleRoi');\n          }\n\n          break;\n\n        case 'FreehandRoi':\n          if (value === 1) {\n            cornerstoneTools.setToolActive('FreehandRoi', {\n              mouseButtonMask: 1\n            });\n          } else if (value === 0) {\n            cornerstoneTools.setToolPassive('FreehandRoi');\n          }\n\n          break;\n\n        default:\n          break;\n      }\n    };\n\n    this.runCinePlayer = cmdName => {\n      //console.log('this.state.frame: ', this.state.frame)\n      const element = this.dicomImage;\n\n      switch (cmdName) {\n        case 'firstframe':\n          {\n            let frame = 1;\n            this.setState({\n              frame: frame\n            });\n            scrollToIndex(element, 0);\n            break;\n          }\n\n        case 'previousframe':\n          {\n            if (this.state.frame > 1) {\n              let frame = this.state.frame - 1;\n              this.setState({\n                frame: frame\n              });\n              scrollToIndex(element, frame - 1);\n            }\n\n            break;\n          }\n\n        case 'play':\n          {\n            cornerstoneTools.playClip(element, 30);\n            this.setState({\n              inPlay: true\n            });\n            break;\n          }\n\n        case 'pause':\n          {\n            cornerstoneTools.stopClip(element);\n            this.setState({\n              inPlay: false\n            });\n            break;\n          }\n\n        case 'nextframe':\n          {\n            if (this.state.frame < this.numberOfFrames) {\n              let frame = this.state.frame + 1;\n              this.setState({\n                frame: frame\n              });\n              scrollToIndex(element, frame - 1);\n            }\n\n            break;\n          }\n\n        case 'lastframe':\n          {\n            let frame = this.numberOfFrames;\n            this.setState({\n              frame: frame\n            });\n            scrollToIndex(element, frame - 1);\n            break;\n          }\n\n        default:\n          break;\n      }\n    };\n\n    this.reset = () => {\n      const element = this.dicomImage;\n      const defaultViewport = cornerstone.getDefaultViewportForImage(element, this.image);\n      let viewport = cornerstone.getViewport(element);\n      viewport.voi.windowWidth = defaultViewport.voi.windowWidth;\n      viewport.voi.windowCenter = defaultViewport.voi.windowCenter;\n      viewport.invert = false;\n      cornerstone.setViewport(element, viewport);\n    };\n\n    this.mprPlanePosition = () => {\n      //console.log(\"mprPlanePosition: \")\n      try {\n        if (!this.isDicom) return this.mprPlane; // console.log(\"image data:\" + this.image.data);\n\n        const imageOrientation = this.image.data.string('x00200037').split('\\\\');\n        let v = new Array(6).fill(0);\n        v[0] = parseFloat(imageOrientation[0]); // the x direction cosines of the first row X\n\n        v[1] = parseFloat(imageOrientation[1]); // the y direction cosines of the first row X\n\n        v[2] = parseFloat(imageOrientation[2]); // the z direction cosines of the first row X\n\n        v[3] = parseFloat(imageOrientation[3]); // the x direction cosines of the first column Y\n\n        v[4] = parseFloat(imageOrientation[4]); // the y direction cosines of the first column Y\n\n        v[5] = parseFloat(imageOrientation[5]); // the z direction cosines of the first column Y\n\n        v = v.map(x => Math.round(x));\n        let p = [v[1] * v[5] - v[2] * v[4], v[2] * v[3] - v[0] * v[5], v[0] * v[4] - v[1] * v[3]]; // cross product of X x Y\n\n        p = p.map(x => Math.abs(x));\n\n        if (p[0] === 1) {\n          this.mprPlane = 'sagittal';\n        } else if (p[1] === 1) {\n          this.mprPlane = 'coronal';\n        } else if (p[2] === 1) {\n          this.mprPlane = 'axial';\n        }\n      } catch (error) {\n        // it's not possible to build MPR\n        this.mprPlane = '';\n      }\n\n      return this.mprPlane;\n    };\n\n    this.transpose = matrix => {\n      return Object.keys(matrix[0]).map(colNumber => matrix.map(rowNumber => rowNumber[colNumber]));\n    };\n\n    this.mprRenderYZPlane = (filename, origin, x, mprData) => {\n      if (this.volume === null) return;\n      this.filename = filename;\n      cornerstone.disable(this.dicomImage); //console.log(`mprRenderYZPlane, origin: ${origin}, x: ${x}`)\n      //console.log('mprRenderYZPlane, volume: ', this.volume)\n\n      if (origin === 'sagittal') this.mprPlane = 'coronal';else if (origin === 'axial') this.mprPlane = 'sagittal';else this.mprPlane = 'sagittal';\n      this.xSize = this.props.files[0].columns;\n      this.ySize = this.props.files[0].rows;\n      this.zSize = mprData.zDim;\n      const i = Math.round(x / this.xSize * this.props.files.length);\n      this.originImage = this.props.files[i].image;\n\n      if (origin === 'sagittal') {\n        let xoffset = Math.floor(this.xSize / 2) - Math.floor(this.zSize / 2);\n        let plane = new Int16Array(this.xSize * this.ySize);\n\n        for (let y = 0; y < this.ySize; y++) for (let z = 0; z < this.zSize; z++) plane[z + this.ySize * y + xoffset] = this.volume[z][x + this.ySize * y];\n\n        this.loadImageFromCustomObject(this.xSize, this.ySize, plane);\n      } else if (origin === 'coronal') {\n        let xoffset = Math.floor(this.xSize / 2) - Math.floor(this.zSize / 2);\n        let plane = new Int16Array(this.xSize * this.ySize);\n\n        for (let y = 0; y < this.ySize; y++) for (let z = 0; z < this.zSize; z++) plane[z + this.ySize * y + xoffset] = this.volume[z][x + this.ySize * y];\n\n        this.loadImageFromCustomObject(this.xSize, this.ySize, plane);\n      } else {\n        // axial\n        const yzPlane = this.mprBuildYZPlane(x);\n        this.loadImageFromCustomObject(this.ySize, this.zSize, yzPlane);\n      }\n    };\n\n    this.mprBuildYZPlane = x => {\n      //console.log(`mprBuildYZPlane, ySize: ${this.ySize}, zSize: ${this.zSize} `)\n      let plane = new Int16Array(this.ySize * this.zSize);\n\n      for (var y = 0; y < this.ySize; y++) for (var z = 0; z < this.zSize; z++) plane[y + this.ySize * z] = this.volume[z][x + this.ySize * y]; //console.log('mprBuildYZPlane, plane: ', plane)\n\n\n      return plane;\n    };\n\n    this.mprRenderXZPlane = (filename, origin, y, mprData) => {\n      if (this.volume === null) return;\n      this.filename = filename;\n      cornerstone.disable(this.dicomImage); //console.log(`mprRenderXZPlane, origin: ${origin}, y: ${y}`)\n      //console.log('mprRenderXZPlane, volume: ', this.volume)\n\n      if (origin === 'sagittal') this.mprPlane = 'axial';else if (origin === 'axial') this.mprPlane = 'coronal';else this.mprPlane = 'axial';\n      this.xSize = this.props.files[0].columns;\n      this.ySize = this.props.files[0].rows;\n      this.zSize = mprData.zDim;\n      const i = Math.trunc(y / this.ySize * this.props.files.length);\n      this.originImage = this.props.files[i].image;\n\n      if (origin === 'sagittal') {\n        let xoffset = Math.floor(this.xSize / 2) - Math.floor(this.zSize / 2);\n        let plane = new Int16Array(this.xSize * this.ySize);\n\n        for (let x = 0; x < this.xSize; x++) for (let z = 0; z < this.zSize; z++) plane[z + this.xSize * x + xoffset] = this.volume[z][x + this.xSize * y];\n\n        this.loadImageFromCustomObject(this.xSize, this.ySize, plane);\n      } else {\n        const xzPlane = this.mprBuildXZPlane(y);\n        this.loadImageFromCustomObject(this.xSize, this.zSize, xzPlane);\n      }\n    };\n\n    this.mprBuildXZPlane = y => {\n      //console.log(`mprBuildXZPlane, xSize: ${this.xSize}, zSize: ${this.zSize} `)\n      let plane = new Int16Array(this.xSize * this.zSize);\n\n      for (let x = 0; x < this.xSize; x++) for (let z = 0; z < this.zSize; z++) plane[x + this.xSize * z] = this.volume[z][x + this.xSize * y]; //console.log('mprBuildXZPlane, plane: ', plane)    \n\n\n      return plane;\n    };\n\n    this.mprIsOrthogonalView = () => {\n      //console.log('mprIsOrthogonalView: ', this.mprPlane)\n      return this.mprPlane !== '' && this.props.layout[0] === 1 && this.props.layout[1] === 3;\n    };\n\n    this.dicomImageRef = el => {\n      this.dicomImage = el;\n    };\n\n    this.onImageClick = () => {\n      console.log('onImageClick: ');\n    };\n\n    this.filename = '';\n    this.localfile = null;\n    this.localurl = null;\n    this.fsItem = null;\n    this.dicomImage = null;\n    this.imageId = null;\n    this.image = null;\n    this.isDicom = false;\n    this.numberOfFrames = 1;\n    this.measurements = [];\n    this.xSize = 0;\n    this.ySize = 0;\n    this.zSize = 0;\n    this.volume = null;\n    this.originImage = null;\n    this.mprPlane = '';\n  }\n\n  componentDidMount() {\n    this.props.runTool(this); // this.props.runTool2(this);\n\n    this.props.changeTool(this);\n    cornerstone.events.addEventListener('cornerstoneimageloaded', this.onImageLoaded);\n    const dcmRef = this.props.dcmRef;\n    dcmRef(this);\n  }\n\n  componentWillUnmount() {\n    this.props.runTool(undefined); // this.props.runTool2(undefined);\n\n    this.props.changeTool(undefined);\n    const dcmRef = this.props.dcmRef;\n    dcmRef(undefined);\n  }\n\n  componentDidUpdate(previousProps) {\n    //console.log('dicomviewer - componentDidUpdate: ')\n\n    /*if (this.props.files !== null) {\n      console.log('this.props.files[0]: ', this.props.files[0])\n      console.log('this.props.files: ', this.props.files)\n    }*/\n\n    /*if (this.props.volume !== null) {\n      console.log('volume set: ', this.props.volume)\n      this.volume = this.props.volume\n    }*/\n    const isOpen = this.props.isOpen[this.props.index];\n\n    if (this.props.layout !== previousProps.layout && isOpen) {\n      cornerstone.resize(this.dicomImage);\n    }\n  }\n\n  render() {\n    //console.log('DicomViewer render: ')\n    //this.props.visible ? document.body.style = 'background: #000000;' : document.body.style = 'background: $md-grey-700;'\n    const isOpen = this.props.isOpen[this.props.index]; //const visibleHistogram = this.state.visibleHistogram\n\n    const visibleOpenUrlDlg = this.state.visibleOpenUrlDlg;\n    const errorOnOpenImage = this.state.errorOnOpenImage;\n    const progress = this.state.progress;\n    const styleContainer = {\n      width: '100%',\n      height: '100%',\n      border: this.props.activeDcmIndex === this.props.index && (this.props.layout[0] > 1 || this.props.layout[1] > 1) ? 'solid 1px #AAAAAA' : null,\n      position: 'relative'\n    };\n    const styleDicomImage = {\n      width: '100%',\n      height: '100%',\n      position: 'relative'\n    };\n    const overlay = getSettingsOverlay();\n    return React.createElement(\"div\", {\n      className: \"container\",\n      style: styleContainer,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 1384\n      },\n      __self: this\n    }, visibleOpenUrlDlg ? React.createElement(OpenUrlDlg, {\n      progress: progress,\n      onClose: this.hideOpenUrlDlg,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 1386\n      },\n      __self: this\n    }) : null, React.createElement(Dialog, {\n      open: errorOnOpenImage !== null,\n      onClose: this.onErrorOpenImageClose,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 1388\n      },\n      __self: this\n    }, React.createElement(DialogTitle, {\n      id: \"alert-dialog-title\",\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 1392\n      },\n      __self: this\n    }, \"Error on opening image\"), React.createElement(DialogContent, {\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 1393\n      },\n      __self: this\n    }, React.createElement(DialogContentText, {\n      id: \"alert-dialog-description\",\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 1394\n      },\n      __self: this\n    }, this.state.errorOnOpenImage)), React.createElement(DialogActions, {\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 1398\n      },\n      __self: this\n    }, React.createElement(Button, {\n      onClick: this.onErrorOpenImageClose,\n      autoFocus: true,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 1399\n      },\n      __self: this\n    }, \"Ok\"))), React.createElement(Dialog, {\n      open: this.state.errorOnCors,\n      onClose: this.onErrorCorsClose,\n      \"aria-labelledby\": \"alert-dialog-title\",\n      \"aria-describedby\": \"alert-dialog-description\",\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 1405\n      },\n      __self: this\n    }, React.createElement(DialogTitle, {\n      id: \"alert-dialog-title\",\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 1411\n      },\n      __self: this\n    }, \"Error on loading image\"), React.createElement(DialogContent, {\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 1412\n      },\n      __self: this\n    }, React.createElement(DialogContentText, {\n      id: \"alert-dialog-description\",\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 1413\n      },\n      __self: this\n    }, React.createElement(Typography, {\n      gutterBottom: true,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 1414\n      },\n      __self: this\n    }, \"CORS or Cross Origin Resource Sharing is a browser security policy that prevents javascript from loading data from a server with a different base URL than the server that served up the javascript file.\"), React.createElement(Typography, {\n      gutterBottom: true,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 1419\n      },\n      __self: this\n    }, \"See the \\xA0\", React.createElement(Link, {\n      href: \"http://enable-cors.org/\",\n      target: \"_blank\",\n      color: \"textPrimary\",\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 1421\n      },\n      __self: this\n    }, \"Enable CORS site\"), \"\\xA0 for information about CORS.\"))), React.createElement(DialogActions, {\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 1428\n      },\n      __self: this\n    }, React.createElement(Button, {\n      onClick: this.onErrorCorsClose,\n      autoFocus: true,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 1429\n      },\n      __self: this\n    }, \"Ok\"))), React.createElement(\"div\", {\n      style: {\n        width: '100%',\n        height: '100%',\n        position: \"relative\",\n        color: '#FFFFFF',\n        textShadow: '1px 1px #000000'\n      },\n      onContextMenu: () => false,\n      className: \"cornerstone-enabled-image\",\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 1435\n      },\n      __self: this\n    }, React.createElement(\"div\", {\n      ref: this.dicomImageRef,\n      style: styleDicomImage,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 1446\n      },\n      __self: this\n    }), React.createElement(\"div\", {\n      id: `mrtopleft-${this.props.index}`,\n      style: {\n        position: \"absolute\",\n        top: 0,\n        left: 3,\n        display: isOpen && overlay ? \"\" : \"none\"\n      },\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 1451\n      },\n      __self: this\n    }), React.createElement(\"div\", {\n      id: `mrtopright-${this.props.index}`,\n      style: {\n        position: \"absolute\",\n        top: 0,\n        right: 3,\n        display: isOpen && overlay ? \"\" : \"none\"\n      },\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 1457\n      },\n      __self: this\n    }), React.createElement(\"div\", {\n      id: `mrbottomright-${this.props.index}`,\n      style: {\n        position: \"absolute\",\n        bottom: 0,\n        right: 3,\n        display: isOpen && overlay ? \"\" : \"none\"\n      },\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 1463\n      },\n      __self: this\n    }), React.createElement(\"div\", {\n      id: `mrbottomleft-${this.props.index}`,\n      style: {\n        position: \"absolute\",\n        bottom: 0,\n        left: 3,\n        display: isOpen && overlay ? \"\" : \"none\"\n      },\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 1469\n      },\n      __self: this\n    }), React.createElement(\"div\", {\n      id: `mrtopcenter-${this.props.index}`,\n      style: {\n        position: \"absolute\",\n        top: 0,\n        width: '60px',\n        left: '50%',\n        marginLeft: '0px',\n        display: isOpen && overlay ? \"\" : \"none\"\n      },\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 1476\n      },\n      __self: this\n    }), React.createElement(\"div\", {\n      id: `mrleftcenter-${this.props.index}`,\n      style: {\n        position: \"absolute\",\n        top: '50%',\n        width: '30px',\n        left: 3,\n        marginLeft: '0px',\n        display: isOpen && overlay ? \"\" : \"none\"\n      },\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 1483\n      },\n      __self: this\n    }), React.createElement(\"div\", {\n      id: `mrrightcenter-${this.props.index}`,\n      style: {\n        position: \"absolute\",\n        top: '50%',\n        width: '30px',\n        right: 3,\n        marginRight: '-20px',\n        display: isOpen && overlay ? \"\" : \"none\"\n      },\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 1490\n      },\n      __self: this\n    }), React.createElement(\"div\", {\n      id: `mrbottomcenter-${this.props.index}`,\n      style: {\n        position: \"absolute\",\n        bottom: 0,\n        width: '60px',\n        left: '50%',\n        marginLeft: '0px',\n        display: isOpen && overlay ? \"\" : \"none\"\n      },\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 1497\n      },\n      __self: this\n    }), this.state.visibleCinePlayer && this.numberOfFrames > 1 ? React.createElement(\"div\", {\n      style: {\n        position: \"absolute\",\n        width: '100%',\n        bottom: 0,\n        textAlign: 'center'\n      },\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 1505\n      },\n      __self: this\n    }, React.createElement(\"div\", {\n      style: {\n        margin: '0 auto',\n        width: '240px',\n        backgroundColor: 'rgba(136, 136, 136, 0.5)'\n      },\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 1506\n      },\n      __self: this\n    }, React.createElement(CinePlayer, {\n      runCinePlayer: this.runCinePlayer,\n      inPlay: this.state.inPlay,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 1507\n      },\n      __self: this\n    }), React.createElement(\"div\", {\n      id: `frameLabel-${this.props.index}`,\n      style: {\n        width: 230,\n        margin: '0 auto',\n        marginTop: -10,\n        textAlign: \"center\"\n      },\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 1508\n      },\n      __self: this\n    }, this.state.frame, \" / \", this.numberOfFrames))) : null));\n  }\n\n}\n\nconst mapStateToProps = state => {\n  return {\n    files: state.files,\n    url: state.url,\n    isOpen: state.isOpen,\n    tool: state.tool,\n    activeDcmIndex: state.activeDcmIndex,\n    activeDcm: state.activeDcm,\n    measurements: state.measurements,\n    layout: state.layout,\n    fsCurrentDir: state.fsCurrentDir,\n    fsCurrentList: state.fsCurrentList,\n    volume: state.volume,\n    lut: state.lut //sandboxedFile: state.sandboxedFile,\n\n  };\n};\n\nconst mapDispatchToProps = dispatch => {\n  return {\n    clearingStore: () => dispatch(clearStore()),\n    setIsOpenStore: value => dispatch(dcmIsOpen(value)),\n    toolStore: tool => dispatch(dcmTool(tool)),\n    setActiveDcm: dcm => dispatch(activeDcm(dcm)),\n    setActiveMeasurements: measurements => dispatch(activeMeasurements(measurements)),\n    makeFsRefresh: dcm => dispatch(doFsRefresh()) //setLutStore: (lut) => dispatch(setLut(lut)),\n\n  };\n};\n\nexport default connect(mapStateToProps, mapDispatchToProps)(DicomViewer);","map":{"version":3,"sources":["/media/mohammad/work/websites/cornerstone/dicom-viewer/src/components/DicomViewer.js"],"names":["React","connect","Button","Dialog","DialogActions","DialogContent","DialogContentText","DialogTitle","Link","Typography","Hammer","cornerstone","cornerstoneTools","cornerstoneMath","cornerstoneFileImageLoader","cornerstoneWebImageLoader","cornerstoneWADOImageLoader","dicomParser","blobUtil","uids","SETTINGS_SAVEAS","OpenUrlDlg","CinePlayer","isMobile","import","csTools","db","fs","clearStore","dcmIsOpen","activeDcm","dcmTool","activeMeasurements","doFsRefresh","capitalize","getFileName","getSettingsOverlay","isFileImage","isFsFileImage","isUrlImage","getSettingsSaveInto","scrollToIndex","external","init","DicomViewer","Component","constructor","props","state","visibleOpenUrlDlg","progress","visibleCinePlayer","errorOnOpenImage","errorOnCors","frame","inPlay","viewport","onOpenUrl","e","eventData","detail","setState","percentComplete","showOpenUrlDlg","url","events","addEventListener","loadImage","undefined","hideOpenUrlDlg","measurementSave","measure","measurements","push","measurementClear","splice","length","measurementRemove","index","getTransferSyntax","value","image","data","string","getSopClass","getSopInstanceUID","getPixelRepresentation","uint16","getPlanarConfiguration","onImageLoaded","onImageRendered","getViewport","target","console","log","document","getElementById","textContent","mprIsOrthogonalView","mprPlane","PatientsName","displayedArea","brhc","x","y","Math","round","voi","windowWidth","windowCenter","scale","toFixed","isDicom","numberOfFrames","onMeasurementModified","onMeasurementAdded","tool","note","measurementData","setActiveMeasurements","onMeasurementCompleted","setTimeout","onErrorOpenImageClose","onErrorCorsClose","displayImageFromFilesByImage","element","dicomImage","enable","displayImage","displayImageFromFiles","files","imageId","filename","name","onNewImage","sopInstanceUid","stack","currentImageIdIndex","imageIds","intString","i","mprPlanePosition","enableTool","addStackStateManager","addToolState","measurement","where","equals","each","runTool","updateImage","setToolEnabled","then","setActiveDcm","setIsOpenStore","loadImageFromCanvas","canvas","fileManager","addCanvas","loadImageFromCustomObject","columns","rows","pixelData","customObj","originImage","addCustom","localfile","fsItem","localurl","size","isOpenStore","addBuffer","add","wadouri","loadAndCacheImage","dataSet","parseDicom","byteArray","error","toString","pos","indexOf","substring","toolName","mouseButtonNumber","WwwcTool","LengthTool","PanTool","ZoomTouchPinchTool","ZoomTool","ProbeTool","EllipticalRoiTool","RectangleRoiTool","FreehandRoiTool","AngleTool","MagnifyTool","StackScrollMouseWheelTool","addTool","disableAllTools","runTool2","disable","opt","setToolActive","mouseButtonMask","isTouchActive","invert","setViewport","type","localStorage","getItem","getElementsByClassName","activeDcmIndex","zoom","cols","myCanvas","createElement","cropCanvas","width","height","a","href","toDataURL","download","body","appendChild","click","canvasToBlob","blob","blobToArrayBuffer","arrayBuffer","newName","counter","done","checkName","fsCurrentList","find","transaction","parent","fsCurrentDir","byteLength","makeFsRefresh","reset","removeToolState","forEach","clearToolState","delete","sopinstanceuid","newCanvas","getContext","drawImage","changeTool","setToolPassive","runCinePlayer","cmdName","playClip","stopClip","defaultViewport","getDefaultViewportForImage","imageOrientation","split","v","Array","fill","parseFloat","map","p","abs","transpose","matrix","Object","keys","colNumber","rowNumber","mprRenderYZPlane","origin","mprData","volume","xSize","ySize","zSize","zDim","xoffset","floor","plane","Int16Array","z","yzPlane","mprBuildYZPlane","mprRenderXZPlane","trunc","xzPlane","mprBuildXZPlane","layout","dicomImageRef","el","onImageClick","componentDidMount","dcmRef","componentWillUnmount","componentDidUpdate","previousProps","isOpen","resize","render","styleContainer","border","position","styleDicomImage","overlay","color","textShadow","top","left","display","right","bottom","marginLeft","marginRight","textAlign","margin","backgroundColor","marginTop","mapStateToProps","lut","mapDispatchToProps","dispatch","clearingStore","toolStore","dcm"],"mappings":"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","sourcesContent":["import React from \"react\"\nimport {connect} from 'react-redux'\nimport Button from '@material-ui/core/Button'\nimport Dialog from '@material-ui/core/Dialog'\nimport DialogActions from '@material-ui/core/DialogActions'\nimport DialogContent from '@material-ui/core/DialogContent'\nimport DialogContentText from '@material-ui/core/DialogContentText'\nimport DialogTitle from '@material-ui/core/DialogTitle'\nimport Link from '@material-ui/core/Link'\nimport Typography from '@material-ui/core/Typography'\nimport Hammer from \"hammerjs\"\nimport * as cornerstone from \"cornerstone-core\"\nimport * as cornerstoneTools from \"cornerstone-tools\"\nimport * as cornerstoneMath from \"cornerstone-math\"\nimport * as cornerstoneFileImageLoader from \"cornerstone-file-image-loader\"\nimport * as cornerstoneWebImageLoader from \"cornerstone-web-image-loader\"\nimport * as cornerstoneWADOImageLoader from \"cornerstone-wado-image-loader\"\nimport * as dicomParser from 'dicom-parser'\nimport * as blobUtil from 'blob-util'\nimport {uids} from '../constants/uids'\nimport { SETTINGS_SAVEAS } from '../constants/settings'\nimport OpenUrlDlg from './OpenUrlDlg'\nimport CinePlayer from './CinePlayer'\nimport { isMobile } from 'react-device-detect'\nimport { import as csTools } from 'cornerstone-tools'\nimport db from '../db/db'\nimport fs from '../fs/fs'\nimport {\n  clearStore, \n  dcmIsOpen, \n  activeDcm, \n  dcmTool, \n  activeMeasurements,\n  doFsRefresh} \nfrom '../actions'\nimport {\n  capitalize,\n  getFileName,\n  getSettingsOverlay,\n  isFileImage,\n  isFsFileImage,\n  isUrlImage,\n  getSettingsSaveInto\n} from '../functions'\n\nconst scrollToIndex = csTools('util/scrollToIndex');\n\n/*\nfunction getBlobUrl(url) {\n  const baseUrl = window.URL || window.webkitURL;\n  const blob = new Blob([`importScripts('${url}')`], {type: \"application/javascript\"});\n  return baseUrl.createObjectURL(blob);\n}\n\nlet webWorkerUrl = getBlobUrl(\n  \"https://unpkg.com/cornerstone-wado-image-loader@3.0.0/dist/cornerstoneWADOImageLoaderWebWorker.min.js\"\n)\nlet codecsUrl = getBlobUrl(\n  \"https://unpkg.com/cornerstone-wado-image-loader@3.0.0/dist/cornerstoneWADOImageLoaderCodecs.js\"\n  // \"https://unpkg.com/cornerstone-wado-image-loader/dist/cornerstoneWADOImageLoaderCodecs.js\"\n)\n// See componentDidMount line 110 for initialization, registration\n\nconst config = {\n  maxWebWorkers: 4, //\n  //startWebWorkersOnDemand: true, //\n  webWorkerPath: webWorkerUrl,\n  //webWorkerTaskPaths: [], //\n  taskConfiguration: {\n    decodeTask: {\n      //loadCodecsOnStartup: true, //\n      //initializeCodecsOnStartup: false, //\n      codecsPath: codecsUrl,\n      //usePDFJS: false, //\n      //strict: true //\n    }\n  }\n}\nvar config = {\n  maxWebWorkers: navigator.hardwareConcurrency || 1,\n  startWebWorkersOnDemand: false,\n}\n*/\ncornerstoneTools.external.cornerstone = cornerstone;\ncornerstoneTools.external.cornerstoneMath = cornerstoneMath;\ncornerstoneFileImageLoader.external.cornerstone = cornerstone;\ncornerstoneWebImageLoader.external.cornerstone = cornerstone;\ncornerstoneWADOImageLoader.external.cornerstone = cornerstone;\n//cornerstoneWADOImageLoader.webWorkerManager.initialize(config)\ncornerstoneWADOImageLoader.external.dicomParser = dicomParser;\ncornerstoneTools.external.Hammer = Hammer;\ncornerstoneTools.init();\n\n//console.log({ cornerstone })\n//console.log({ cornerstoneWADOImageLoader })\n//console.log({ dicomParser })\n\nclass DicomViewer extends React.Component {\n    constructor(props) {\n      super(props);\n      this.filename = '';\n      this.localfile = null;\n      this.localurl = null;\n      this.fsItem = null;\n      this.dicomImage = null;\n      this.imageId = null;\n      this.image = null;\n      this.isDicom = false;\n      this.numberOfFrames = 1;\n      this.measurements = [];\n      this.xSize = 0;\n      this.ySize = 0;\n      this.zSize = 0;\n      this.volume = null;\n      this.originImage = null;\n      this.mprPlane = ''\n    }\n\n    state = {\n      visibleOpenUrlDlg: false,\n      progress: null,\n      visibleCinePlayer: false,\n      errorOnOpenImage: null,\n      errorOnCors: false,\n      frame: 1,\n      inPlay: false,\n      viewport: null,\n    };\n\n    componentDidMount() {\n      this.props.runTool(this);\n      // this.props.runTool2(this);\n      this.props.changeTool(this);\n      cornerstone.events.addEventListener('cornerstoneimageloaded', this.onImageLoaded);\n      const { dcmRef } = this.props;\n      dcmRef(this)          \n      \n    }\n\n    componentWillUnmount() {\n      this.props.runTool(undefined);\n      // this.props.runTool2(undefined);\n      this.props.changeTool(undefined);\n      const { dcmRef } = this.props;\n      dcmRef(undefined)            \n    }\n\n    componentDidUpdate(previousProps) {\n      //console.log('dicomviewer - componentDidUpdate: ')\n      /*if (this.props.files !== null) {\n        console.log('this.props.files[0]: ', this.props.files[0])\n        console.log('this.props.files: ', this.props.files)\n      }*/\n      /*if (this.props.volume !== null) {\n        console.log('volume set: ', this.props.volume)\n        this.volume = this.props.volume\n      }*/\n      const isOpen = this.props.isOpen[this.props.index];\n      if (this.props.layout !== previousProps.layout && isOpen) {\n        cornerstone.resize(this.dicomImage)\n      }\n    }\n  \n    onOpenUrl = (e) => {\n      const eventData = e.detail;\n      this.setState({ progress: eventData.percentComplete })\n    };\n\n    showOpenUrlDlg = (url) => {\n      this.setState({ visibleOpenUrlDlg: true }, () => {\n        cornerstone.events.addEventListener('cornerstoneimageloadprogress', this.onOpenUrl);\n        this.loadImage(undefined, url)\n      })\n    };\n  \n    hideOpenUrlDlg = () => {\n      this.setState({ visibleOpenUrlDlg: false, progress: null })\n    };\n\n    measurementSave = (measure) => {\n      this.measurements.push(measure) \n    };\n\n    measurementClear = () => {\n      this.measurements.splice(0, this.measurements.length)\n    };\n\n    measurementRemove = (index) => {\n      //console.log('this.measurements: ', this.measurements)\n      this.measurements.splice(index, 1)\n    };\n\n    getTransferSyntax = () => {\n      const value = this.image.data.string('x00020010');\n      return value + ' [' + uids[value] + ']'\n    };\n\n    getSopClass = () => {\n      const value = this.image.data.string('x00080016');\n      return value + ' [' + uids[value] + ']'\n    };\n\n    getSopInstanceUID = () => {\n      const value = this.image.data.string('x00080018');\n      return value\n    };\n\n    getPixelRepresentation = () => {\n      const value = this.image.data.uint16('x00280103');\n      if (value === undefined) return;\n      return value + (value === 0 ? ' (unsigned)' : ' (signed)')\n    };\n\n    getPlanarConfiguration = () => {\n      const value = this.image.data.uint16('x00280006');\n      if (value === undefined) return;\n      return value + (value === 0 ? ' (pixel)' : ' (plane)')\n    };\n   \n    onImageLoaded = (e) => {\n      //console.log('cornerstoneimageloaded: ')\n    };\n\n    // Listen for changes to the viewport so we can update the text overlays in the corner\n    onImageRendered = (e) => {\n      //console.log('cornerstoneimagerendered: ', e.target)\n      //console.log('cornerstoneimagerendered, plane: ', this.mprPlane)\n\n      //const viewport = cornerstone.getViewport(this.dicomImage)\n      const viewport = cornerstone.getViewport(e.target);\n\n      //console.log('viewport: ', viewport)\n\n      //if (this.props.activeDcm !== null)\n      //  console.log('viewport activeDcm: ', cornerstone.getViewport(this.props.activeDcm.element))\n\n      console.log(\"props.index : \", this.props.index);\n      document.getElementById(\n        `mrtopleft-${this.props.index}`\n      ).textContent = this.mprIsOrthogonalView() ? `${capitalize(this.mprPlane)}` : `${this.PatientsName}`;\n\n      document.getElementById(\n        `mrtopright-${this.props.index}`\n      ).textContent = `${viewport.displayedArea.brhc.x}x${viewport.displayedArea.brhc.y}`;\n\n      document.getElementById(\n        `mrbottomleft-${this.props.index}`\n      ).textContent = `WW/WC: ${Math.round(viewport.voi.windowWidth)}/${Math.round(viewport.voi.windowCenter)}`;\n\n      document.getElementById(\n        `mrbottomright-${this.props.index}`\n      ).textContent = `Zoom: ${Math.round(viewport.scale.toFixed(2)*100)}%`;\n\n      document.getElementById(\n        `mrtopcenter-${this.props.index}`\n      ).textContent = ``;\n      document.getElementById(\n        `mrbottomcenter-${this.props.index}`\n      ).textContent = ``;\n      document.getElementById(\n        `mrleftcenter-${this.props.index}`\n      ).textContent = ``;\n      document.getElementById(\n        `mrrightcenter-${this.props.index}`\n      ).textContent = ``;\n\n      if (this.mprPlane === 'sagittal') {\n        document.getElementById(\n          `mrtopcenter-${this.props.index}`\n        ).textContent = `S`;\n        document.getElementById(\n          `mrbottomcenter-${this.props.index}`\n        ).textContent = `I`;\n        document.getElementById(\n          `mrleftcenter-${this.props.index}`\n        ).textContent = `A`;\n        document.getElementById(\n          `mrrightcenter-${this.props.index}`\n        ).textContent = `P`  \n\n      } else if (this.mprPlane === 'axial') {\n        document.getElementById(\n          `mrtopcenter-${this.props.index}`\n        ).textContent = `A`;\n        document.getElementById(\n          `mrbottomcenter-${this.props.index}`\n        ).textContent = `P`;\n        document.getElementById(\n          `mrleftcenter-${this.props.index}`\n        ).textContent = `R`;\n        document.getElementById(\n          `mrrightcenter-${this.props.index}`\n        ).textContent = `L`    \n\n      } else if (this.mprPlane === 'coronal') {\n        document.getElementById(\n          `mrtopcenter-${this.props.index}`\n        ).textContent = `S`;\n        document.getElementById(\n          `mrbottomcenter-${this.props.index}`\n        ).textContent = `I`;\n        document.getElementById(\n          `mrleftcenter-${this.props.index}`\n        ).textContent = `R`;\n        document.getElementById(\n          `mrrightcenter-${this.props.index}`\n        ).textContent = `L`                    \n      }    \n\n      if (this.isDicom && this.state.visibleCinePlayer && this.numberOfFrames > 1) {\n        document.getElementById(\n          `frameLabel-${this.props.index}`\n        ).textContent = `${this.state.frame} / ${this.numberOfFrames}`;\n        if (this.state.inPlay) {\n          let frame = this.state.frame === this.numberOfFrames ? 1 : this.state.frame+1;\n          this.setState({frame: frame})\n        }\n      }\n    };\n\n    onMeasurementModified = (e) => {\n      //console.log('cornerstonetoolsmeasurementmodified: ', e.detail.measurementData)\n      \n    };\n\n    onMeasurementAdded = (e) => {\n      //console.log('cornerstonetoolsmeasurementadded: ', e.detail.measurementData)\n      if (this.props.tool !== \"Angle\") return;\n      const measure = {\n        tool: this.props.tool,\n        note: '',\n        data: e.detail.measurementData\n      };\n      this.measurementSave(measure);\n      this.props.setActiveMeasurements(this.measurements)      \n    };\n\n    onMeasurementCompleted = (e) => {\n      //console.log('cornerstonetoolsmeasurementcompleted: ', e.detail.measurementData)\n      const measure = {\n        tool: this.props.tool,\n        note: '',\n        data: e.detail.measurementData\n      };\n      if (this.props.tool === \"FreehandRoi\") {\n        setTimeout(() => {\n          this.measurementSave(measure);\n          this.props.setActiveMeasurements(this.measurements)\n        }, 500)\n      } else {\n        this.measurementSave(measure);\n        this.props.setActiveMeasurements(this.measurements)\n      }\n    };\n    \n    onErrorOpenImageClose = () => {\n      this.setState({errorOnOpenImage: null})\n    };\n\n    onErrorCorsClose = () => {\n      this.setState({errorOnCors: false})\n    };\n\n    /*overlayImage = () => {\n      const viewport = cornerstone.getViewport(this.dicomImage)\n\n      if (this.isDicom) document.getElementById(\n        `mrtopleft-${this.props.index}`\n      ).textContent = `${this.PatientsName}`\n\n      document.getElementById(\n        `mrtopright-${this.props.index}`\n      ).textContent = `${viewport.displayedArea.brhc.x}x${viewport.displayedArea.brhc.y}`\n\n      document.getElementById(\n        `mrbottomleft-${this.props.index}`\n      ).textContent = `WW/WC: ${Math.round(viewport.voi.windowWidth)}/${Math.round(viewport.voi.windowCenter)}`\n\n      document.getElementById(\n        `mrbottomright-${this.props.index}`\n      ).textContent = `Zoom: ${Math.round(viewport.scale.toFixed(2)*100)}%`\n\n      if (this.isDicom && this.state.visibleCinePlayer && this.numberOfFrames > 1) {\n        document.getElementById(\n          `frameLabel-${this.props.index}`\n        ).textContent = `${this.state.frame} / ${this.numberOfFrames}`\n        if (this.state.inPlay) {\n          let frame = this.state.frame === this.numberOfFrames ? 1 : this.state.frame+1\n          this.setState({frame: frame})\n        }\n      }\n    }*/\n\n    displayImageFromFilesByImage = (index, image) => {\n\n      const element = this.dicomImage;\n      cornerstone.enable(element);\n      cornerstone.displayImage(element, image);\n    }\n    displayImageFromFiles = (index) => {\n      // console.log('displayImageFromFiles: ', index);\n      // console.log('files: ', this.props.files);\n\n      const image = this.props.files[index].image;\n      const imageId = this.props.files[index].imageId;\n      this.filename = this.props.files[index].name;\n\n      const element = this.dicomImage;\n      element.addEventListener(\"cornerstonenewimage\", this.onNewImage);\n      element.addEventListener(\"cornerstoneimagerendered\", this.onImageRendered);\n      element.addEventListener(\"cornerstonetoolsmeasurementadded\", this.onMeasurementAdded);\n      element.addEventListener(\"cornerstonetoolsmeasurementmodified\", this.onMeasurementModified);\n      element.addEventListener(\"cornerstonetoolsmeasurementcompleted\", this.onMeasurementCompleted);\n      cornerstone.enable(element);\n\n      this.image = image;\n\n      this.isDicom = true;\n      \n      this.PatientsName = image.data.string('x00100010');\n      this.sopInstanceUid = this.getSopInstanceUID();\n\n      let stack = { currentImageIdIndex: 0, imageIds: \"\" };\n      this.numberOfFrames = image.data.intString('x00280008');\n      if (this.numberOfFrames > 0) {\n        let imageIds = [];\n        for(var i=0; i < this.numberOfFrames; ++i) {\n          imageIds.push(imageId + \"?frame=\"+i)\n        }\t\n        stack.imageIds = imageIds\n      }\n\n      cornerstone.displayImage(element, image);\n\n      /*const viewport = cornerstone.getViewport(this.dicomImage)\n      const lut =  cornerstone.generateLut(this.image, viewport.voi.windowWidth, viewport.voi.windowCenter, viewport.invert, viewport.modalityLUT, viewport.voiLUT)\n      this.props.setLutStore(lut)*/\n      this.mprPlanePosition();\n      \n      this.enableTool();\n\n      if (this.numberOfFrames > 1) {\n        cornerstoneTools.addStackStateManager(element, ['stack', 'playClip']);    \n        cornerstoneTools.addToolState(element, 'stack', stack);\n        this.setState({frame: 1})\n      }\n\n      // Load the possible measurements from DB and save in the store \n      db.measurement.where('sopinstanceuid').equals(this.sopInstanceUid).each(measure => {\n        console.log('load measure from db: ', measure);\n        this.measurementSave(measure);\n        cornerstoneTools.addToolState(element, measure.tool, measure.data);\n        this.runTool(measure.tool);\n        cornerstone.updateImage(element);\n        cornerstoneTools.setToolEnabled(measure.tool)\n      }).then(() => {\n        this.props.setActiveMeasurements(this.measurements);\n        this.props.setActiveDcm({image: this.image, element: this.dicomImage, isDicom: this.isDicom});\n        this.props.setIsOpenStore({index: this.props.index, value: true})        \n      })   \n      \n      //this.overlayImage()\n      \n    };\n\n    loadImageFromCanvas = (canvas) => {\n      console.log('loadImageFromCanvas, dcmViewer: ', this.props.index);\n\n      const element = this.dicomImage;\n      element.addEventListener(\"cornerstonenewimage\", this.onNewImage);\n      element.addEventListener(\"cornerstoneimagerendered\", this.onImageRendered);\n      element.addEventListener(\"cornerstonetoolsmeasurementadded\", this.onMeasurementAdded);\n      element.addEventListener(\"cornerstonetoolsmeasurementmodified\", this.onMeasurementModified);\n      element.addEventListener(\"cornerstonetoolsmeasurementcompleted\", this.onMeasurementCompleted);\n      cornerstone.enable(element);\n\n      const imageId = cornerstoneFileImageLoader.fileManager.addCanvas(canvas);\n\n      cornerstone.loadImage(imageId).then(image => {\n        //this.t1 = performance.now()\n        //console.log(`performance load image: ${this.t1-this.t0} milliseconds`)\n\n        console.log('loadImageFromCanvas, image: ', image);\n\n        this.image = image;\n\n        this.isDicom = false;\n\n        cornerstone.displayImage(element, image);\n\n        this.enableTool();\n\n        //this.props.setActiveDcm({image: this.image, element: this.dicomImage, isDicom: this.isDicom})\n        this.props.setIsOpenStore({index: this.props.index, value: true})\n\n        //this.t2 = performance.now()\n        //console.log(`performance: ${this.t2-this.t1} milliseconds`)\n\n        //this.overlayImage()\n\n      }, (e) => {\n        console.log('error', e);\n        this.setState({errorOnOpenImage: \"This is not a valid canvas.\"})\n      })\n    };\n\n    loadImageFromCustomObject = (columns, rows, pixelData) => {\n      //console.log('loadImageFromCustomObject: ')\n\n      const element = this.dicomImage;\n      element.addEventListener(\"cornerstonenewimage\", this.onNewImage);\n      element.addEventListener(\"cornerstoneimagerendered\", this.onImageRendered);\n      element.addEventListener(\"cornerstonetoolsmeasurementadded\", this.onMeasurementAdded);\n      element.addEventListener(\"cornerstonetoolsmeasurementmodified\", this.onMeasurementModified);\n      element.addEventListener(\"cornerstonetoolsmeasurementcompleted\", this.onMeasurementCompleted);\n      cornerstone.enable(element);\n      \n      let customObj = {\n        rows: rows,\n        columns: columns,\n        pixelData: pixelData,\n        image: this.originImage,\n      };\n\n      const imageId = cornerstoneFileImageLoader.fileManager.addCustom(customObj);\n\n      cornerstone.loadImage(imageId).then(image => {\n        //console.log('loadImageFromCustomObject, image: ', image)\n\n        this.image = image;\n\n        this.isDicom = true;\n\n        cornerstone.displayImage(element, image);\n\n        //this.enableTool()\n\n        this.props.setIsOpenStore({index: this.props.index, value: true})\n\n      }, (e) => {\n        console.log('error', e);\n        this.setState({errorOnOpenImage: \"This is not a valid canvas.\"})\n      })\n    };\n\n    loadImage = (localfile, url=undefined, fsItem=undefined) => {\n      console.log('loadImage, localfile: ', localfile);\n      console.log('loadImage, fsItem: ', fsItem);\n      console.log('loadImage, url: ', url);\n\n      if (localfile === undefined && url === undefined && fsItem === undefined) return;\n      \n      if (fsItem !== undefined) {\n        this.fsItem = fsItem\n      } else if (localfile !== undefined) {\n        this.localfile = localfile\n      } else {\n        this.localurl = url\n      }\n \n      const element = this.dicomImage;\n\n      element.addEventListener(\"cornerstonenewimage\", this.onNewImage);\n      element.addEventListener(\"cornerstoneimagerendered\", this.onImageRendered);\n      element.addEventListener(\"cornerstonetoolsmeasurementadded\", this.onMeasurementAdded);\n      element.addEventListener(\"cornerstonetoolsmeasurementmodified\", this.onMeasurementModified);\n      element.addEventListener(\"cornerstonetoolsmeasurementcompleted\", this.onMeasurementCompleted);\n\n      let imageId = undefined;\n\n      cornerstone.enable(element);\n\n      let size = 0;\n\n      if (localfile === undefined && isUrlImage(url)) { // check if it's a simple image [jpeg or png] from url\n        //console.log('image: ', file)\n        cornerstone.loadImage(url).then(image => {\n          //console.log('loadImage, image from url: ', image)\n\n          this.hideOpenUrlDlg();\n\n          this.image = image;\n\n          this.isDicom = false;\n\n          cornerstone.displayImage(element, image);\n          \n          this.enableTool();\n\n          this.props.setActiveDcm({image: this.image, element: this.dicomImage, isDicom: this.isDicom});\n          this.props.isOpenStore(true)\n\n        }, (e) => {\n          console.log('error', e);\n          this.setState({errorOnOpenImage: \"This is not a valid JPG or PNG file.\"})\n        })\n\n      } else if ((localfile !== undefined && isFileImage(localfile)) || (fsItem !== undefined && isFsFileImage(fsItem))) { // otherwise try to open as local image file (JPEG, PNG) \n        if (fsItem !== undefined) {\n          imageId = cornerstoneFileImageLoader.fileManager.addBuffer(fsItem.data)\n        } else {\n          imageId = cornerstoneFileImageLoader.fileManager.add(localfile)\n        }\n        cornerstone.loadImage(imageId).then(image => {\n          // console.log('loadImage, image from local: ', image);\n\n          this.image = image;\n          this.isDicom = false;\n          this.PatientsName = '';\n          // console.log(\"image data:\" + image.data);\n          cornerstone.displayImage(element, image);\n          \n          this.enableTool();\n\n          this.props.setActiveDcm({image: this.image, element: this.dicomImage, isDicom: this.isDicom});\n          //this.props.isOpenStore(true)\n          this.props.setIsOpenStore({index: this.props.index, value: true})\n\n        }, (e) => {\n          console.log('error', e);\n          this.setState({errorOnOpenImage: \"This is not a valid JPG or PNG file.\"})\n        })\n\n      } else { // otherwise try to open as Dicom file\n\n        if (fsItem !== undefined) {\n          imageId = cornerstoneWADOImageLoader.wadouri.fileManager.addBuffer(fsItem.data);\n          this.filename = fsItem.name;\n          size = fsItem.size\n        } else if (localfile !== undefined) {\n          imageId = cornerstoneWADOImageLoader.wadouri.fileManager.add(localfile);\n          this.filename = localfile.name;\n          size = localfile.size\n        } else { // it's a web dicom image\n          imageId = \"wadouri:\"+url\n        }\n  \n        // console.log('loadImage, imageId: ', imageId);\n\n        cornerstone.loadAndCacheImage(imageId).then(image => {\n          console.log('loadImage, image: ', image);\n          // let pixelDataElement = image.data.elements.x7fe00010;\n          // console.log('loadImage, pixelDataElement: ', pixelDataElement);\n          // console.log('loadImage, getPixelData: ', image.getPixelData());\n\n\n          this.hideOpenUrlDlg();\n\n          this.image = image;\n\n          this.isDicom = true;\n\n          let dataSet = dicomParser.parseDicom(image.data.byteArray);\n          console.log('image dataset -----: ' + dataSet.string('x00200011'));\n          console.log('Series Number: ' + image.data.string('x00200011'));\n          \n\n          this.PatientsName = image.data.string('x00100010');\n          console.log('PatientsName: ' + this.PatientsName);\n          this.sopInstanceUid = this.getSopInstanceUID();\n\n          let stack = { currentImageIdIndex: 0, imageIds: \"\" };\n          this.numberOfFrames = image.data.intString('x00280008');\n          if (this.numberOfFrames > 0) {\n            let imageIds = [];\n            for(var i=0; i < this.numberOfFrames; ++i) {\n              imageIds.push(imageId + \"?frame=\"+i)\n            }\t\n            stack.imageIds = imageIds\n          }\n\n          cornerstone.displayImage(element, image);\n          //cornerstoneTools.mouseInput.enable(element);\n          //cornerstoneTools.mouseWheelInput.enable(element);\n\n          this.enableTool();\n\n          /*const viewport = cornerstone.getViewport(this.dicomImage)\n          const lut =  cornerstone.generateLut(this.image, viewport.voi.windowWidth, viewport.voi.windowCenter, viewport.invert, viewport.modalityLUT, viewport.voiLUT)\n          console.log('lut: ', lut)*/\n\n          if (this.numberOfFrames > 1) {\n            cornerstoneTools.addStackStateManager(element, ['stack', 'playClip']);    \n            cornerstoneTools.addToolState(element, 'stack', stack);\n            //cornerstoneTools.setToolActive('StackScrollMouseWheel', { })\n            this.setState({frame: 1})\n          }\n  \n          // Load the possible measurements from DB and save in the store \n          db.measurement.where('sopinstanceuid').equals(this.sopInstanceUid).each(measure => {\n            console.log('load measure from db: ', measure);\n            //this.props.measurementStore(measure)\n            this.measurementSave(measure);\n            cornerstoneTools.addToolState(element, measure.tool, measure.data);\n            this.runTool(measure.tool);\n            cornerstone.updateImage(element);\n            cornerstoneTools.setToolEnabled(measure.tool)\n          }).then(() => {\n            //console.log('this.measurements: ', this.measurements)\n            this.props.setActiveMeasurements(this.measurements);\n            this.props.setActiveDcm({name: this.filename, size: size, image: this.image, element: this.dicomImage, isDicom: this.isDicom});\n            this.props.setIsOpenStore({index: this.props.index, value: true})            \n          });\n\n\n\n\n\n\n        }, (e) => {\n          console.log('error', e);\n          this.hideOpenUrlDlg();\n          //console.log('toString: ', e.error.toString())\n          const error = e.error.toString();\n          if (error === '[object XMLHttpRequest]') {\n            this.setState({errorOnCors: true})\n          } else {\n            const pos = error.indexOf(\":\");\n            this.setState({errorOnOpenImage: pos < 0 ? e.error : error.substring(pos+1)})            \n          } \n        })\n      }\n    };\n  \n    enableTool = (toolName, mouseButtonNumber) => {\n      // Enable all tools we want to use with this element\n      const WwwcTool = cornerstoneTools.WwwcTool;\n      const LengthTool = cornerstoneTools['LengthTool'];\n      const PanTool = cornerstoneTools.PanTool;\n      const ZoomTouchPinchTool = cornerstoneTools.ZoomTouchPinchTool;\n      const ZoomTool = cornerstoneTools.ZoomTool;\n      const ProbeTool = cornerstoneTools.ProbeTool;\n      const EllipticalRoiTool = cornerstoneTools.EllipticalRoiTool;\n      const RectangleRoiTool = cornerstoneTools.RectangleRoiTool;\n      const FreehandRoiTool = cornerstoneTools.FreehandRoiTool;\n      const AngleTool = cornerstoneTools.AngleTool;\n      const MagnifyTool = cornerstoneTools.MagnifyTool;\n      const StackScrollMouseWheelTool = cornerstoneTools.StackScrollMouseWheelTool;\n\n      cornerstoneTools.addTool(MagnifyTool);\n      cornerstoneTools.addTool(AngleTool);\n      cornerstoneTools.addTool(WwwcTool);\n      cornerstoneTools.addTool(LengthTool);\n      cornerstoneTools.addTool(PanTool);\n      cornerstoneTools.addTool(ZoomTouchPinchTool);\n      cornerstoneTools.addTool(ZoomTool);\n      cornerstoneTools.addTool(ProbeTool);\n      cornerstoneTools.addTool(EllipticalRoiTool);\n      cornerstoneTools.addTool(RectangleRoiTool);\n      cornerstoneTools.addTool(FreehandRoiTool);\n      cornerstoneTools.addTool(StackScrollMouseWheelTool)      \n    };\n  \n    // helper function used by the tool button handlers to disable the active tool\n    // before making a new tool active\n    disableAllTools = () => {\n      cornerstoneTools.setToolEnabled('Length');\n      cornerstoneTools.setToolEnabled('Pan');\n      cornerstoneTools.setToolEnabled('Magnify');\n      cornerstoneTools.setToolEnabled('Angle');\n      cornerstoneTools.setToolEnabled('RectangleRoi');\n      cornerstoneTools.setToolEnabled('Wwwc');\n      cornerstoneTools.setToolEnabled('ZoomTouchPinch');\n      cornerstoneTools.setToolEnabled('Probe');\n      cornerstoneTools.setToolEnabled('EllipticalRoi');\n      cornerstoneTools.setToolEnabled('FreehandRoi');\n      cornerstoneTools.setToolEnabled('StackScrollMouseWheel')\n    };\n  \n    runTool2 = (index, image) => {\n      cornerstone.disable(this.dicomImage);\n      this.displayImageFromFilesByImage(index, image);\n    }\n\n    runTool = (toolName, opt) => {\n      //console.log('run tool: ', toolName)\n      // this.disableAllTools()\n      switch (toolName) {\n        case 'openImage': {\n          cornerstone.disable(this.dicomImage);\n          // this.displayImageFromFilesByImage(opt);\n          break\n        }\n        case 'openimage': {\n          //console.log('openimage: ', opt)\n          //console.log('openimage, this.dicomImage: ', this.dicomImage)\n          cornerstone.disable(this.dicomImage);\n          this.displayImageFromFiles(opt);\n          break   \n        }\n        case 'openLocalFs': {\n          console.log('openLocalFs: ', opt);\n          cornerstone.disable(this.dicomImage);\n          this.loadImage(opt);\n          break   \n        } \n        case 'openSandboxFs': {\n          //console.log('openSandboxFs: ', opt)\n          cornerstone.disable(this.dicomImage);\n          //this.setState({ file: opt })\n          this.loadImage(undefined, undefined, opt);\n          break   \n        }         \n        case 'openurl': {\n          //console.log('run tool opt: ', opt)  \n          this.showOpenUrlDlg(opt);\n          break                 \n        }\n        case 'clear': {\n          this.setState({ visibleCinePlayer: false });\n          this.mprPlane = '';\n          //this.props.clearingStore()\n          cornerstone.disable(this.dicomImage);\n          break\n        }  \n        case 'notool': {\n          this.disableAllTools();\n\n          //const element = this.dicomImage\n\n          //cornerstoneTools.clearToolState(element, 'Length')\n          \n          //const toolStateManager = cornerstoneTools.getElementToolStateManager(element)\n          //console.log('toolStateManager.toolState: ', toolStateManager.toolState)\n          /*\n          const toolState = toolStateManager.toolState\n          // const allTools = Object.keys(toolState).map(key => toolState[key])\n          let key = Object.keys(toolState)[0]\n          let allTools = toolState[key]\n          //console.log('allTools: ', allTools)\n\n          for (let [tool, data] of Object.entries(allTools)) {\n            //console.log(`${tool}: `, data)\n            let key = Object.keys(data)[0]\n            let tools = data[key]\n            //console.log('tools: ', tools)\n            tools.forEach(item => {\n              //console.log('tool: ', tool)\n              //console.log(item)\n              const measure = {\n                tool: tool,\n                note: '',\n                data: item\n              }\n              console.log('measure: ', measure)\n              this.props.measurementStore(measure)\n            })\n          }\n          */\n          //const toolState = toolStateManager.get(element, 'Length')\n          //console.log('toolState: ', toolState)\n\n          /*\n          const measurementData = {\n            visible: true,\n            active: true,\n            invalidated: true,\n            handles: {\n                start: {\n                    x: 100,\n                    y: 100,\n                    highlight: true,\n                    active: false\n                },\n                end: {\n                    x: 200,\n                    y: 200,\n                    highlight: true,\n                    active: true\n                },\n                textBox: {\n                    active: false,\n                    hasMoved: false,\n                    movesIndependently: false,\n                    drawnIndependently: true,\n                    allowedOutsideImage: true,\n                    hasBoundingBox: true\n                }\n              }\n          }\n          cornerstoneTools.addToolState(element, 'RectangleRoi', measurementData)    \n          cornerstoneTools.setToolActive('RectangleRoi', { mouseButtonMask: 1 })\n          */  \n          //cornerstone.updateImage(element)   \n          break\n        }\n        case 'Wwwc': {\n          cornerstoneTools.setToolActive('Wwwc', { mouseButtonMask: 1 });\n          break\n        }  \n        case 'Pan': {\n          cornerstoneTools.setToolActive('Pan', { mouseButtonMask: 1 });\n          break   \n        }  \n        case 'Zoom': {\n          cornerstoneTools.setToolActive(isMobile ? 'ZoomTouchPinch' : 'Zoom', { mouseButtonMask: 1 });\n          break\n        }\n        case 'Length': {\n          cornerstoneTools.setToolActive('Length', isMobile ? { isTouchActive: true } : { mouseButtonMask: 1 });\n          break  \n        }\n        case 'Probe': {\n            cornerstoneTools.setToolActive('Probe', { mouseButtonMask: 1 });\n          break\n        }\n        case 'EllipticalRoi': {\n          cornerstoneTools.setToolActive('EllipticalRoi', { mouseButtonMask: 1 });\n          break   \n        }\n        case 'RectangleRoi': {\n          cornerstoneTools.setToolActive('RectangleRoi', { mouseButtonMask: 1 });\n          break  \n        }\n        case 'Angle': {\n          cornerstoneTools.setToolActive('Angle', { mouseButtonMask: 1 });\n          break \n        }\n        case 'Magnify': {\n          cornerstoneTools.setToolActive('Magnify', { mouseButtonMask: 1 });\n          break  \n        }\n        case 'FreehandRoi': {\n          cornerstoneTools.setToolActive('FreehandRoi', { mouseButtonMask: 1 });\n          break \n        }\n        case 'Invert': {\n          const element = this.dicomImage;\n          const viewport = cornerstone.getViewport(element);\n          viewport.invert = !viewport.invert;\n          cornerstone.setViewport(element, viewport);\n          break \n        }         \n        case 'saveas': {\n            let type = localStorage.getItem(SETTINGS_SAVEAS);\n            if (getSettingsSaveInto() === 'local') {\n              // cornerstoneTools.SaveAs(this.dicomImage, `${this.filename}.${type}`, `image/${type}`)   \n              const element = this.dicomImage;\n              const viewport = cornerstone.getViewport(element);\n              const canvas = document.getElementsByClassName('cornerstone-canvas')[this.props.activeDcmIndex];\n              const zoom = viewport.scale.toFixed(2);\n              const cols = this.image.columns * zoom;\n              const rows = this.image.rows * zoom;\n\n              let myCanvas = document.createElement('canvas');\n              myCanvas = this.cropCanvas(canvas, \n                Math.round(canvas.width / 2 - cols / 2), \n                Math.round(canvas.height / 2 - rows / 2), \n                cols, rows);\n\n              let a = document.createElement(\"a\");\n              a.href = myCanvas.toDataURL(`image/${type}`);\n              a.download = `${this.filename}.${type}`;\n              document.body.appendChild(a); // Required for this to work in FireFox\n              a.click()           \n\n            } else { // store image into sandbox file system\n              const element = this.dicomImage;\n              const viewport = cornerstone.getViewport(element);\n              const canvas = document.getElementsByClassName('cornerstone-canvas')[this.props.activeDcmIndex];\n              const zoom = viewport.scale.toFixed(2);\n              const cols = this.image.columns * zoom;\n              const rows = this.image.rows * zoom;\n\n              let myCanvas = document.createElement('canvas');\n              myCanvas = this.cropCanvas(canvas, \n                Math.round(canvas.width / 2 - cols / 2), \n                Math.round(canvas.height / 2 - rows / 2), \n                cols, rows);\n              \n              blobUtil.canvasToBlob(myCanvas, `image/${type}`).then(blob => {\n                blobUtil.blobToArrayBuffer(blob).then(arrayBuffer => {\n                  const name = `${getFileName(this.filename)}-MPR-${this.mprPlane}`;\n                  let newName = name;\n                  let counter = 1;\n                  let done = false;\n                  do {\n                      let filename = `${newName}.${type}`;\n                      const checkName = this.props.fsCurrentList.find(e => e.name === filename);\n                      if (checkName === undefined) {\n                          fs.transaction('rw', fs.files, async () => {\n                              await fs.files.add({\n                                  parent: this.props.fsCurrentDir,\n                                  name: filename,\n                                  type: type,\n                                  size: arrayBuffer.byteLength,\n                                  data: arrayBuffer\n                              })\n                          }).then(() => {\n                            this.props.makeFsRefresh()\n                          });\n                          done = true\n                      } else {\n                          newName = `${name} - ${counter}`;\n                          counter++\n                      }\n                  } while (!done)\n                })\n              })\n            }  \n          break\n        }\n        case 'cine': {\n          this.setState({ visibleCinePlayer: !this.state.visibleCinePlayer });\n          break\n        }\n        case 'reset': {\n          this.reset();\n          break\n        }\n        case 'removetool': {\n          console.log('removetool index: ', opt);\n          const element = this.dicomImage;\n          cornerstoneTools.removeToolState(element, this.measurements[opt].tool, this.measurements[opt].data);\n          cornerstone.updateImage(element);\n          //this.props.measurementRemoveStore(opt)\n          this.measurementRemove(opt);\n          this.props.setActiveMeasurements(this.measurements);\n          break\n        }  \n        case 'removetools': {   \n          const element = this.dicomImage;\n          // for each measurement remove it \n          this.measurements.forEach(measure => {\n            cornerstoneTools.clearToolState(element, measure.tool)         \n          });\n          cornerstone.updateImage(element);\n          this.measurementClear();\n          // also remove all measurements from db\n          db.measurement.where('sopinstanceuid').equals(this.sopInstanceUid).delete();\n          this.props.setActiveMeasurements(this.measurements);\n          break\n        }  \n        case 'savetools': {\n          // first, remove eventually previous measurements from db\n          db.measurement.where('sopinstanceuid').equals(this.sopInstanceUid).delete();\n          // then save all the current measurements\n          this.measurements.forEach(measure => {\n            try {\n              db.measurement.add({\n                sopinstanceuid: this.sopInstanceUid, \n                tool: measure.tool,\n                note: measure.note,\n                data: measure.data\n              })\n            } catch(error) {\n              console.error(error)\n            }                       \n          });\n          break\n        }\n        default: {\n          break\n        }\n      }\n    };\n\n    cropCanvas = (canvas, x, y, width, height) => {\n      console.log(`canvas: ${canvas.width}, ${canvas.height}`);\n      console.log(`x, y: ${x}, ${y}`);\n      console.log(`width, height: ${width}, ${height}`);\n\n      // create a temp canvas\n      const newCanvas = document.createElement('canvas');\n      // set its dimensions\n      newCanvas.width = width;\n      newCanvas.height = height;\n      // draw the canvas in the new resized temp canvas \n      newCanvas.getContext('2d').drawImage(canvas, x, y, width, height, 0, 0, width, height);\n      return newCanvas\n    };\n\n    changeTool = (toolName, value) => {\n      console.log('change tool, value: ', toolName, value);\n\n      switch (toolName) {\n        case 'Wwwc':\n          if (value === 1) {\n            cornerstoneTools.setToolActive('Wwwc', { mouseButtonMask: 1 })\n          } else if (value === 0) {\n            cornerstoneTools.setToolPassive('Wwwc')\n          }\n          break;\n        case 'Pan':\n          if (value === 1) {\n            cornerstoneTools.setToolActive('Pan', { mouseButtonMask: 1 })\n          } else if (value === 0) {\n            cornerstoneTools.setToolPassive('Pan')\n          }\n          break;\n        case 'Zoom':\n          if (value === 1) {\n            cornerstoneTools.setToolActive(isMobile ? 'ZoomTouchPinch' : 'Zoom', { mouseButtonMask: 1 })\n          } else if (value === 0) {\n            cornerstoneTools.setToolPassive(isMobile ? 'ZoomTouchPinch' : 'Zoom')\n          }\n          break;\n        case 'Length':\n          if (value === 1) {\n            cornerstoneTools.setToolActive('Length', isMobile ? { isTouchActive: true } : { mouseButtonMask: 1 })\n          } else if (value === 0) {\n            cornerstoneTools.setToolPassive('Length')\n          }\n          break;\n        case 'Probe':\n          if (value === 1) {\n            cornerstoneTools.setToolActive('Probe', { mouseButtonMask: 1 })\n          } else if (value === 0) {\n            cornerstoneTools.setToolPassive('Probe')\n          }\n          break;\n        case 'Angle':\n          if (value === 1) {\n            cornerstoneTools.setToolActive('Angle', { mouseButtonMask: 1 })\n          } else if (value === 0) {\n            cornerstoneTools.setToolPassive('Angle')\n          }          \n          break;\n        case 'Magnify':\n          if (value === 1) {\n            cornerstoneTools.setToolActive('Magnify', { mouseButtonMask: 1 })\n          } else if (value === 0) {\n            cornerstoneTools.setToolPassive('Magnify')\n          }          \n          break;\n        case 'EllipticalRoi':\n          if (value === 1) {\n            cornerstoneTools.setToolActive('EllipticalRoi', { mouseButtonMask: 1 })\n          } else if (value === 0) {\n            cornerstoneTools.setToolPassive('EllipticalRoi')\n          }\n          break;\n        case 'RectangleRoi':\n          if (value === 1) {\n            cornerstoneTools.setToolActive('RectangleRoi', { mouseButtonMask: 1 })\n          } else if (value === 0) {\n            cornerstoneTools.setToolPassive('RectangleRoi')\n          }\n          break;\n        case 'FreehandRoi':\n          if (value === 1) {\n            cornerstoneTools.setToolActive('FreehandRoi', { mouseButtonMask: 1 })\n          } else if (value === 0) {\n            cornerstoneTools.setToolPassive('FreehandRoi')\n          }\n          break;\n        default:\n            break\n        }  \n    };\n\n    runCinePlayer = (cmdName) => {\n      //console.log('this.state.frame: ', this.state.frame)\n      const element = this.dicomImage;\n      switch (cmdName) {\n        case 'firstframe': {\n          let frame = 1;\n          this.setState({frame: frame});\n          scrollToIndex(element, 0);\n          break\n        }\n        case 'previousframe': {\n          if (this.state.frame > 1) {\n            let frame = this.state.frame-1;\n            this.setState({frame: frame});\n            scrollToIndex(element, frame-1)       \n          }\n          break\n        }\n        case 'play': {\n          cornerstoneTools.playClip(element, 30);\n          this.setState({inPlay: true});\n          break\n        }\n        case 'pause': {\n            cornerstoneTools.stopClip(element);\n            this.setState({inPlay: false});\n          break\n        }\n        case 'nextframe': {\n          if (this.state.frame < this.numberOfFrames) {\n            let frame = this.state.frame+1;\n            this.setState({frame: frame});\n            scrollToIndex(element, frame-1)\n          }\n          break  \n        }\n        case 'lastframe': {\n          let frame = this.numberOfFrames;\n          this.setState({frame: frame});\n          scrollToIndex(element, frame-1);\n          break    \n        }                       \n        default:\n          break\n      }\n    };\n\n    reset = () => {\n      const element = this.dicomImage;\n      const defaultViewport = cornerstone.getDefaultViewportForImage(element, this.image);\n      let viewport = cornerstone.getViewport(element);\n      viewport.voi.windowWidth = defaultViewport.voi.windowWidth;\n      viewport.voi.windowCenter = defaultViewport.voi.windowCenter;\n      viewport.invert = false;\n      cornerstone.setViewport(element, viewport)\n    };\n\n    // -------------------------------------------------------------------------------------------- MPR\n\n    mprPlanePosition = () => {\n      //console.log(\"mprPlanePosition: \")\n      try {\n        if (!this.isDicom) return this.mprPlane;\n        // console.log(\"image data:\" + this.image.data);\n        const imageOrientation = this.image.data.string('x00200037').split('\\\\');\n        let v = new Array(6).fill(0);\n        v[0] = parseFloat(imageOrientation[0]); // the x direction cosines of the first row X\n        v[1] = parseFloat(imageOrientation[1]); // the y direction cosines of the first row X\n        v[2] = parseFloat(imageOrientation[2]); // the z direction cosines of the first row X\n        v[3] = parseFloat(imageOrientation[3]); // the x direction cosines of the first column Y\n        v[4] = parseFloat(imageOrientation[4]); // the y direction cosines of the first column Y\n        v[5] = parseFloat(imageOrientation[5]); // the z direction cosines of the first column Y\n        v = v.map((x) => Math.round(x));\n        let p = [v[1]*v[5] - v[2]*v[4], v[2]*v[3] - v[0]*v[5], v[0]*v[4] - v[1]*v[3]]; // cross product of X x Y\n        p = p.map((x) => Math.abs(x));\n        if (p[0] === 1) {\n          this.mprPlane = 'sagittal'\n        } else if (p[1] === 1) {\n          this.mprPlane = 'coronal'\n        } else if (p[2] === 1) {\n          this.mprPlane = 'axial'\n        }\n      } catch(error) { // it's not possible to build MPR\n        this.mprPlane = ''\n      } \n      return this.mprPlane \n    };\n\n    transpose = (matrix) => {\n      return Object.keys(matrix[0]).map(colNumber => matrix.map(rowNumber => rowNumber[colNumber]));\n    };\n\n    mprRenderYZPlane = (filename, origin, x, mprData) => {\n      if (this.volume === null) return;\n      this.filename = filename;\n      cornerstone.disable(this.dicomImage);\n      //console.log(`mprRenderYZPlane, origin: ${origin}, x: ${x}`)\n      //console.log('mprRenderYZPlane, volume: ', this.volume)\n\n      if (origin === 'sagittal') \n        this.mprPlane = 'coronal';\n      else if (origin === 'axial') \n        this.mprPlane = 'sagittal';\n      else\n        this.mprPlane = 'sagittal';\n\n      this.xSize = this.props.files[0].columns;\n      this.ySize = this.props.files[0].rows;\n      this.zSize = mprData.zDim;\n\n      const i = Math.round(x / this.xSize * this.props.files.length);\n      this.originImage = this.props.files[i].image;\n\n      if (origin === 'sagittal') {\n        let xoffset = Math.floor(this.xSize / 2) - Math.floor(this.zSize / 2);\n        let plane = new Int16Array(this.xSize * this.ySize);\n        for (let y = 0; y < this.ySize; y++) \n          for (let z = 0; z < this.zSize; z++) \n            plane[z + this.ySize * y + xoffset] = this.volume[z][x + this.ySize * y];\n        this.loadImageFromCustomObject(this.xSize, this.ySize, plane)\n\n      } else if (origin === 'coronal') {\n        let xoffset = Math.floor(this.xSize / 2) - Math.floor(this.zSize / 2);\n        let plane = new Int16Array(this.xSize * this.ySize);\n        for (let y = 0; y < this.ySize; y++) \n          for (let z = 0; z < this.zSize; z++) \n            plane[z + this.ySize * y + xoffset] = this.volume[z][x + this.ySize * y];\n        this.loadImageFromCustomObject(this.xSize, this.ySize, plane)\n\n      } else { // axial\n        const yzPlane = this.mprBuildYZPlane(x);\n        this.loadImageFromCustomObject(this.ySize, this.zSize, yzPlane)\n      }\n    };\n\n    mprBuildYZPlane = (x) => {\n      //console.log(`mprBuildYZPlane, ySize: ${this.ySize}, zSize: ${this.zSize} `)\n      let plane = new Int16Array(this.ySize * this.zSize);\n      for (var y = 0; y < this.ySize; y++) \n        for (var z = 0; z < this.zSize; z++) \n          plane[y + this.ySize * z] = this.volume[z][x + this.ySize * y];\n      //console.log('mprBuildYZPlane, plane: ', plane)\n      return plane\n    };\n\n    mprRenderXZPlane = (filename, origin, y, mprData) => {\n      if (this.volume === null) return;\n      this.filename = filename;\n      cornerstone.disable(this.dicomImage);\n      //console.log(`mprRenderXZPlane, origin: ${origin}, y: ${y}`)\n      //console.log('mprRenderXZPlane, volume: ', this.volume)\n\n      if (origin === 'sagittal') \n        this.mprPlane = 'axial';\n      else if (origin === 'axial') \n        this.mprPlane = 'coronal';\n      else\n        this.mprPlane = 'axial';\n\n      this.xSize = this.props.files[0].columns;\n      this.ySize = this.props.files[0].rows;\n      this.zSize = mprData.zDim;\n\n      const i = Math.trunc(y / this.ySize * this.props.files.length);\n      this.originImage = this.props.files[i].image;\n\n      if (origin === 'sagittal') {\n        let xoffset = Math.floor(this.xSize / 2) - Math.floor(this.zSize / 2);\n        let plane = new Int16Array(this.xSize * this.ySize);\n        for (let x = 0; x < this.xSize; x++) \n          for (let z = 0; z < this.zSize; z++)\n            plane[z + this.xSize * x + xoffset] = this.volume[z][x + this.xSize * y];\n        this.loadImageFromCustomObject(this.xSize, this.ySize, plane)\n\n      } else {\n        const xzPlane = this.mprBuildXZPlane(y);\n        this.loadImageFromCustomObject(this.xSize, this.zSize, xzPlane)\n      }\n    };\n  \n    mprBuildXZPlane = (y) => {\n      //console.log(`mprBuildXZPlane, xSize: ${this.xSize}, zSize: ${this.zSize} `)\n      let plane = new Int16Array(this.xSize * this.zSize);\n      for (let x = 0; x < this.xSize; x++) \n        for (let z = 0; z < this.zSize; z++)\n          plane[x + this.xSize * z] = this.volume[z][x + this.xSize * y];\n      //console.log('mprBuildXZPlane, plane: ', plane)    \n      return plane\n    };\n\n    mprIsOrthogonalView = () => {\n      //console.log('mprIsOrthogonalView: ', this.mprPlane)\n      return (this.mprPlane !== '' && this.props.layout[0] === 1 && this.props.layout[1] === 3)\n    };\n\n    // -------------------------------------------------------------------------------------------- MPR\n    \n    dicomImageRef = el => {\n      this.dicomImage = el\n    };\n\n    onImageClick = () => {\n      console.log('onImageClick: ')\n    };\n    \n    render() {\n      //console.log('DicomViewer render: ')\n\n      //this.props.visible ? document.body.style = 'background: #000000;' : document.body.style = 'background: $md-grey-700;'\n\n      const isOpen = this.props.isOpen[this.props.index];\n      //const visibleHistogram = this.state.visibleHistogram\n      const visibleOpenUrlDlg = this.state.visibleOpenUrlDlg;\n      const errorOnOpenImage = this.state.errorOnOpenImage;\n      const progress = this.state.progress;\n\n      const styleContainer = {\n        width: '100%', \n        height: '100%', \n        border: this.props.activeDcmIndex === this.props.index && (this.props.layout[0] > 1 || this.props.layout[1] > 1) ? 'solid 1px #AAAAAA' : null,\n        position: 'relative',\n      };\n\n      const styleDicomImage = {\n        width: '100%', \n        height: '100%', \n        position: 'relative',\n      };\n\n      const overlay = getSettingsOverlay();\n\n      return ( \n        <div className=\"container\" style={styleContainer} >\n\n          {visibleOpenUrlDlg ? <OpenUrlDlg progress={progress} onClose={this.hideOpenUrlDlg} /> : null}\n\n          <Dialog\n            open={errorOnOpenImage !== null}\n            onClose={this.onErrorOpenImageClose}\n          >\n            <DialogTitle id=\"alert-dialog-title\">{\"Error on opening image\"}</DialogTitle>\n            <DialogContent>\n              <DialogContentText id=\"alert-dialog-description\">\n                {this.state.errorOnOpenImage}\n              </DialogContentText>\n            </DialogContent>\n            <DialogActions>\n              <Button onClick={this.onErrorOpenImageClose} autoFocus>\n                Ok\n              </Button>\n            </DialogActions>\n          </Dialog>\n\n          <Dialog\n            open={this.state.errorOnCors}\n            onClose={this.onErrorCorsClose}\n            aria-labelledby=\"alert-dialog-title\"\n            aria-describedby=\"alert-dialog-description\"\n          >\n            <DialogTitle id=\"alert-dialog-title\">{\"Error on loading image\"}</DialogTitle>\n            <DialogContent>\n              <DialogContentText id=\"alert-dialog-description\">\n                <Typography gutterBottom>\n                  CORS or Cross Origin Resource Sharing is a browser security policy \n                  that prevents javascript from loading data from a server with a different base URL \n                  than the server that served up the javascript file. \n                </Typography> \n                <Typography gutterBottom>\n                  See the &nbsp; \n                  <Link href=\"http://enable-cors.org/\" target='_blank' color='textPrimary'>\n                    Enable CORS site\n                  </Link>\n                  &nbsp; for information about CORS.                     \n                </Typography>                                \n              </DialogContentText>\n            </DialogContent>\n            <DialogActions>\n              <Button onClick={this.onErrorCorsClose} autoFocus>\n                Ok\n              </Button>\n            </DialogActions>\n          </Dialog>\n\n          <div\n            style={{\n              width: '100%', \n              height: '100%', \n              position: \"relative\",\n              color: '#FFFFFF',\n              textShadow: '1px 1px #000000'\n            }}\n            onContextMenu={() => false}\n            className=\"cornerstone-enabled-image\"\n          >\n            <div \n              ref={this.dicomImageRef} style={styleDicomImage}\n            >\n            </div>\n\n            <div\n              id={`mrtopleft-${this.props.index}`}\n              style={{ position: \"absolute\", top: 0, left: 3, display: isOpen && overlay ? \"\" : \"none\" }}\n            >\n              \n            </div>\n            <div\n              id={`mrtopright-${this.props.index}`}\n              style={{ position: \"absolute\", top: 0, right: 3, display: isOpen && overlay ? \"\" : \"none\" }}\n            >\n              \n            </div>\n            <div\n              id={`mrbottomright-${this.props.index}`}\n              style={{ position: \"absolute\", bottom: 0, right: 3, display: isOpen && overlay ? \"\" : \"none\" }}\n            >\n              \n            </div>\n            <div\n              id={`mrbottomleft-${this.props.index}`}\n              style={{ position: \"absolute\", bottom: 0, left: 3, display: isOpen && overlay ? \"\" : \"none\" }}\n            >\n              \n            </div>   \n\n            <div\n              id={`mrtopcenter-${this.props.index}`}\n              style={{ position: \"absolute\", top: 0, width: '60px', left: '50%', marginLeft: '0px', display: isOpen && overlay ? \"\" : \"none\" }}\n            >\n              \n            </div>\n\n            <div\n              id={`mrleftcenter-${this.props.index}`}\n              style={{ position: \"absolute\", top: '50%', width: '30px', left: 3, marginLeft: '0px', display: isOpen && overlay ? \"\" : \"none\" }}\n            >\n              \n            </div>    \n\n            <div\n              id={`mrrightcenter-${this.props.index}`}\n              style={{ position: \"absolute\", top: '50%', width: '30px', right: 3, marginRight: '-20px', display: isOpen && overlay ? \"\" : \"none\" }}\n            >\n              \n            </div>                \n\n            <div\n              id={`mrbottomcenter-${this.props.index}`}\n              style={{ position: \"absolute\", bottom: 0, width: '60px', left: '50%', marginLeft: '0px', display: isOpen && overlay ? \"\" : \"none\" }}\n            >\n              \n            </div>\n\n            { this.state.visibleCinePlayer && this.numberOfFrames > 1 ? (\n              <div style={{position:\"absolute\", width:'100%', bottom:0, textAlign:'center'}}>\n                <div style={{margin:'0 auto', width:'240px', backgroundColor:'rgba(136, 136, 136, 0.5)'}}>\n                  <CinePlayer runCinePlayer={this.runCinePlayer} inPlay={this.state.inPlay} />  \n                  <div \n                    id={`frameLabel-${this.props.index}`}\n                    style={{ width:230, margin:'0 auto', marginTop:-10, textAlign:\"center\" }}\n                  >\n                    {this.state.frame} / {this.numberOfFrames}\n                  </div> \n                </div>               \n              </div> \n              ) : null\n            }  \n            {/*<div style={{position:\"absolute\", width:'100%', height:'100%', top:0, left:0}}></div>*/}\n          </div>\n        </div>\n      )\n    }\n  }\n  \nconst mapStateToProps = (state) => {\n  return {\n    files: state.files,\n    url: state.url,\n    isOpen: state.isOpen,\n    tool: state.tool,\n    activeDcmIndex: state.activeDcmIndex,\n    activeDcm: state.activeDcm,\n    measurements: state.measurements,\n    layout: state.layout,\n    fsCurrentDir: state.fsCurrentDir,\n    fsCurrentList: state.fsCurrentList,\n    volume: state.volume,\n    lut: state.lut,\n    //sandboxedFile: state.sandboxedFile,\n  }\n};\n\nconst mapDispatchToProps = (dispatch) => {\n  return {\n    clearingStore: () => dispatch(clearStore()),\n    setIsOpenStore: (value) => dispatch(dcmIsOpen(value)),\n    toolStore: (tool) => dispatch(dcmTool(tool)),\n    setActiveDcm: (dcm) => dispatch(activeDcm(dcm)),\n    setActiveMeasurements: (measurements) => dispatch(activeMeasurements(measurements)),\n    makeFsRefresh: (dcm) => dispatch(doFsRefresh()),\n    //setLutStore: (lut) => dispatch(setLut(lut)),\n  }\n};\n\nexport default connect(mapStateToProps, mapDispatchToProps)(DicomViewer)\n"]},"metadata":{},"sourceType":"module"}