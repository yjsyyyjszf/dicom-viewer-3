{"ast":null,"code":"var _jsxFileName = \"/media/mohammad/work/websites/cornerstone/dicom-viewer/src/components/DicomViewer.js\";\nimport React from \"react\";\nimport { connect } from 'react-redux';\nimport Button from '@material-ui/core/Button';\nimport Dialog from '@material-ui/core/Dialog';\nimport DialogActions from '@material-ui/core/DialogActions';\nimport DialogContent from '@material-ui/core/DialogContent';\nimport DialogContentText from '@material-ui/core/DialogContentText';\nimport DialogTitle from '@material-ui/core/DialogTitle';\nimport Link from '@material-ui/core/Link';\nimport Typography from '@material-ui/core/Typography';\nimport Hammer from \"hammerjs\";\nimport * as cornerstone from \"cornerstone-core\";\nimport * as cornerstoneTools from \"cornerstone-tools\";\nimport * as cornerstoneMath from \"cornerstone-math\";\nimport * as cornerstoneFileImageLoader from \"cornerstone-file-image-loader\";\nimport * as cornerstoneWebImageLoader from \"cornerstone-web-image-loader\";\nimport * as cornerstoneWADOImageLoader from \"cornerstone-wado-image-loader\";\nimport * as dicomParser from 'dicom-parser';\nimport * as blobUtil from 'blob-util';\nimport { uids } from '../constants/uids';\nimport { SETTINGS_SAVEAS } from '../constants/settings';\nimport OpenUrlDlg from './OpenUrlDlg';\nimport CinePlayer from './CinePlayer';\nimport { isMobile } from 'react-device-detect';\nimport { import as csTools } from 'cornerstone-tools';\nimport db from '../db/db';\nimport fs from '../fs/fs';\nimport { clearStore, dcmIsOpen, activeDcm, dcmTool, activeMeasurements, doFsRefresh } from '../actions';\nimport { capitalize, getFileName, getSettingsOverlay, isFileImage, isFsFileImage, isUrlImage, getSettingsSaveInto } from '../functions';\nconst scrollToIndex = csTools('util/scrollToIndex');\n/*\nfunction getBlobUrl(url) {\n  const baseUrl = window.URL || window.webkitURL;\n  const blob = new Blob([`importScripts('${url}')`], {type: \"application/javascript\"});\n  return baseUrl.createObjectURL(blob);\n}\n\nlet webWorkerUrl = getBlobUrl(\n  \"https://unpkg.com/cornerstone-wado-image-loader@3.0.0/dist/cornerstoneWADOImageLoaderWebWorker.min.js\"\n)\nlet codecsUrl = getBlobUrl(\n  \"https://unpkg.com/cornerstone-wado-image-loader@3.0.0/dist/cornerstoneWADOImageLoaderCodecs.js\"\n  // \"https://unpkg.com/cornerstone-wado-image-loader/dist/cornerstoneWADOImageLoaderCodecs.js\"\n)\n// See componentDidMount line 110 for initialization, registration\n\nconst config = {\n  maxWebWorkers: 4, //\n  //startWebWorkersOnDemand: true, //\n  webWorkerPath: webWorkerUrl,\n  //webWorkerTaskPaths: [], //\n  taskConfiguration: {\n    decodeTask: {\n      //loadCodecsOnStartup: true, //\n      //initializeCodecsOnStartup: false, //\n      codecsPath: codecsUrl,\n      //usePDFJS: false, //\n      //strict: true //\n    }\n  }\n}\nvar config = {\n  maxWebWorkers: navigator.hardwareConcurrency || 1,\n  startWebWorkersOnDemand: false,\n}\n*/\n\ncornerstoneTools.external.cornerstone = cornerstone;\ncornerstoneTools.external.cornerstoneMath = cornerstoneMath;\ncornerstoneFileImageLoader.external.cornerstone = cornerstone;\ncornerstoneWebImageLoader.external.cornerstone = cornerstone;\ncornerstoneWADOImageLoader.external.cornerstone = cornerstone; //cornerstoneWADOImageLoader.webWorkerManager.initialize(config)\n\ncornerstoneWADOImageLoader.external.dicomParser = dicomParser;\ncornerstoneTools.external.Hammer = Hammer;\ncornerstoneTools.init(); //console.log({ cornerstone })\n//console.log({ cornerstoneWADOImageLoader })\n//console.log({ dicomParser })\n\nclass DicomViewer extends React.Component {\n  constructor(props) {\n    super(props);\n    this.state = {\n      visibleOpenUrlDlg: false,\n      progress: null,\n      visibleCinePlayer: false,\n      errorOnOpenImage: null,\n      errorOnCors: false,\n      frame: 1,\n      inPlay: false,\n      viewport: null\n    };\n\n    this.onOpenUrl = e => {\n      const eventData = e.detail;\n      this.setState({\n        progress: eventData.percentComplete\n      });\n    };\n\n    this.showOpenUrlDlg = url => {\n      this.setState({\n        visibleOpenUrlDlg: true\n      }, () => {\n        cornerstone.events.addEventListener('cornerstoneimageloadprogress', this.onOpenUrl);\n        this.loadImage(undefined, url);\n      });\n    };\n\n    this.hideOpenUrlDlg = () => {\n      this.setState({\n        visibleOpenUrlDlg: false,\n        progress: null\n      });\n    };\n\n    this.measurementSave = measure => {\n      this.measurements.push(measure);\n    };\n\n    this.measurementClear = () => {\n      this.measurements.splice(0, this.measurements.length);\n    };\n\n    this.measurementRemove = index => {\n      //console.log('this.measurements: ', this.measurements)\n      this.measurements.splice(index, 1);\n    };\n\n    this.getTransferSyntax = () => {\n      const value = this.image.data.string('x00020010');\n      return value + ' [' + uids[value] + ']';\n    };\n\n    this.getSopClass = () => {\n      const value = this.image.data.string('x00080016');\n      return value + ' [' + uids[value] + ']';\n    };\n\n    this.getSopInstanceUID = () => {\n      const value = this.image.data.string('x00080018');\n      return value;\n    };\n\n    this.getPixelRepresentation = () => {\n      const value = this.image.data.uint16('x00280103');\n      if (value === undefined) return;\n      return value + (value === 0 ? ' (unsigned)' : ' (signed)');\n    };\n\n    this.getPlanarConfiguration = () => {\n      const value = this.image.data.uint16('x00280006');\n      if (value === undefined) return;\n      return value + (value === 0 ? ' (pixel)' : ' (plane)');\n    };\n\n    this.onImageLoaded = e => {//console.log('cornerstoneimageloaded: ')\n    };\n\n    this.onImageRendered = e => {\n      //console.log('cornerstoneimagerendered: ', e.target)\n      //console.log('cornerstoneimagerendered, plane: ', this.mprPlane)\n      //const viewport = cornerstone.getViewport(this.dicomImage)\n      const viewport = cornerstone.getViewport(e.target); //console.log('viewport: ', viewport)\n      //if (this.props.activeDcm !== null)\n      //  console.log('viewport activeDcm: ', cornerstone.getViewport(this.props.activeDcm.element))\n\n      console.log(\"props.index : \", this.props.index);\n      document.getElementById(`mrtopleft-${this.props.index}`).textContent = this.mprIsOrthogonalView() ? `${capitalize(this.mprPlane)}` : `${this.PatientsName}`;\n      document.getElementById(`mrtopright-${this.props.index}`).textContent = `${viewport.displayedArea.brhc.x}x${viewport.displayedArea.brhc.y}`;\n      document.getElementById(`mrbottomleft-${this.props.index}`).textContent = `WW/WC: ${Math.round(viewport.voi.windowWidth)}/${Math.round(viewport.voi.windowCenter)}`;\n      document.getElementById(`mrbottomright-${this.props.index}`).textContent = `Zoom: ${Math.round(viewport.scale.toFixed(2) * 100)}%`;\n      document.getElementById(`mrtopcenter-${this.props.index}`).textContent = ``;\n      document.getElementById(`mrbottomcenter-${this.props.index}`).textContent = ``;\n      document.getElementById(`mrleftcenter-${this.props.index}`).textContent = ``;\n      document.getElementById(`mrrightcenter-${this.props.index}`).textContent = ``;\n\n      if (this.mprPlane === 'sagittal') {\n        document.getElementById(`mrtopcenter-${this.props.index}`).textContent = `S`;\n        document.getElementById(`mrbottomcenter-${this.props.index}`).textContent = `I`;\n        document.getElementById(`mrleftcenter-${this.props.index}`).textContent = `A`;\n        document.getElementById(`mrrightcenter-${this.props.index}`).textContent = `P`;\n      } else if (this.mprPlane === 'axial') {\n        document.getElementById(`mrtopcenter-${this.props.index}`).textContent = `A`;\n        document.getElementById(`mrbottomcenter-${this.props.index}`).textContent = `P`;\n        document.getElementById(`mrleftcenter-${this.props.index}`).textContent = `R`;\n        document.getElementById(`mrrightcenter-${this.props.index}`).textContent = `L`;\n      } else if (this.mprPlane === 'coronal') {\n        document.getElementById(`mrtopcenter-${this.props.index}`).textContent = `S`;\n        document.getElementById(`mrbottomcenter-${this.props.index}`).textContent = `I`;\n        document.getElementById(`mrleftcenter-${this.props.index}`).textContent = `R`;\n        document.getElementById(`mrrightcenter-${this.props.index}`).textContent = `L`;\n      }\n\n      if (this.isDicom && this.state.visibleCinePlayer && this.numberOfFrames > 1) {\n        document.getElementById(`frameLabel-${this.props.index}`).textContent = `${this.state.frame} / ${this.numberOfFrames}`;\n\n        if (this.state.inPlay) {\n          let frame = this.state.frame === this.numberOfFrames ? 1 : this.state.frame + 1;\n          this.setState({\n            frame: frame\n          });\n        }\n      }\n    };\n\n    this.onMeasurementModified = e => {//console.log('cornerstonetoolsmeasurementmodified: ', e.detail.measurementData)\n    };\n\n    this.onMeasurementAdded = e => {\n      //console.log('cornerstonetoolsmeasurementadded: ', e.detail.measurementData)\n      if (this.props.tool !== \"Angle\") return;\n      const measure = {\n        tool: this.props.tool,\n        note: '',\n        data: e.detail.measurementData\n      };\n      this.measurementSave(measure);\n      this.props.setActiveMeasurements(this.measurements);\n    };\n\n    this.onMeasurementCompleted = e => {\n      //console.log('cornerstonetoolsmeasurementcompleted: ', e.detail.measurementData)\n      const measure = {\n        tool: this.props.tool,\n        note: '',\n        data: e.detail.measurementData\n      };\n\n      if (this.props.tool === \"FreehandRoi\") {\n        setTimeout(() => {\n          this.measurementSave(measure);\n          this.props.setActiveMeasurements(this.measurements);\n        }, 500);\n      } else {\n        this.measurementSave(measure);\n        this.props.setActiveMeasurements(this.measurements);\n      }\n    };\n\n    this.onErrorOpenImageClose = () => {\n      this.setState({\n        errorOnOpenImage: null\n      });\n    };\n\n    this.onErrorCorsClose = () => {\n      this.setState({\n        errorOnCors: false\n      });\n    };\n\n    this.displayImageFromFilesByImage = (index, image) => {\n      const element = this.dicomImage;\n      cornerstone.enable(element);\n      cornerstone.displayImage(element, image);\n    };\n\n    this.displayImageFromFilesMohammad = _files => {\n      // console.log('displayImageFromFiles: ', index);\n      // console.log('files: ', this.props.files);\n      // const files = this.files === null ? this.props.files : this.files\n      let files = _files; // console.log('displayImageFromFiles - this.files: ', this.files)\n      // MOHAMMAD\n\n      let imageIds = [];\n\n      for (let i = 0; i < files.length; i++) {\n        // imageIds.push(files[i].imageId);\n        imageIds.push(cornerstoneWADOImageLoader.wadouri.fileManager.add(files[i]));\n        console.log('file -- ', files[i]);\n        console.log('files image id-- ', cornerstoneWADOImageLoader.wadouri.fileManager.add(files[i]));\n      }\n\n      let stack = {\n        currentImageIdIndex: 0,\n        imageIds\n      }; // const image = this.props.files[index].image;\n      // const imageId = this.props.files[index].imageId;\n      // this.filename = this.props.files[index].name;\n\n      let image = files[0].image;\n      let imageId = files[0].imageId;\n      this.filename = files[0].name;\n      let element = this.dicomImage;\n      element.addEventListener(\"cornerstonenewimage\", this.onNewImage);\n      element.addEventListener(\"cornerstoneimagerendered\", this.onImageRendered);\n      element.addEventListener(\"cornerstonetoolsmeasurementadded\", this.onMeasurementAdded);\n      element.addEventListener(\"cornerstonetoolsmeasurementmodified\", this.onMeasurementModified);\n      element.addEventListener(\"cornerstonetoolsmeasurementcompleted\", this.onMeasurementCompleted);\n      cornerstone.enable(element); // this.image = image;\n      // this.isDicom = true;\n      // this.PatientsName = image.data.string('x00100010');\n      // this.sopInstanceUid = this.getSopInstanceUID();\n      // let stack = { currentImageIdIndex: 0, imageIds: \"\" };\n      // this.numberOfFrames = image.data.intString('x00280008');\n      // if (this.numberOfFrames > 0) {\n      //   let imageIds = [];\n      //   for(var i=0; i < this.numberOfFrames; ++i) {\n      //     imageIds.push(imageId + \"?frame=\"+i)\n      //   }\n      //   stack.imageIds = imageIds\n      // }\n      // MOHAMMAD\n      // Add our tool, and set it's mode\n\n      const StackScrollMouseWheelTool = cornerstoneTools.StackScrollMouseWheelTool;\n      cornerstone.loadImage(imageIds[0]).then(image => {\n        this.image = image;\n        this.isDicom = true;\n        cornerstone.displayImage(element, image);\n        this.mprPlanePosition();\n        cornerstoneTools.addStackStateManager(element, ['stack']);\n        cornerstoneTools.addToolState(element, 'stack', stack);\n      });\n      cornerstoneTools.addTool(StackScrollMouseWheelTool);\n      cornerstoneTools.setToolActive('StackScrollMouseWheel', {}); // cornerstone.displayImage(element, image);\n      // let viewport = cornerstone.getViewport(this.dicomImage)\n      // let lut =  cornerstone.generateLut(this.image, viewport.voi.windowWidth, viewport.voi.windowCenter, viewport.invert, viewport.modalityLUT, viewport.voiLUT)\n      // this.props.setLutStore(lut)\n      // this.mprPlanePosition();\n\n      this.props.setActiveDcm({\n        image: this.image,\n        element: this.dicomImage,\n        isDicom: this.isDicom\n      }); // this.props.isOpenStore(true);\n\n      this.props.setIsOpenStore({\n        index: this.props.index,\n        value: true\n      });\n      this.enableTool(); // if (this.numberOfFrames > 1) {\n      //   cornerstoneTools.addStackStateManager(element, ['stack', 'playClip']);\n      //   cornerstoneTools.addToolState(element, 'stack', stack);\n      //   this.setState({frame: 1})\n      // }\n      // Load the possible measurements from DB and save in the store\n      // db.measurement.where('sopinstanceuid').equals(this.sopInstanceUid).each(measure => {\n      //   console.log('load measure from db: ', measure);\n      //   this.measurementSave(measure);\n      //   cornerstoneTools.addToolState(element, measure.tool, measure.data);\n      //   this.runTool(measure.tool);\n      //   cornerstone.updateImage(element);\n      //   cornerstoneTools.setToolEnabled(measure.tool)\n      // }).then(() => {\n      //   this.props.setActiveMeasurements(this.measurements);\n      //   this.props.setActiveDcm({image: this.image, element: this.dicomImage, isDicom: this.isDicom});\n      //   this.props.setIsOpenStore({index: this.props.index, value: true})\n      // })\n      //this.overlayImage()\n    };\n\n    this.displayImageFromFiles = index => {\n      // console.log('displayImageFromFiles: ', index);\n      // console.log('files: ', this.props.files);\n      const files = this.files === null ? this.props.files : this.files; // let files = _files;\n      // console.log('displayImageFromFiles - this.files: ', this.files)\n      // MOHAMMAD\n\n      let imageIds = [];\n\n      for (let i = 0; i < files.length; i++) {\n        imageIds.push(files[i].imageId); // imageIds.push(cornerstoneWADOImageLoader.wadouri.fileManager.add(files[i]));\n        // console.log('file -- ' ,files[i]);\n        // console.log('files image id-- ' ,cornerstoneWADOImageLoader.wadouri.fileManager.add(files[i]));\n      }\n\n      let stack = {\n        currentImageIdIndex: 0,\n        imageIds\n      };\n      const image = this.props.files[index].image;\n      const imageId = this.props.files[index].imageId;\n      this.filename = this.props.files[index].name; // const image = files[0].image;\n      // const imageId = files[0].imageId;\n      // this.filename = files[0].name;\n\n      const element = this.dicomImage;\n      element.addEventListener(\"cornerstonenewimage\", this.onNewImage);\n      element.addEventListener(\"cornerstoneimagerendered\", this.onImageRendered);\n      element.addEventListener(\"cornerstonetoolsmeasurementadded\", this.onMeasurementAdded);\n      element.addEventListener(\"cornerstonetoolsmeasurementmodified\", this.onMeasurementModified);\n      element.addEventListener(\"cornerstonetoolsmeasurementcompleted\", this.onMeasurementCompleted);\n      cornerstone.enable(element);\n      this.image = image;\n      this.isDicom = true;\n      this.PatientsName = image.data.string('x00100010');\n      this.sopInstanceUid = this.getSopInstanceUID(); // let stack = { currentImageIdIndex: 0, imageIds: \"\" };\n      // this.numberOfFrames = image.data.intString('x00280008');\n      // if (this.numberOfFrames > 0) {\n      //   let imageIds = [];\n      //   for(var i=0; i < this.numberOfFrames; ++i) {\n      //     imageIds.push(imageId + \"?frame=\"+i)\n      //   }\n      //   stack.imageIds = imageIds\n      // }\n      // MOHAMMAD\n      // Add our tool, and set it's mode\n\n      const StackScrollMouseWheelTool = cornerstoneTools.StackScrollMouseWheelTool;\n      cornerstone.loadImage(imageIds[0]).then(image => {\n        cornerstone.displayImage(element, image);\n        cornerstoneTools.addStackStateManager(element, ['stack']);\n        cornerstoneTools.addToolState(element, 'stack', stack);\n      });\n      cornerstoneTools.addTool(StackScrollMouseWheelTool);\n      cornerstoneTools.setToolActive('StackScrollMouseWheel', {}); // cornerstone.displayImage(element, image);\n\n      /*const viewport = cornerstone.getViewport(this.dicomImage)\n      const lut =  cornerstone.generateLut(this.image, viewport.voi.windowWidth, viewport.voi.windowCenter, viewport.invert, viewport.modalityLUT, viewport.voiLUT)\n      this.props.setLutStore(lut)*/\n      // this.mprPlanePosition();\n\n      this.enableTool(); // if (this.numberOfFrames > 1) {\n      //   cornerstoneTools.addStackStateManager(element, ['stack', 'playClip']);\n      //   cornerstoneTools.addToolState(element, 'stack', stack);\n      //   this.setState({frame: 1})\n      // }\n      // Load the possible measurements from DB and save in the store\n\n      db.measurement.where('sopinstanceuid').equals(this.sopInstanceUid).each(measure => {\n        console.log('load measure from db: ', measure);\n        this.measurementSave(measure);\n        cornerstoneTools.addToolState(element, measure.tool, measure.data);\n        this.runTool(measure.tool);\n        cornerstone.updateImage(element);\n        cornerstoneTools.setToolEnabled(measure.tool);\n      }).then(() => {\n        this.props.setActiveMeasurements(this.measurements);\n        this.props.setActiveDcm({\n          image: this.image,\n          element: this.dicomImage,\n          isDicom: this.isDicom\n        });\n        this.props.setIsOpenStore({\n          index: this.props.index,\n          value: true\n        });\n      }); //this.overlayImage()\n    };\n\n    this.loadImageFromCanvas = canvas => {\n      console.log('loadImageFromCanvas, dcmViewer: ', this.props.index);\n      const element = this.dicomImage;\n      element.addEventListener(\"cornerstonenewimage\", this.onNewImage);\n      element.addEventListener(\"cornerstoneimagerendered\", this.onImageRendered);\n      element.addEventListener(\"cornerstonetoolsmeasurementadded\", this.onMeasurementAdded);\n      element.addEventListener(\"cornerstonetoolsmeasurementmodified\", this.onMeasurementModified);\n      element.addEventListener(\"cornerstonetoolsmeasurementcompleted\", this.onMeasurementCompleted);\n      cornerstone.enable(element);\n      const imageId = cornerstoneFileImageLoader.fileManager.addCanvas(canvas);\n      cornerstone.loadImage(imageId).then(image => {\n        //this.t1 = performance.now()\n        //console.log(`performance load image: ${this.t1-this.t0} milliseconds`)\n        console.log('loadImageFromCanvas, image: ', image);\n        this.image = image;\n        this.isDicom = false;\n        cornerstone.displayImage(element, image);\n        this.enableTool(); //this.props.setActiveDcm({image: this.image, element: this.dicomImage, isDicom: this.isDicom})\n\n        this.props.setIsOpenStore({\n          index: this.props.index,\n          value: true\n        }); //this.t2 = performance.now()\n        //console.log(`performance: ${this.t2-this.t1} milliseconds`)\n        //this.overlayImage()\n      }, e => {\n        console.log('error', e);\n        this.setState({\n          errorOnOpenImage: \"This is not a valid canvas.\"\n        });\n      });\n    };\n\n    this.loadImageFromCustomObject = (columns, rows, pixelData) => {\n      //console.log('loadImageFromCustomObject: ')\n      const element = this.dicomImage;\n      element.addEventListener(\"cornerstonenewimage\", this.onNewImage);\n      element.addEventListener(\"cornerstoneimagerendered\", this.onImageRendered);\n      element.addEventListener(\"cornerstonetoolsmeasurementadded\", this.onMeasurementAdded);\n      element.addEventListener(\"cornerstonetoolsmeasurementmodified\", this.onMeasurementModified);\n      element.addEventListener(\"cornerstonetoolsmeasurementcompleted\", this.onMeasurementCompleted);\n      cornerstone.enable(element);\n      let customObj = {\n        rows: rows,\n        columns: columns,\n        pixelData: pixelData,\n        image: this.originImage\n      };\n      const imageId = cornerstoneFileImageLoader.fileManager.addCustom(customObj);\n      cornerstone.loadImage(imageId).then(image => {\n        //console.log('loadImageFromCustomObject, image: ', image)\n        this.image = image;\n        this.isDicom = true;\n        cornerstone.displayImage(element, image); //this.enableTool()\n\n        this.props.setIsOpenStore({\n          index: this.props.index,\n          value: true\n        });\n      }, e => {\n        console.log('error', e);\n        this.setState({\n          errorOnOpenImage: \"This is not a valid canvas.\"\n        });\n      });\n    };\n\n    this.loadImage = (localfile, url = undefined, fsItem = undefined) => {\n      console.log('loadImage, localfile: ', localfile);\n      console.log('loadImage, fsItem: ', fsItem);\n      console.log('loadImage, url: ', url);\n      if (localfile === undefined && url === undefined && fsItem === undefined) return;\n\n      if (fsItem !== undefined) {\n        this.fsItem = fsItem;\n      } else if (localfile !== undefined) {\n        this.localfile = localfile;\n      } else {\n        this.localurl = url;\n      }\n\n      const element = this.dicomImage;\n      element.addEventListener(\"cornerstonenewimage\", this.onNewImage);\n      element.addEventListener(\"cornerstoneimagerendered\", this.onImageRendered);\n      element.addEventListener(\"cornerstonetoolsmeasurementadded\", this.onMeasurementAdded);\n      element.addEventListener(\"cornerstonetoolsmeasurementmodified\", this.onMeasurementModified);\n      element.addEventListener(\"cornerstonetoolsmeasurementcompleted\", this.onMeasurementCompleted);\n      let imageId = undefined;\n      cornerstone.enable(element);\n      let size = 0;\n\n      if (localfile === undefined && isUrlImage(url)) {\n        // check if it's a simple image [jpeg or png] from url\n        //console.log('image: ', file)\n        cornerstone.loadImage(url).then(image => {\n          //console.log('loadImage, image from url: ', image)\n          this.hideOpenUrlDlg();\n          this.image = image;\n          this.isDicom = false;\n          cornerstone.displayImage(element, image);\n          this.enableTool();\n          this.props.setActiveDcm({\n            image: this.image,\n            element: this.dicomImage,\n            isDicom: this.isDicom\n          });\n          this.props.isOpenStore(true);\n        }, e => {\n          console.log('error', e);\n          this.setState({\n            errorOnOpenImage: \"This is not a valid JPG or PNG file.\"\n          });\n        });\n      } else if (localfile !== undefined && isFileImage(localfile) || fsItem !== undefined && isFsFileImage(fsItem)) {\n        // otherwise try to open as local image file (JPEG, PNG)\n        if (fsItem !== undefined) {\n          imageId = cornerstoneFileImageLoader.fileManager.addBuffer(fsItem.data);\n        } else {\n          imageId = cornerstoneFileImageLoader.fileManager.add(localfile);\n        }\n\n        cornerstone.loadImage(imageId).then(image => {\n          // console.log('loadImage, image from local: ', image);\n          this.image = image;\n          this.isDicom = false;\n          this.PatientsName = ''; // console.log(\"image data:\" + image.data);\n\n          cornerstone.displayImage(element, image);\n          this.enableTool();\n          this.props.setActiveDcm({\n            image: this.image,\n            element: this.dicomImage,\n            isDicom: this.isDicom\n          }); //this.props.isOpenStore(true)\n\n          this.props.setIsOpenStore({\n            index: this.props.index,\n            value: true\n          });\n        }, e => {\n          console.log('error', e);\n          this.setState({\n            errorOnOpenImage: \"This is not a valid JPG or PNG file.\"\n          });\n        });\n      } else {\n        // otherwise try to open as Dicom file\n        if (fsItem !== undefined) {\n          imageId = cornerstoneWADOImageLoader.wadouri.fileManager.addBuffer(fsItem.data);\n          this.filename = fsItem.name;\n          size = fsItem.size;\n        } else if (localfile !== undefined) {\n          imageId = cornerstoneWADOImageLoader.wadouri.fileManager.add(localfile);\n          this.filename = localfile.name;\n          size = localfile.size;\n        } else {\n          // it's a web dicom image\n          imageId = \"wadouri:\" + url;\n        } // console.log('loadImage, imageId: ', imageId);\n\n\n        cornerstone.loadAndCacheImage(imageId).then(image => {\n          console.log('loadImage, image: ', image); // let pixelDataElement = image.data.elements.x7fe00010;\n          // console.log('loadImage, pixelDataElement: ', pixelDataElement);\n          // console.log('loadImage, getPixelData: ', image.getPixelData());\n\n          this.hideOpenUrlDlg();\n          this.image = image;\n          this.isDicom = true;\n          let dataSet = dicomParser.parseDicom(image.data.byteArray);\n          console.log('image dataset -----: ' + dataSet.string('x00200011'));\n          console.log('Series Number: ' + image.data.string('x00200011'));\n          this.PatientsName = image.data.string('x00100010');\n          console.log('PatientsName: ' + this.PatientsName);\n          this.sopInstanceUid = this.getSopInstanceUID();\n          let stack = {\n            currentImageIdIndex: 0,\n            imageIds: \"\"\n          };\n          this.numberOfFrames = image.data.intString('x00280008');\n\n          if (this.numberOfFrames > 0) {\n            let imageIds = [];\n\n            for (var i = 0; i < this.numberOfFrames; ++i) {\n              imageIds.push(imageId + \"?frame=\" + i);\n            }\n\n            stack.imageIds = imageIds;\n          }\n\n          cornerstone.displayImage(element, image); //cornerstoneTools.mouseInput.enable(element);\n          //cornerstoneTools.mouseWheelInput.enable(element);\n\n          this.enableTool();\n          /*const viewport = cornerstone.getViewport(this.dicomImage)\n          const lut =  cornerstone.generateLut(this.image, viewport.voi.windowWidth, viewport.voi.windowCenter, viewport.invert, viewport.modalityLUT, viewport.voiLUT)\n          console.log('lut: ', lut)*/\n\n          if (this.numberOfFrames > 1) {\n            cornerstoneTools.addStackStateManager(element, ['stack', 'playClip']);\n            cornerstoneTools.addToolState(element, 'stack', stack); //cornerstoneTools.setToolActive('StackScrollMouseWheel', { })\n\n            this.setState({\n              frame: 1\n            });\n          } // Load the possible measurements from DB and save in the store\n\n\n          db.measurement.where('sopinstanceuid').equals(this.sopInstanceUid).each(measure => {\n            console.log('load measure from db: ', measure); //this.props.measurementStore(measure)\n\n            this.measurementSave(measure);\n            cornerstoneTools.addToolState(element, measure.tool, measure.data);\n            this.runTool(measure.tool);\n            cornerstone.updateImage(element);\n            cornerstoneTools.setToolEnabled(measure.tool);\n          }).then(() => {\n            //console.log('this.measurements: ', this.measurements)\n            this.props.setActiveMeasurements(this.measurements);\n            this.props.setActiveDcm({\n              name: this.filename,\n              size: size,\n              image: this.image,\n              element: this.dicomImage,\n              isDicom: this.isDicom\n            });\n            this.props.setIsOpenStore({\n              index: this.props.index,\n              value: true\n            });\n          });\n        }, e => {\n          console.log('error', e);\n          this.hideOpenUrlDlg(); //console.log('toString: ', e.error.toString())\n\n          const error = e.error.toString();\n\n          if (error === '[object XMLHttpRequest]') {\n            this.setState({\n              errorOnCors: true\n            });\n          } else {\n            const pos = error.indexOf(\":\");\n            this.setState({\n              errorOnOpenImage: pos < 0 ? e.error : error.substring(pos + 1)\n            });\n          }\n        });\n      }\n    };\n\n    this.enableTool = (toolName, mouseButtonNumber) => {\n      // Enable all tools we want to use with this element\n      const WwwcTool = cornerstoneTools.WwwcTool;\n      const LengthTool = cornerstoneTools['LengthTool'];\n      const PanTool = cornerstoneTools.PanTool;\n      const ZoomTouchPinchTool = cornerstoneTools.ZoomTouchPinchTool;\n      const ZoomTool = cornerstoneTools.ZoomTool;\n      const ProbeTool = cornerstoneTools.ProbeTool;\n      const EllipticalRoiTool = cornerstoneTools.EllipticalRoiTool;\n      const RectangleRoiTool = cornerstoneTools.RectangleRoiTool;\n      const FreehandRoiTool = cornerstoneTools.FreehandRoiTool;\n      const AngleTool = cornerstoneTools.AngleTool;\n      const MagnifyTool = cornerstoneTools.MagnifyTool;\n      const StackScrollMouseWheelTool = cornerstoneTools.StackScrollMouseWheelTool;\n      cornerstoneTools.addTool(MagnifyTool);\n      cornerstoneTools.addTool(AngleTool);\n      cornerstoneTools.addTool(WwwcTool);\n      cornerstoneTools.addTool(LengthTool);\n      cornerstoneTools.addTool(PanTool);\n      cornerstoneTools.addTool(ZoomTouchPinchTool);\n      cornerstoneTools.addTool(ZoomTool);\n      cornerstoneTools.addTool(ProbeTool);\n      cornerstoneTools.addTool(EllipticalRoiTool);\n      cornerstoneTools.addTool(RectangleRoiTool);\n      cornerstoneTools.addTool(FreehandRoiTool);\n      cornerstoneTools.addTool(StackScrollMouseWheelTool);\n    };\n\n    this.disableAllTools = () => {\n      cornerstoneTools.setToolEnabled('Length');\n      cornerstoneTools.setToolEnabled('Pan');\n      cornerstoneTools.setToolEnabled('Magnify');\n      cornerstoneTools.setToolEnabled('Angle');\n      cornerstoneTools.setToolEnabled('RectangleRoi');\n      cornerstoneTools.setToolEnabled('Wwwc');\n      cornerstoneTools.setToolEnabled('ZoomTouchPinch');\n      cornerstoneTools.setToolEnabled('Probe');\n      cornerstoneTools.setToolEnabled('EllipticalRoi');\n      cornerstoneTools.setToolEnabled('FreehandRoi');\n      cornerstoneTools.setToolEnabled('StackScrollMouseWheel');\n    };\n\n    this.runTool2 = (index, image) => {\n      cornerstone.disable(this.dicomImage);\n      this.displayImageFromFilesByImage(index, image);\n    };\n\n    this.runTool = (toolName, opt) => {\n      //console.log('run tool: ', toolName)\n      // this.disableAllTools()\n      switch (toolName) {\n        case 'openImage':\n          {\n            cornerstone.disable(this.dicomImage); // this.displayImageFromFilesByImage(opt);\n\n            break;\n          }\n\n        case 'openimage':\n          {\n            //console.log('openimage: ', opt)\n            //console.log('openimage, this.dicomImage: ', this.dicomImage)\n            cornerstone.disable(this.dicomImage);\n            this.displayImageFromFiles(opt);\n            break;\n          }\n\n        case 'Mohammad':\n          {\n            cornerstone.disable(this.dicomImage);\n            this.displayImageFromFilesMohammad(opt);\n            break;\n          }\n        // case 'openLocalFs': {\n        //   console.log('openLocalFs: ', opt);\n        //   cornerstone.disable(this.dicomImage);\n        //   // this.loadImage(opt);\n        //   break\n        // }\n\n        case 'openSandboxFs':\n          {\n            console.log('openSandboxFs: ', opt);\n            cornerstone.disable(this.dicomImage);\n            this.setState({\n              file: opt\n            });\n            this.loadImage(undefined, undefined, opt);\n            break;\n          }\n\n        case 'openurl':\n          {\n            //console.log('run tool opt: ', opt)\n            this.showOpenUrlDlg(opt);\n            break;\n          }\n\n        case 'clear':\n          {\n            this.setState({\n              visibleCinePlayer: false\n            });\n            this.mprPlane = ''; //this.props.clearingStore()\n\n            cornerstone.disable(this.dicomImage);\n            break;\n          }\n\n        case 'notool':\n          {\n            this.disableAllTools(); //const element = this.dicomImage\n            //cornerstoneTools.clearToolState(element, 'Length')\n            //const toolStateManager = cornerstoneTools.getElementToolStateManager(element)\n            //console.log('toolStateManager.toolState: ', toolStateManager.toolState)\n\n            /*\n            const toolState = toolStateManager.toolState\n            // const allTools = Object.keys(toolState).map(key => toolState[key])\n            let key = Object.keys(toolState)[0]\n            let allTools = toolState[key]\n            //console.log('allTools: ', allTools)\n             for (let [tool, data] of Object.entries(allTools)) {\n              //console.log(`${tool}: `, data)\n              let key = Object.keys(data)[0]\n              let tools = data[key]\n              //console.log('tools: ', tools)\n              tools.forEach(item => {\n                //console.log('tool: ', tool)\n                //console.log(item)\n                const measure = {\n                  tool: tool,\n                  note: '',\n                  data: item\n                }\n                console.log('measure: ', measure)\n                this.props.measurementStore(measure)\n              })\n            }\n            */\n            //const toolState = toolStateManager.get(element, 'Length')\n            //console.log('toolState: ', toolState)\n\n            /*\n            const measurementData = {\n              visible: true,\n              active: true,\n              invalidated: true,\n              handles: {\n                  start: {\n                      x: 100,\n                      y: 100,\n                      highlight: true,\n                      active: false\n                  },\n                  end: {\n                      x: 200,\n                      y: 200,\n                      highlight: true,\n                      active: true\n                  },\n                  textBox: {\n                      active: false,\n                      hasMoved: false,\n                      movesIndependently: false,\n                      drawnIndependently: true,\n                      allowedOutsideImage: true,\n                      hasBoundingBox: true\n                  }\n                }\n            }\n            cornerstoneTools.addToolState(element, 'RectangleRoi', measurementData)\n            cornerstoneTools.setToolActive('RectangleRoi', { mouseButtonMask: 1 })\n            */\n            //cornerstone.updateImage(element)\n\n            break;\n          }\n\n        case 'Wwwc':\n          {\n            cornerstoneTools.setToolActive('Wwwc', {\n              mouseButtonMask: 1\n            });\n            break;\n          }\n\n        case 'Pan':\n          {\n            cornerstoneTools.setToolActive('Pan', {\n              mouseButtonMask: 1\n            });\n            break;\n          }\n\n        case 'Zoom':\n          {\n            cornerstoneTools.setToolActive(isMobile ? 'ZoomTouchPinch' : 'Zoom', {\n              mouseButtonMask: 1\n            });\n            break;\n          }\n\n        case 'Length':\n          {\n            cornerstoneTools.setToolActive('Length', isMobile ? {\n              isTouchActive: true\n            } : {\n              mouseButtonMask: 1\n            });\n            break;\n          }\n\n        case 'Probe':\n          {\n            cornerstoneTools.setToolActive('Probe', {\n              mouseButtonMask: 1\n            });\n            break;\n          }\n\n        case 'EllipticalRoi':\n          {\n            cornerstoneTools.setToolActive('EllipticalRoi', {\n              mouseButtonMask: 1\n            });\n            break;\n          }\n\n        case 'RectangleRoi':\n          {\n            cornerstoneTools.setToolActive('RectangleRoi', {\n              mouseButtonMask: 1\n            });\n            break;\n          }\n\n        case 'Angle':\n          {\n            cornerstoneTools.setToolActive('Angle', {\n              mouseButtonMask: 1\n            });\n            break;\n          }\n\n        case 'Magnify':\n          {\n            cornerstoneTools.setToolActive('Magnify', {\n              mouseButtonMask: 1\n            });\n            break;\n          }\n\n        case 'FreehandRoi':\n          {\n            cornerstoneTools.setToolActive('FreehandRoi', {\n              mouseButtonMask: 1\n            });\n            break;\n          }\n\n        case 'Invert':\n          {\n            const element = this.dicomImage;\n            const viewport = cornerstone.getViewport(element);\n            viewport.invert = !viewport.invert;\n            cornerstone.setViewport(element, viewport);\n            break;\n          }\n\n        case 'saveas':\n          {\n            let type = localStorage.getItem(SETTINGS_SAVEAS);\n\n            if (getSettingsSaveInto() === 'local') {\n              // cornerstoneTools.SaveAs(this.dicomImage, `${this.filename}.${type}`, `image/${type}`)\n              const element = this.dicomImage;\n              const viewport = cornerstone.getViewport(element);\n              const canvas = document.getElementsByClassName('cornerstone-canvas')[this.props.activeDcmIndex];\n              const zoom = viewport.scale.toFixed(2);\n              const cols = this.image.columns * zoom;\n              const rows = this.image.rows * zoom;\n              let myCanvas = document.createElement('canvas');\n              myCanvas = this.cropCanvas(canvas, Math.round(canvas.width / 2 - cols / 2), Math.round(canvas.height / 2 - rows / 2), cols, rows);\n              let a = document.createElement(\"a\");\n              a.href = myCanvas.toDataURL(`image/${type}`);\n              a.download = `${this.filename}.${type}`;\n              document.body.appendChild(a); // Required for this to work in FireFox\n\n              a.click();\n            } else {\n              // store image into sandbox file system\n              const element = this.dicomImage;\n              const viewport = cornerstone.getViewport(element);\n              const canvas = document.getElementsByClassName('cornerstone-canvas')[this.props.activeDcmIndex];\n              const zoom = viewport.scale.toFixed(2);\n              const cols = this.image.columns * zoom;\n              const rows = this.image.rows * zoom;\n              let myCanvas = document.createElement('canvas');\n              myCanvas = this.cropCanvas(canvas, Math.round(canvas.width / 2 - cols / 2), Math.round(canvas.height / 2 - rows / 2), cols, rows);\n              blobUtil.canvasToBlob(myCanvas, `image/${type}`).then(blob => {\n                blobUtil.blobToArrayBuffer(blob).then(arrayBuffer => {\n                  const name = `${getFileName(this.filename)}-MPR-${this.mprPlane}`;\n                  let newName = name;\n                  let counter = 1;\n                  let done = false;\n\n                  do {\n                    let filename = `${newName}.${type}`;\n                    const checkName = this.props.fsCurrentList.find(e => e.name === filename);\n\n                    if (checkName === undefined) {\n                      fs.transaction('rw', fs.files, async () => {\n                        await fs.files.add({\n                          parent: this.props.fsCurrentDir,\n                          name: filename,\n                          type: type,\n                          size: arrayBuffer.byteLength,\n                          data: arrayBuffer\n                        });\n                      }).then(() => {\n                        this.props.makeFsRefresh();\n                      });\n                      done = true;\n                    } else {\n                      newName = `${name} - ${counter}`;\n                      counter++;\n                    }\n                  } while (!done);\n                });\n              });\n            }\n\n            break;\n          }\n\n        case 'cine':\n          {\n            this.setState({\n              visibleCinePlayer: !this.state.visibleCinePlayer\n            });\n            break;\n          }\n\n        case 'reset':\n          {\n            this.reset();\n            break;\n          }\n\n        case 'removetool':\n          {\n            console.log('removetool index: ', opt);\n            const element = this.dicomImage;\n            cornerstoneTools.removeToolState(element, this.measurements[opt].tool, this.measurements[opt].data);\n            cornerstone.updateImage(element); //this.props.measurementRemoveStore(opt)\n\n            this.measurementRemove(opt);\n            this.props.setActiveMeasurements(this.measurements);\n            break;\n          }\n\n        case 'removetools':\n          {\n            const element = this.dicomImage; // for each measurement remove it\n\n            this.measurements.forEach(measure => {\n              cornerstoneTools.clearToolState(element, measure.tool);\n            });\n            cornerstone.updateImage(element);\n            this.measurementClear(); // also remove all measurements from db\n\n            db.measurement.where('sopinstanceuid').equals(this.sopInstanceUid).delete();\n            this.props.setActiveMeasurements(this.measurements);\n            break;\n          }\n\n        case 'savetools':\n          {\n            // first, remove eventually previous measurements from db\n            db.measurement.where('sopinstanceuid').equals(this.sopInstanceUid).delete(); // then save all the current measurements\n\n            this.measurements.forEach(measure => {\n              try {\n                db.measurement.add({\n                  sopinstanceuid: this.sopInstanceUid,\n                  tool: measure.tool,\n                  note: measure.note,\n                  data: measure.data\n                });\n              } catch (error) {\n                console.error(error);\n              }\n            });\n            break;\n          }\n\n        default:\n          {\n            break;\n          }\n      }\n    };\n\n    this.cropCanvas = (canvas, x, y, width, height) => {\n      console.log(`canvas: ${canvas.width}, ${canvas.height}`);\n      console.log(`x, y: ${x}, ${y}`);\n      console.log(`width, height: ${width}, ${height}`); // create a temp canvas\n\n      const newCanvas = document.createElement('canvas'); // set its dimensions\n\n      newCanvas.width = width;\n      newCanvas.height = height; // draw the canvas in the new resized temp canvas\n\n      newCanvas.getContext('2d').drawImage(canvas, x, y, width, height, 0, 0, width, height);\n      return newCanvas;\n    };\n\n    this.changeTool = (toolName, value) => {\n      console.log('change tool, value: ', toolName, value);\n\n      switch (toolName) {\n        case 'Wwwc':\n          if (value === 1) {\n            cornerstoneTools.setToolActive('Wwwc', {\n              mouseButtonMask: 1\n            });\n          } else if (value === 0) {\n            cornerstoneTools.setToolPassive('Wwwc');\n          }\n\n          break;\n\n        case 'Pan':\n          if (value === 1) {\n            cornerstoneTools.setToolActive('Pan', {\n              mouseButtonMask: 1\n            });\n          } else if (value === 0) {\n            cornerstoneTools.setToolPassive('Pan');\n          }\n\n          break;\n\n        case 'Zoom':\n          if (value === 1) {\n            cornerstoneTools.setToolActive(isMobile ? 'ZoomTouchPinch' : 'Zoom', {\n              mouseButtonMask: 1\n            });\n          } else if (value === 0) {\n            cornerstoneTools.setToolPassive(isMobile ? 'ZoomTouchPinch' : 'Zoom');\n          }\n\n          break;\n\n        case 'Length':\n          if (value === 1) {\n            cornerstoneTools.setToolActive('Length', isMobile ? {\n              isTouchActive: true\n            } : {\n              mouseButtonMask: 1\n            });\n          } else if (value === 0) {\n            cornerstoneTools.setToolPassive('Length');\n          }\n\n          break;\n\n        case 'Probe':\n          if (value === 1) {\n            cornerstoneTools.setToolActive('Probe', {\n              mouseButtonMask: 1\n            });\n          } else if (value === 0) {\n            cornerstoneTools.setToolPassive('Probe');\n          }\n\n          break;\n\n        case 'Angle':\n          if (value === 1) {\n            cornerstoneTools.setToolActive('Angle', {\n              mouseButtonMask: 1\n            });\n          } else if (value === 0) {\n            cornerstoneTools.setToolPassive('Angle');\n          }\n\n          break;\n\n        case 'Magnify':\n          if (value === 1) {\n            cornerstoneTools.setToolActive('Magnify', {\n              mouseButtonMask: 1\n            });\n          } else if (value === 0) {\n            cornerstoneTools.setToolPassive('Magnify');\n          }\n\n          break;\n\n        case 'EllipticalRoi':\n          if (value === 1) {\n            cornerstoneTools.setToolActive('EllipticalRoi', {\n              mouseButtonMask: 1\n            });\n          } else if (value === 0) {\n            cornerstoneTools.setToolPassive('EllipticalRoi');\n          }\n\n          break;\n\n        case 'RectangleRoi':\n          if (value === 1) {\n            cornerstoneTools.setToolActive('RectangleRoi', {\n              mouseButtonMask: 1\n            });\n          } else if (value === 0) {\n            cornerstoneTools.setToolPassive('RectangleRoi');\n          }\n\n          break;\n\n        case 'FreehandRoi':\n          if (value === 1) {\n            cornerstoneTools.setToolActive('FreehandRoi', {\n              mouseButtonMask: 1\n            });\n          } else if (value === 0) {\n            cornerstoneTools.setToolPassive('FreehandRoi');\n          }\n\n          break;\n\n        default:\n          break;\n      }\n    };\n\n    this.runCinePlayer = cmdName => {\n      //console.log('this.state.frame: ', this.state.frame)\n      const element = this.dicomImage;\n\n      switch (cmdName) {\n        case 'firstframe':\n          {\n            let frame = 1;\n            this.setState({\n              frame: frame\n            });\n            scrollToIndex(element, 0);\n            break;\n          }\n\n        case 'previousframe':\n          {\n            if (this.state.frame > 1) {\n              let frame = this.state.frame - 1;\n              this.setState({\n                frame: frame\n              });\n              scrollToIndex(element, frame - 1);\n            }\n\n            break;\n          }\n\n        case 'play':\n          {\n            cornerstoneTools.playClip(element, 30);\n            this.setState({\n              inPlay: true\n            });\n            break;\n          }\n\n        case 'pause':\n          {\n            cornerstoneTools.stopClip(element);\n            this.setState({\n              inPlay: false\n            });\n            break;\n          }\n\n        case 'nextframe':\n          {\n            if (this.state.frame < this.numberOfFrames) {\n              let frame = this.state.frame + 1;\n              this.setState({\n                frame: frame\n              });\n              scrollToIndex(element, frame - 1);\n            }\n\n            break;\n          }\n\n        case 'lastframe':\n          {\n            let frame = this.numberOfFrames;\n            this.setState({\n              frame: frame\n            });\n            scrollToIndex(element, frame - 1);\n            break;\n          }\n\n        default:\n          break;\n      }\n    };\n\n    this.reset = () => {\n      const element = this.dicomImage;\n      const defaultViewport = cornerstone.getDefaultViewportForImage(element, this.image);\n      let viewport = cornerstone.getViewport(element);\n      viewport.voi.windowWidth = defaultViewport.voi.windowWidth;\n      viewport.voi.windowCenter = defaultViewport.voi.windowCenter;\n      viewport.invert = false;\n      cornerstone.setViewport(element, viewport);\n    };\n\n    this.mprPlanePosition = () => {\n      //console.log(\"mprPlanePosition: \")\n      try {\n        console.log(\"is dicom:   \" + this.isDicom);\n        if (!this.isDicom) return this.mprPlane;\n        console.log(\"image data:   \" + this.image.data);\n        const imageOrientation = this.image.data.string('x00200037').split('\\\\');\n        console.log(\"image imageOrientation:   \" + imageOrientation);\n        let v = new Array(6).fill(0);\n        v[0] = parseFloat(imageOrientation[0]); // the x direction cosines of the first row X\n\n        v[1] = parseFloat(imageOrientation[1]); // the y direction cosines of the first row X\n\n        v[2] = parseFloat(imageOrientation[2]); // the z direction cosines of the first row X\n\n        v[3] = parseFloat(imageOrientation[3]); // the x direction cosines of the first column Y\n\n        v[4] = parseFloat(imageOrientation[4]); // the y direction cosines of the first column Y\n\n        v[5] = parseFloat(imageOrientation[5]); // the z direction cosines of the first column Y\n\n        v = v.map(x => Math.round(x));\n        let p = [v[1] * v[5] - v[2] * v[4], v[2] * v[3] - v[0] * v[5], v[0] * v[4] - v[1] * v[3]]; // cross product of X x Y\n\n        p = p.map(x => Math.abs(x));\n\n        if (p[0] === 1) {\n          this.mprPlane = 'sagittal';\n        } else if (p[1] === 1) {\n          this.mprPlane = 'coronal';\n        } else if (p[2] === 1) {\n          this.mprPlane = 'axial';\n        }\n      } catch (error) {\n        // it's not possible to build MPR\n        console.log('its not possible to build MPR');\n        this.mprPlane = '';\n      }\n\n      console.log(\"this.mprPlane: \" + this.mprPlane);\n      return this.mprPlane;\n    };\n\n    this.transpose = matrix => {\n      return Object.keys(matrix[0]).map(colNumber => matrix.map(rowNumber => rowNumber[colNumber]));\n    };\n\n    this.mprRenderYZPlane = (filename, origin, x, mprData) => {\n      if (this.volume === null) return;\n      this.filename = filename;\n      cornerstone.disable(this.dicomImage); //console.log(`mprRenderYZPlane, origin: ${origin}, x: ${x}`)\n      //console.log('mprRenderYZPlane, volume: ', this.volume)\n\n      if (origin === 'sagittal') this.mprPlane = 'coronal';else if (origin === 'axial') this.mprPlane = 'sagittal';else this.mprPlane = 'sagittal';\n      this.xSize = this.props.files[0].columns;\n      this.ySize = this.props.files[0].rows;\n      this.zSize = mprData.zDim;\n      const i = Math.round(x / this.xSize * this.props.files.length);\n      this.originImage = this.props.files[i].image;\n\n      if (origin === 'sagittal') {\n        let xoffset = Math.floor(this.xSize / 2) - Math.floor(this.zSize / 2);\n        let plane = new Int16Array(this.xSize * this.ySize);\n\n        for (let y = 0; y < this.ySize; y++) for (let z = 0; z < this.zSize; z++) plane[z + this.ySize * y + xoffset] = this.volume[z][x + this.ySize * y];\n\n        this.loadImageFromCustomObject(this.xSize, this.ySize, plane);\n      } else if (origin === 'coronal') {\n        let xoffset = Math.floor(this.xSize / 2) - Math.floor(this.zSize / 2);\n        let plane = new Int16Array(this.xSize * this.ySize);\n\n        for (let y = 0; y < this.ySize; y++) for (let z = 0; z < this.zSize; z++) plane[z + this.ySize * y + xoffset] = this.volume[z][x + this.ySize * y];\n\n        this.loadImageFromCustomObject(this.xSize, this.ySize, plane);\n      } else {\n        // axial\n        const yzPlane = this.mprBuildYZPlane(x);\n        this.loadImageFromCustomObject(this.ySize, this.zSize, yzPlane);\n      }\n    };\n\n    this.mprBuildYZPlane = x => {\n      //console.log(`mprBuildYZPlane, ySize: ${this.ySize}, zSize: ${this.zSize} `)\n      let plane = new Int16Array(this.ySize * this.zSize);\n\n      for (var y = 0; y < this.ySize; y++) for (var z = 0; z < this.zSize; z++) plane[y + this.ySize * z] = this.volume[z][x + this.ySize * y]; //console.log('mprBuildYZPlane, plane: ', plane)\n\n\n      return plane;\n    };\n\n    this.mprRenderXZPlane = (filename, origin, y, mprData) => {\n      if (this.volume === null) return;\n      this.filename = filename;\n      cornerstone.disable(this.dicomImage); //console.log(`mprRenderXZPlane, origin: ${origin}, y: ${y}`)\n      //console.log('mprRenderXZPlane, volume: ', this.volume)\n\n      if (origin === 'sagittal') this.mprPlane = 'axial';else if (origin === 'axial') this.mprPlane = 'coronal';else this.mprPlane = 'axial';\n      this.xSize = this.props.files[0].columns;\n      this.ySize = this.props.files[0].rows;\n      this.zSize = mprData.zDim;\n      const i = Math.trunc(y / this.ySize * this.props.files.length);\n      this.originImage = this.props.files[i].image;\n\n      if (origin === 'sagittal') {\n        let xoffset = Math.floor(this.xSize / 2) - Math.floor(this.zSize / 2);\n        let plane = new Int16Array(this.xSize * this.ySize);\n\n        for (let x = 0; x < this.xSize; x++) for (let z = 0; z < this.zSize; z++) plane[z + this.xSize * x + xoffset] = this.volume[z][x + this.xSize * y];\n\n        this.loadImageFromCustomObject(this.xSize, this.ySize, plane);\n      } else {\n        const xzPlane = this.mprBuildXZPlane(y);\n        this.loadImageFromCustomObject(this.xSize, this.zSize, xzPlane);\n      }\n    };\n\n    this.mprBuildXZPlane = y => {\n      //console.log(`mprBuildXZPlane, xSize: ${this.xSize}, zSize: ${this.zSize} `)\n      let plane = new Int16Array(this.xSize * this.zSize);\n\n      for (let x = 0; x < this.xSize; x++) for (let z = 0; z < this.zSize; z++) plane[x + this.xSize * z] = this.volume[z][x + this.xSize * y]; //console.log('mprBuildXZPlane, plane: ', plane)\n\n\n      return plane;\n    };\n\n    this.mprIsOrthogonalView = () => {\n      console.log('---------------------------------------');\n      console.log('mprPlane: ', this.mprPlane);\n      console.log('this.props.layout[0]: ', this.props.layout[0]);\n      console.log('this.props.layout[1]: ', this.props.layout[1]);\n      console.log('result: ' + (this.mprPlane !== '' && this.props.layout[0] === 1 && this.props.layout[1] === 3) ? 'true' : 'false');\n      console.log('---------------------------------------');\n      return this.mprPlane !== '' && this.props.layout[0] === 1 && this.props.layout[1] === 3;\n    };\n\n    this.dicomImageRef = el => {\n      this.dicomImage = el;\n    };\n\n    this.onImageClick = () => {\n      console.log('onImageClick: ');\n    };\n\n    this.filename = '';\n    this.localfile = null;\n    this.localurl = null;\n    this.fsItem = null;\n    this.dicomImage = null;\n    this.imageId = null;\n    this.image = null;\n    this.isDicom = false;\n    this.numberOfFrames = 1;\n    this.measurements = [];\n    this.xSize = 0;\n    this.ySize = 0;\n    this.zSize = 0;\n    this.volume = null;\n    this.originImage = null;\n    this.mprPlane = '';\n  }\n\n  componentDidMount() {\n    this.props.runTool(this); // this.props.runTool2(this);\n\n    this.props.changeTool(this);\n    cornerstone.events.addEventListener('cornerstoneimageloaded', this.onImageLoaded);\n    const dcmRef = this.props.dcmRef;\n    dcmRef(this);\n  }\n\n  componentWillUnmount() {\n    this.props.runTool(undefined); // this.props.runTool2(undefined);\n\n    this.props.changeTool(undefined);\n    const dcmRef = this.props.dcmRef;\n    dcmRef(undefined);\n  }\n\n  componentDidUpdate(previousProps) {\n    //console.log('dicomviewer - componentDidUpdate: ')\n\n    /*if (this.props.files !== null) {\n      console.log('this.props.files[0]: ', this.props.files[0])\n      console.log('this.props.files: ', this.props.files)\n    }*/\n\n    /*if (this.props.volume !== null) {\n      console.log('volume set: ', this.props.volume)\n      this.volume = this.props.volume\n    }*/\n    const isOpen = this.props.isOpen[this.props.index];\n\n    if (this.props.layout !== previousProps.layout && isOpen) {\n      cornerstone.resize(this.dicomImage);\n    }\n  }\n\n  render() {\n    //console.log('DicomViewer render: ')\n    //this.props.visible ? document.body.style = 'background: #000000;' : document.body.style = 'background: $md-grey-700;'\n    const isOpen = this.props.isOpen[this.props.index];\n    console.log('isOpen: ' + isOpen); //const visibleHistogram = this.state.visibleHistogram\n\n    const visibleOpenUrlDlg = this.state.visibleOpenUrlDlg;\n    const errorOnOpenImage = this.state.errorOnOpenImage;\n    const progress = this.state.progress;\n    const styleContainer = {\n      width: '100%',\n      height: '100%',\n      border: this.props.activeDcmIndex === this.props.index && (this.props.layout[0] > 1 || this.props.layout[1] > 1) ? 'solid 1px #AAAAAA' : null,\n      position: 'relative'\n    };\n    const styleDicomImage = {\n      width: '100%',\n      height: '100%',\n      position: 'relative'\n    };\n    const overlay = getSettingsOverlay();\n    console.log('overlay: ' + overlay);\n    return React.createElement(\"div\", {\n      className: \"container\",\n      style: styleContainer,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 1567\n      },\n      __self: this\n    }, visibleOpenUrlDlg ? React.createElement(OpenUrlDlg, {\n      progress: progress,\n      onClose: this.hideOpenUrlDlg,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 1569\n      },\n      __self: this\n    }) : null, React.createElement(Dialog, {\n      open: errorOnOpenImage !== null,\n      onClose: this.onErrorOpenImageClose,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 1571\n      },\n      __self: this\n    }, React.createElement(DialogTitle, {\n      id: \"alert-dialog-title\",\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 1575\n      },\n      __self: this\n    }, \"Error on opening image\"), React.createElement(DialogContent, {\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 1576\n      },\n      __self: this\n    }, React.createElement(DialogContentText, {\n      id: \"alert-dialog-description\",\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 1577\n      },\n      __self: this\n    }, this.state.errorOnOpenImage)), React.createElement(DialogActions, {\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 1581\n      },\n      __self: this\n    }, React.createElement(Button, {\n      onClick: this.onErrorOpenImageClose,\n      autoFocus: true,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 1582\n      },\n      __self: this\n    }, \"Ok\"))), React.createElement(Dialog, {\n      open: this.state.errorOnCors,\n      onClose: this.onErrorCorsClose,\n      \"aria-labelledby\": \"alert-dialog-title\",\n      \"aria-describedby\": \"alert-dialog-description\",\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 1588\n      },\n      __self: this\n    }, React.createElement(DialogTitle, {\n      id: \"alert-dialog-title\",\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 1594\n      },\n      __self: this\n    }, \"Error on loading image\"), React.createElement(DialogContent, {\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 1595\n      },\n      __self: this\n    }, React.createElement(DialogContentText, {\n      id: \"alert-dialog-description\",\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 1596\n      },\n      __self: this\n    }, React.createElement(Typography, {\n      gutterBottom: true,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 1597\n      },\n      __self: this\n    }, \"CORS or Cross Origin Resource Sharing is a browser security policy that prevents javascript from loading data from a server with a different base URL than the server that served up the javascript file.\"), React.createElement(Typography, {\n      gutterBottom: true,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 1602\n      },\n      __self: this\n    }, \"See the \\xA0\", React.createElement(Link, {\n      href: \"http://enable-cors.org/\",\n      target: \"_blank\",\n      color: \"textPrimary\",\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 1604\n      },\n      __self: this\n    }, \"Enable CORS site\"), \"\\xA0 for information about CORS.\"))), React.createElement(DialogActions, {\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 1611\n      },\n      __self: this\n    }, React.createElement(Button, {\n      onClick: this.onErrorCorsClose,\n      autoFocus: true,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 1612\n      },\n      __self: this\n    }, \"Ok\"))), React.createElement(\"div\", {\n      style: {\n        width: '100%',\n        height: '100%',\n        position: \"relative\",\n        color: '#FFFFFF',\n        textShadow: '1px 1px #000000'\n      },\n      onContextMenu: () => false,\n      className: \"cornerstone-enabled-image\",\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 1618\n      },\n      __self: this\n    }, React.createElement(\"div\", {\n      ref: this.dicomImageRef,\n      style: styleDicomImage,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 1629\n      },\n      __self: this\n    }), React.createElement(\"div\", {\n      id: `mrtopleft-${this.props.index}`,\n      style: {\n        position: \"absolute\",\n        top: 0,\n        left: 3,\n        display: isOpen && overlay ? \"\" : \"none\"\n      },\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 1634\n      },\n      __self: this\n    }), React.createElement(\"div\", {\n      id: `mrtopright-${this.props.index}`,\n      style: {\n        position: \"absolute\",\n        top: 0,\n        right: 3,\n        display: isOpen && overlay ? \"\" : \"none\"\n      },\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 1640\n      },\n      __self: this\n    }), React.createElement(\"div\", {\n      id: `mrbottomright-${this.props.index}`,\n      style: {\n        position: \"absolute\",\n        bottom: 0,\n        right: 3,\n        display: isOpen && overlay ? \"\" : \"none\"\n      },\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 1646\n      },\n      __self: this\n    }), React.createElement(\"div\", {\n      id: `mrbottomleft-${this.props.index}`,\n      style: {\n        position: \"absolute\",\n        bottom: 0,\n        left: 3,\n        display: isOpen && overlay ? \"\" : \"none\"\n      },\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 1652\n      },\n      __self: this\n    }), React.createElement(\"div\", {\n      id: `mrtopcenter-${this.props.index}`,\n      style: {\n        position: \"absolute\",\n        top: 0,\n        width: '60px',\n        left: '50%',\n        marginLeft: '0px',\n        display: isOpen && overlay ? \"\" : \"none\"\n      },\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 1659\n      },\n      __self: this\n    }), React.createElement(\"div\", {\n      id: `mrleftcenter-${this.props.index}`,\n      style: {\n        position: \"absolute\",\n        top: '50%',\n        width: '30px',\n        left: 3,\n        marginLeft: '0px',\n        display: isOpen && overlay ? \"\" : \"none\"\n      },\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 1666\n      },\n      __self: this\n    }), React.createElement(\"div\", {\n      id: `mrrightcenter-${this.props.index}`,\n      style: {\n        position: \"absolute\",\n        top: '50%',\n        width: '30px',\n        right: 3,\n        marginRight: '-20px',\n        display: isOpen && overlay ? \"\" : \"none\"\n      },\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 1673\n      },\n      __self: this\n    }), React.createElement(\"div\", {\n      id: `mrbottomcenter-${this.props.index}`,\n      style: {\n        position: \"absolute\",\n        bottom: 0,\n        width: '60px',\n        left: '50%',\n        marginLeft: '0px',\n        display: isOpen && overlay ? \"\" : \"none\"\n      },\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 1680\n      },\n      __self: this\n    }), this.state.visibleCinePlayer && this.numberOfFrames > 1 ? React.createElement(\"div\", {\n      style: {\n        position: \"absolute\",\n        width: '100%',\n        bottom: 0,\n        textAlign: 'center'\n      },\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 1688\n      },\n      __self: this\n    }, React.createElement(\"div\", {\n      style: {\n        margin: '0 auto',\n        width: '240px',\n        backgroundColor: 'rgba(136, 136, 136, 0.5)'\n      },\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 1689\n      },\n      __self: this\n    }, React.createElement(CinePlayer, {\n      runCinePlayer: this.runCinePlayer,\n      inPlay: this.state.inPlay,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 1690\n      },\n      __self: this\n    }), React.createElement(\"div\", {\n      id: `frameLabel-${this.props.index}`,\n      style: {\n        width: 230,\n        margin: '0 auto',\n        marginTop: -10,\n        textAlign: \"center\"\n      },\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 1691\n      },\n      __self: this\n    }, this.state.frame, \" / \", this.numberOfFrames))) : null));\n  }\n\n}\n\nconst mapStateToProps = state => {\n  return {\n    files: state.files,\n    url: state.url,\n    isOpen: state.isOpen,\n    tool: state.tool,\n    activeDcmIndex: state.activeDcmIndex,\n    activeDcm: state.activeDcm,\n    measurements: state.measurements,\n    layout: state.layout,\n    fsCurrentDir: state.fsCurrentDir,\n    fsCurrentList: state.fsCurrentList,\n    volume: state.volume,\n    lut: state.lut //sandboxedFile: state.sandboxedFile,\n\n  };\n};\n\nconst mapDispatchToProps = dispatch => {\n  return {\n    clearingStore: () => dispatch(clearStore()),\n    setIsOpenStore: value => dispatch(dcmIsOpen(value)),\n    toolStore: tool => dispatch(dcmTool(tool)),\n    setActiveDcm: dcm => dispatch(activeDcm(dcm)),\n    setActiveMeasurements: measurements => dispatch(activeMeasurements(measurements)),\n    makeFsRefresh: dcm => dispatch(doFsRefresh()) //setLutStore: (lut) => dispatch(setLut(lut)),\n\n  };\n};\n\nexport default connect(mapStateToProps, mapDispatchToProps)(DicomViewer);","map":{"version":3,"sources":["/media/mohammad/work/websites/cornerstone/dicom-viewer/src/components/DicomViewer.js"],"names":["React","connect","Button","Dialog","DialogActions","DialogContent","DialogContentText","DialogTitle","Link","Typography","Hammer","cornerstone","cornerstoneTools","cornerstoneMath","cornerstoneFileImageLoader","cornerstoneWebImageLoader","cornerstoneWADOImageLoader","dicomParser","blobUtil","uids","SETTINGS_SAVEAS","OpenUrlDlg","CinePlayer","isMobile","import","csTools","db","fs","clearStore","dcmIsOpen","activeDcm","dcmTool","activeMeasurements","doFsRefresh","capitalize","getFileName","getSettingsOverlay","isFileImage","isFsFileImage","isUrlImage","getSettingsSaveInto","scrollToIndex","external","init","DicomViewer","Component","constructor","props","state","visibleOpenUrlDlg","progress","visibleCinePlayer","errorOnOpenImage","errorOnCors","frame","inPlay","viewport","onOpenUrl","e","eventData","detail","setState","percentComplete","showOpenUrlDlg","url","events","addEventListener","loadImage","undefined","hideOpenUrlDlg","measurementSave","measure","measurements","push","measurementClear","splice","length","measurementRemove","index","getTransferSyntax","value","image","data","string","getSopClass","getSopInstanceUID","getPixelRepresentation","uint16","getPlanarConfiguration","onImageLoaded","onImageRendered","getViewport","target","console","log","document","getElementById","textContent","mprIsOrthogonalView","mprPlane","PatientsName","displayedArea","brhc","x","y","Math","round","voi","windowWidth","windowCenter","scale","toFixed","isDicom","numberOfFrames","onMeasurementModified","onMeasurementAdded","tool","note","measurementData","setActiveMeasurements","onMeasurementCompleted","setTimeout","onErrorOpenImageClose","onErrorCorsClose","displayImageFromFilesByImage","element","dicomImage","enable","displayImage","displayImageFromFilesMohammad","_files","files","imageIds","i","wadouri","fileManager","add","stack","currentImageIdIndex","imageId","filename","name","onNewImage","StackScrollMouseWheelTool","then","mprPlanePosition","addStackStateManager","addToolState","addTool","setToolActive","setActiveDcm","setIsOpenStore","enableTool","displayImageFromFiles","sopInstanceUid","measurement","where","equals","each","runTool","updateImage","setToolEnabled","loadImageFromCanvas","canvas","addCanvas","loadImageFromCustomObject","columns","rows","pixelData","customObj","originImage","addCustom","localfile","fsItem","localurl","size","isOpenStore","addBuffer","loadAndCacheImage","dataSet","parseDicom","byteArray","intString","error","toString","pos","indexOf","substring","toolName","mouseButtonNumber","WwwcTool","LengthTool","PanTool","ZoomTouchPinchTool","ZoomTool","ProbeTool","EllipticalRoiTool","RectangleRoiTool","FreehandRoiTool","AngleTool","MagnifyTool","disableAllTools","runTool2","disable","opt","file","mouseButtonMask","isTouchActive","invert","setViewport","type","localStorage","getItem","getElementsByClassName","activeDcmIndex","zoom","cols","myCanvas","createElement","cropCanvas","width","height","a","href","toDataURL","download","body","appendChild","click","canvasToBlob","blob","blobToArrayBuffer","arrayBuffer","newName","counter","done","checkName","fsCurrentList","find","transaction","parent","fsCurrentDir","byteLength","makeFsRefresh","reset","removeToolState","forEach","clearToolState","delete","sopinstanceuid","newCanvas","getContext","drawImage","changeTool","setToolPassive","runCinePlayer","cmdName","playClip","stopClip","defaultViewport","getDefaultViewportForImage","imageOrientation","split","v","Array","fill","parseFloat","map","p","abs","transpose","matrix","Object","keys","colNumber","rowNumber","mprRenderYZPlane","origin","mprData","volume","xSize","ySize","zSize","zDim","xoffset","floor","plane","Int16Array","z","yzPlane","mprBuildYZPlane","mprRenderXZPlane","trunc","xzPlane","mprBuildXZPlane","layout","dicomImageRef","el","onImageClick","componentDidMount","dcmRef","componentWillUnmount","componentDidUpdate","previousProps","isOpen","resize","render","styleContainer","border","position","styleDicomImage","overlay","color","textShadow","top","left","display","right","bottom","marginLeft","marginRight","textAlign","margin","backgroundColor","marginTop","mapStateToProps","lut","mapDispatchToProps","dispatch","clearingStore","toolStore","dcm"],"mappings":"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","sourcesContent":["import React from \"react\"\nimport {connect} from 'react-redux'\nimport Button from '@material-ui/core/Button'\nimport Dialog from '@material-ui/core/Dialog'\nimport DialogActions from '@material-ui/core/DialogActions'\nimport DialogContent from '@material-ui/core/DialogContent'\nimport DialogContentText from '@material-ui/core/DialogContentText'\nimport DialogTitle from '@material-ui/core/DialogTitle'\nimport Link from '@material-ui/core/Link'\nimport Typography from '@material-ui/core/Typography'\nimport Hammer from \"hammerjs\"\nimport * as cornerstone from \"cornerstone-core\"\nimport * as cornerstoneTools from \"cornerstone-tools\"\nimport * as cornerstoneMath from \"cornerstone-math\"\nimport * as cornerstoneFileImageLoader from \"cornerstone-file-image-loader\"\nimport * as cornerstoneWebImageLoader from \"cornerstone-web-image-loader\"\nimport * as cornerstoneWADOImageLoader from \"cornerstone-wado-image-loader\"\nimport * as dicomParser from 'dicom-parser'\nimport * as blobUtil from 'blob-util'\nimport {uids} from '../constants/uids'\nimport { SETTINGS_SAVEAS } from '../constants/settings'\nimport OpenUrlDlg from './OpenUrlDlg'\nimport CinePlayer from './CinePlayer'\nimport { isMobile } from 'react-device-detect'\nimport { import as csTools } from 'cornerstone-tools'\nimport db from '../db/db'\nimport fs from '../fs/fs'\nimport {\n  clearStore,\n  dcmIsOpen,\n  activeDcm,\n  dcmTool,\n  activeMeasurements,\n  doFsRefresh}\nfrom '../actions'\nimport {\n  capitalize,\n  getFileName,\n  getSettingsOverlay,\n  isFileImage,\n  isFsFileImage,\n  isUrlImage,\n  getSettingsSaveInto\n} from '../functions'\n\nconst scrollToIndex = csTools('util/scrollToIndex');\n\n/*\nfunction getBlobUrl(url) {\n  const baseUrl = window.URL || window.webkitURL;\n  const blob = new Blob([`importScripts('${url}')`], {type: \"application/javascript\"});\n  return baseUrl.createObjectURL(blob);\n}\n\nlet webWorkerUrl = getBlobUrl(\n  \"https://unpkg.com/cornerstone-wado-image-loader@3.0.0/dist/cornerstoneWADOImageLoaderWebWorker.min.js\"\n)\nlet codecsUrl = getBlobUrl(\n  \"https://unpkg.com/cornerstone-wado-image-loader@3.0.0/dist/cornerstoneWADOImageLoaderCodecs.js\"\n  // \"https://unpkg.com/cornerstone-wado-image-loader/dist/cornerstoneWADOImageLoaderCodecs.js\"\n)\n// See componentDidMount line 110 for initialization, registration\n\nconst config = {\n  maxWebWorkers: 4, //\n  //startWebWorkersOnDemand: true, //\n  webWorkerPath: webWorkerUrl,\n  //webWorkerTaskPaths: [], //\n  taskConfiguration: {\n    decodeTask: {\n      //loadCodecsOnStartup: true, //\n      //initializeCodecsOnStartup: false, //\n      codecsPath: codecsUrl,\n      //usePDFJS: false, //\n      //strict: true //\n    }\n  }\n}\nvar config = {\n  maxWebWorkers: navigator.hardwareConcurrency || 1,\n  startWebWorkersOnDemand: false,\n}\n*/\ncornerstoneTools.external.cornerstone = cornerstone;\ncornerstoneTools.external.cornerstoneMath = cornerstoneMath;\ncornerstoneFileImageLoader.external.cornerstone = cornerstone;\ncornerstoneWebImageLoader.external.cornerstone = cornerstone;\ncornerstoneWADOImageLoader.external.cornerstone = cornerstone;\n//cornerstoneWADOImageLoader.webWorkerManager.initialize(config)\ncornerstoneWADOImageLoader.external.dicomParser = dicomParser;\ncornerstoneTools.external.Hammer = Hammer;\ncornerstoneTools.init();\n\n//console.log({ cornerstone })\n//console.log({ cornerstoneWADOImageLoader })\n//console.log({ dicomParser })\n\nclass DicomViewer extends React.Component {\n    constructor(props) {\n      super(props);\n      this.filename = '';\n      this.localfile = null;\n      this.localurl = null;\n      this.fsItem = null;\n      this.dicomImage = null;\n      this.imageId = null;\n      this.image = null;\n      this.isDicom = false;\n      this.numberOfFrames = 1;\n      this.measurements = [];\n      this.xSize = 0;\n      this.ySize = 0;\n      this.zSize = 0;\n      this.volume = null;\n      this.originImage = null;\n      this.mprPlane = ''\n    }\n\n    state = {\n      visibleOpenUrlDlg: false,\n      progress: null,\n      visibleCinePlayer: false,\n      errorOnOpenImage: null,\n      errorOnCors: false,\n      frame: 1,\n      inPlay: false,\n      viewport: null,\n    };\n\n    componentDidMount() {\n      this.props.runTool(this);\n      // this.props.runTool2(this);\n      this.props.changeTool(this);\n      cornerstone.events.addEventListener('cornerstoneimageloaded', this.onImageLoaded);\n      const { dcmRef } = this.props;\n      dcmRef(this)\n\n    }\n\n    componentWillUnmount() {\n      this.props.runTool(undefined);\n      // this.props.runTool2(undefined);\n      this.props.changeTool(undefined);\n      const { dcmRef } = this.props;\n      dcmRef(undefined)\n    }\n\n    componentDidUpdate(previousProps) {\n      //console.log('dicomviewer - componentDidUpdate: ')\n      /*if (this.props.files !== null) {\n        console.log('this.props.files[0]: ', this.props.files[0])\n        console.log('this.props.files: ', this.props.files)\n      }*/\n      /*if (this.props.volume !== null) {\n        console.log('volume set: ', this.props.volume)\n        this.volume = this.props.volume\n      }*/\n      const isOpen = this.props.isOpen[this.props.index];\n      if (this.props.layout !== previousProps.layout && isOpen) {\n        cornerstone.resize(this.dicomImage)\n      }\n    }\n\n    onOpenUrl = (e) => {\n      const eventData = e.detail;\n      this.setState({ progress: eventData.percentComplete })\n    };\n\n    showOpenUrlDlg = (url) => {\n      this.setState({ visibleOpenUrlDlg: true }, () => {\n        cornerstone.events.addEventListener('cornerstoneimageloadprogress', this.onOpenUrl);\n        this.loadImage(undefined, url)\n      })\n    };\n\n    hideOpenUrlDlg = () => {\n      this.setState({ visibleOpenUrlDlg: false, progress: null })\n    };\n\n    measurementSave = (measure) => {\n      this.measurements.push(measure)\n    };\n\n    measurementClear = () => {\n      this.measurements.splice(0, this.measurements.length)\n    };\n\n    measurementRemove = (index) => {\n      //console.log('this.measurements: ', this.measurements)\n      this.measurements.splice(index, 1)\n    };\n\n    getTransferSyntax = () => {\n      const value = this.image.data.string('x00020010');\n      return value + ' [' + uids[value] + ']'\n    };\n\n    getSopClass = () => {\n      const value = this.image.data.string('x00080016');\n      return value + ' [' + uids[value] + ']'\n    };\n\n    getSopInstanceUID = () => {\n      const value = this.image.data.string('x00080018');\n      return value\n    };\n\n    getPixelRepresentation = () => {\n      const value = this.image.data.uint16('x00280103');\n      if (value === undefined) return;\n      return value + (value === 0 ? ' (unsigned)' : ' (signed)')\n    };\n\n    getPlanarConfiguration = () => {\n      const value = this.image.data.uint16('x00280006');\n      if (value === undefined) return;\n      return value + (value === 0 ? ' (pixel)' : ' (plane)')\n    };\n\n    onImageLoaded = (e) => {\n      //console.log('cornerstoneimageloaded: ')\n    };\n\n    // Listen for changes to the viewport so we can update the text overlays in the corner\n    onImageRendered = (e) => {\n      //console.log('cornerstoneimagerendered: ', e.target)\n      //console.log('cornerstoneimagerendered, plane: ', this.mprPlane)\n\n      //const viewport = cornerstone.getViewport(this.dicomImage)\n      const viewport = cornerstone.getViewport(e.target);\n\n      //console.log('viewport: ', viewport)\n\n      //if (this.props.activeDcm !== null)\n      //  console.log('viewport activeDcm: ', cornerstone.getViewport(this.props.activeDcm.element))\n\n      console.log(\"props.index : \", this.props.index);\n      document.getElementById(\n        `mrtopleft-${this.props.index}`\n      ).textContent = this.mprIsOrthogonalView() ? `${capitalize(this.mprPlane)}` : `${this.PatientsName}`;\n\n      document.getElementById(\n        `mrtopright-${this.props.index}`\n      ).textContent = `${viewport.displayedArea.brhc.x}x${viewport.displayedArea.brhc.y}`;\n\n      document.getElementById(\n        `mrbottomleft-${this.props.index}`\n      ).textContent = `WW/WC: ${Math.round(viewport.voi.windowWidth)}/${Math.round(viewport.voi.windowCenter)}`;\n\n      document.getElementById(\n        `mrbottomright-${this.props.index}`\n      ).textContent = `Zoom: ${Math.round(viewport.scale.toFixed(2)*100)}%`;\n\n      document.getElementById(\n        `mrtopcenter-${this.props.index}`\n      ).textContent = ``;\n      document.getElementById(\n        `mrbottomcenter-${this.props.index}`\n      ).textContent = ``;\n      document.getElementById(\n        `mrleftcenter-${this.props.index}`\n      ).textContent = ``;\n      document.getElementById(\n        `mrrightcenter-${this.props.index}`\n      ).textContent = ``;\n\n      if (this.mprPlane === 'sagittal') {\n        document.getElementById(\n          `mrtopcenter-${this.props.index}`\n        ).textContent = `S`;\n        document.getElementById(\n          `mrbottomcenter-${this.props.index}`\n        ).textContent = `I`;\n        document.getElementById(\n          `mrleftcenter-${this.props.index}`\n        ).textContent = `A`;\n        document.getElementById(\n          `mrrightcenter-${this.props.index}`\n        ).textContent = `P`\n\n      } else if (this.mprPlane === 'axial') {\n        document.getElementById(\n          `mrtopcenter-${this.props.index}`\n        ).textContent = `A`;\n        document.getElementById(\n          `mrbottomcenter-${this.props.index}`\n        ).textContent = `P`;\n        document.getElementById(\n          `mrleftcenter-${this.props.index}`\n        ).textContent = `R`;\n        document.getElementById(\n          `mrrightcenter-${this.props.index}`\n        ).textContent = `L`\n\n      } else if (this.mprPlane === 'coronal') {\n        document.getElementById(\n          `mrtopcenter-${this.props.index}`\n        ).textContent = `S`;\n        document.getElementById(\n          `mrbottomcenter-${this.props.index}`\n        ).textContent = `I`;\n        document.getElementById(\n          `mrleftcenter-${this.props.index}`\n        ).textContent = `R`;\n        document.getElementById(\n          `mrrightcenter-${this.props.index}`\n        ).textContent = `L`\n      }\n\n      if (this.isDicom && this.state.visibleCinePlayer && this.numberOfFrames > 1) {\n        document.getElementById(\n          `frameLabel-${this.props.index}`\n        ).textContent = `${this.state.frame} / ${this.numberOfFrames}`;\n        if (this.state.inPlay) {\n          let frame = this.state.frame === this.numberOfFrames ? 1 : this.state.frame+1;\n          this.setState({frame: frame})\n        }\n      }\n    };\n\n    onMeasurementModified = (e) => {\n      //console.log('cornerstonetoolsmeasurementmodified: ', e.detail.measurementData)\n\n    };\n\n    onMeasurementAdded = (e) => {\n      //console.log('cornerstonetoolsmeasurementadded: ', e.detail.measurementData)\n      if (this.props.tool !== \"Angle\") return;\n      const measure = {\n        tool: this.props.tool,\n        note: '',\n        data: e.detail.measurementData\n      };\n      this.measurementSave(measure);\n      this.props.setActiveMeasurements(this.measurements)\n    };\n\n    onMeasurementCompleted = (e) => {\n      //console.log('cornerstonetoolsmeasurementcompleted: ', e.detail.measurementData)\n      const measure = {\n        tool: this.props.tool,\n        note: '',\n        data: e.detail.measurementData\n      };\n      if (this.props.tool === \"FreehandRoi\") {\n        setTimeout(() => {\n          this.measurementSave(measure);\n          this.props.setActiveMeasurements(this.measurements)\n        }, 500)\n      } else {\n        this.measurementSave(measure);\n        this.props.setActiveMeasurements(this.measurements)\n      }\n    };\n\n    onErrorOpenImageClose = () => {\n      this.setState({errorOnOpenImage: null})\n    };\n\n    onErrorCorsClose = () => {\n      this.setState({errorOnCors: false})\n    };\n\n    /*overlayImage = () => {\n      const viewport = cornerstone.getViewport(this.dicomImage)\n\n      if (this.isDicom) document.getElementById(\n        `mrtopleft-${this.props.index}`\n      ).textContent = `${this.PatientsName}`\n\n      document.getElementById(\n        `mrtopright-${this.props.index}`\n      ).textContent = `${viewport.displayedArea.brhc.x}x${viewport.displayedArea.brhc.y}`\n\n      document.getElementById(\n        `mrbottomleft-${this.props.index}`\n      ).textContent = `WW/WC: ${Math.round(viewport.voi.windowWidth)}/${Math.round(viewport.voi.windowCenter)}`\n\n      document.getElementById(\n        `mrbottomright-${this.props.index}`\n      ).textContent = `Zoom: ${Math.round(viewport.scale.toFixed(2)*100)}%`\n\n      if (this.isDicom && this.state.visibleCinePlayer && this.numberOfFrames > 1) {\n        document.getElementById(\n          `frameLabel-${this.props.index}`\n        ).textContent = `${this.state.frame} / ${this.numberOfFrames}`\n        if (this.state.inPlay) {\n          let frame = this.state.frame === this.numberOfFrames ? 1 : this.state.frame+1\n          this.setState({frame: frame})\n        }\n      }\n    }*/\n\n    displayImageFromFilesByImage = (index, image) => {\n\n      const element = this.dicomImage;\n      cornerstone.enable(element);\n      cornerstone.displayImage(element, image);\n    }\n    displayImageFromFilesMohammad = (_files) => {\n      // console.log('displayImageFromFiles: ', index);\n      // console.log('files: ', this.props.files);\n\n\n      // const files = this.files === null ? this.props.files : this.files\n      let files = _files;\n\n      // console.log('displayImageFromFiles - this.files: ', this.files)\n\n      // MOHAMMAD\n      let imageIds = [];\n      for(let i=0; i< files.length; i++){\n        // imageIds.push(files[i].imageId);\n        imageIds.push(cornerstoneWADOImageLoader.wadouri.fileManager.add(files[i]));\n        console.log('file -- ' ,files[i]);\n        console.log('files image id-- ' ,cornerstoneWADOImageLoader.wadouri.fileManager.add(files[i]));\n      }\n      let stack = {\n        currentImageIdIndex: 0,\n        imageIds\n      }\n\n\n\n\n\n      // const image = this.props.files[index].image;\n      // const imageId = this.props.files[index].imageId;\n      // this.filename = this.props.files[index].name;\n\n      let image = files[0].image;\n      let imageId = files[0].imageId;\n      this.filename = files[0].name;\n\n      let element = this.dicomImage;\n      element.addEventListener(\"cornerstonenewimage\", this.onNewImage);\n      element.addEventListener(\"cornerstoneimagerendered\", this.onImageRendered);\n      element.addEventListener(\"cornerstonetoolsmeasurementadded\", this.onMeasurementAdded);\n      element.addEventListener(\"cornerstonetoolsmeasurementmodified\", this.onMeasurementModified);\n      element.addEventListener(\"cornerstonetoolsmeasurementcompleted\", this.onMeasurementCompleted);\n      cornerstone.enable(element);\n\n      // this.image = image;\n\n      // this.isDicom = true;\n\n      // this.PatientsName = image.data.string('x00100010');\n      // this.sopInstanceUid = this.getSopInstanceUID();\n\n      // let stack = { currentImageIdIndex: 0, imageIds: \"\" };\n      // this.numberOfFrames = image.data.intString('x00280008');\n      // if (this.numberOfFrames > 0) {\n      //   let imageIds = [];\n      //   for(var i=0; i < this.numberOfFrames; ++i) {\n      //     imageIds.push(imageId + \"?frame=\"+i)\n      //   }\n      //   stack.imageIds = imageIds\n      // }\n\n\n\n\n      // MOHAMMAD\n      // Add our tool, and set it's mode\n      const StackScrollMouseWheelTool = cornerstoneTools.StackScrollMouseWheelTool\n      cornerstone.loadImage(imageIds[0]).then((image) => {\n        this.image = image\n        this.isDicom = true\n\n        cornerstone.displayImage(element, image)\n        this.mprPlanePosition()\n        cornerstoneTools.addStackStateManager(element, ['stack'])\n        cornerstoneTools.addToolState(element, 'stack', stack)\n      })\n      cornerstoneTools.addTool(StackScrollMouseWheelTool)\n      cornerstoneTools.setToolActive('StackScrollMouseWheel', { })\n\n\n\n\n\n      // cornerstone.displayImage(element, image);\n\n      // let viewport = cornerstone.getViewport(this.dicomImage)\n      // let lut =  cornerstone.generateLut(this.image, viewport.voi.windowWidth, viewport.voi.windowCenter, viewport.invert, viewport.modalityLUT, viewport.voiLUT)\n      // this.props.setLutStore(lut)\n      // this.mprPlanePosition();\n\n\n\n      this.props.setActiveDcm({image: this.image, element: this.dicomImage, isDicom: this.isDicom});\n      // this.props.isOpenStore(true);\n      this.props.setIsOpenStore({index: this.props.index, value: true})\n\n\n\n      this.enableTool();\n\n      // if (this.numberOfFrames > 1) {\n      //   cornerstoneTools.addStackStateManager(element, ['stack', 'playClip']);\n      //   cornerstoneTools.addToolState(element, 'stack', stack);\n      //   this.setState({frame: 1})\n      // }\n\n      // Load the possible measurements from DB and save in the store\n      // db.measurement.where('sopinstanceuid').equals(this.sopInstanceUid).each(measure => {\n      //   console.log('load measure from db: ', measure);\n      //   this.measurementSave(measure);\n      //   cornerstoneTools.addToolState(element, measure.tool, measure.data);\n      //   this.runTool(measure.tool);\n      //   cornerstone.updateImage(element);\n      //   cornerstoneTools.setToolEnabled(measure.tool)\n      // }).then(() => {\n      //   this.props.setActiveMeasurements(this.measurements);\n      //   this.props.setActiveDcm({image: this.image, element: this.dicomImage, isDicom: this.isDicom});\n      //   this.props.setIsOpenStore({index: this.props.index, value: true})\n      // })\n\n      //this.overlayImage()\n\n    };\n    displayImageFromFiles = (index) => {\n      // console.log('displayImageFromFiles: ', index);\n      // console.log('files: ', this.props.files);\n\n\n      const files = this.files === null ? this.props.files : this.files\n      // let files = _files;\n\n      // console.log('displayImageFromFiles - this.files: ', this.files)\n\n      // MOHAMMAD\n      let imageIds = [];\n      for(let i=0; i< files.length; i++){\n        imageIds.push(files[i].imageId);\n        // imageIds.push(cornerstoneWADOImageLoader.wadouri.fileManager.add(files[i]));\n        // console.log('file -- ' ,files[i]);\n        // console.log('files image id-- ' ,cornerstoneWADOImageLoader.wadouri.fileManager.add(files[i]));\n      }\n      let stack = {\n        currentImageIdIndex: 0,\n        imageIds\n      }\n\n\n\n\n\n      const image = this.props.files[index].image;\n      const imageId = this.props.files[index].imageId;\n      this.filename = this.props.files[index].name;\n\n      // const image = files[0].image;\n      // const imageId = files[0].imageId;\n      // this.filename = files[0].name;\n\n      const element = this.dicomImage;\n      element.addEventListener(\"cornerstonenewimage\", this.onNewImage);\n      element.addEventListener(\"cornerstoneimagerendered\", this.onImageRendered);\n      element.addEventListener(\"cornerstonetoolsmeasurementadded\", this.onMeasurementAdded);\n      element.addEventListener(\"cornerstonetoolsmeasurementmodified\", this.onMeasurementModified);\n      element.addEventListener(\"cornerstonetoolsmeasurementcompleted\", this.onMeasurementCompleted);\n      cornerstone.enable(element);\n\n      this.image = image;\n\n      this.isDicom = true;\n\n      this.PatientsName = image.data.string('x00100010');\n      this.sopInstanceUid = this.getSopInstanceUID();\n\n      // let stack = { currentImageIdIndex: 0, imageIds: \"\" };\n      // this.numberOfFrames = image.data.intString('x00280008');\n      // if (this.numberOfFrames > 0) {\n      //   let imageIds = [];\n      //   for(var i=0; i < this.numberOfFrames; ++i) {\n      //     imageIds.push(imageId + \"?frame=\"+i)\n      //   }\n      //   stack.imageIds = imageIds\n      // }\n\n\n\n\n      // MOHAMMAD\n      // Add our tool, and set it's mode\n      const StackScrollMouseWheelTool = cornerstoneTools.StackScrollMouseWheelTool\n      cornerstone.loadImage(imageIds[0]).then((image) => {\n        cornerstone.displayImage(element, image)\n        cornerstoneTools.addStackStateManager(element, ['stack'])\n        cornerstoneTools.addToolState(element, 'stack', stack)\n      })\n      cornerstoneTools.addTool(StackScrollMouseWheelTool)\n      cornerstoneTools.setToolActive('StackScrollMouseWheel', { })\n\n\n\n\n\n      // cornerstone.displayImage(element, image);\n\n      /*const viewport = cornerstone.getViewport(this.dicomImage)\n      const lut =  cornerstone.generateLut(this.image, viewport.voi.windowWidth, viewport.voi.windowCenter, viewport.invert, viewport.modalityLUT, viewport.voiLUT)\n      this.props.setLutStore(lut)*/\n      // this.mprPlanePosition();\n\n      this.enableTool();\n\n      // if (this.numberOfFrames > 1) {\n      //   cornerstoneTools.addStackStateManager(element, ['stack', 'playClip']);\n      //   cornerstoneTools.addToolState(element, 'stack', stack);\n      //   this.setState({frame: 1})\n      // }\n\n      // Load the possible measurements from DB and save in the store\n      db.measurement.where('sopinstanceuid').equals(this.sopInstanceUid).each(measure => {\n        console.log('load measure from db: ', measure);\n        this.measurementSave(measure);\n        cornerstoneTools.addToolState(element, measure.tool, measure.data);\n        this.runTool(measure.tool);\n        cornerstone.updateImage(element);\n        cornerstoneTools.setToolEnabled(measure.tool)\n      }).then(() => {\n        this.props.setActiveMeasurements(this.measurements);\n        this.props.setActiveDcm({image: this.image, element: this.dicomImage, isDicom: this.isDicom});\n        this.props.setIsOpenStore({index: this.props.index, value: true})\n      })\n\n      //this.overlayImage()\n\n    };\n\n    loadImageFromCanvas = (canvas) => {\n      console.log('loadImageFromCanvas, dcmViewer: ', this.props.index);\n\n      const element = this.dicomImage;\n      element.addEventListener(\"cornerstonenewimage\", this.onNewImage);\n      element.addEventListener(\"cornerstoneimagerendered\", this.onImageRendered);\n      element.addEventListener(\"cornerstonetoolsmeasurementadded\", this.onMeasurementAdded);\n      element.addEventListener(\"cornerstonetoolsmeasurementmodified\", this.onMeasurementModified);\n      element.addEventListener(\"cornerstonetoolsmeasurementcompleted\", this.onMeasurementCompleted);\n      cornerstone.enable(element);\n\n      const imageId = cornerstoneFileImageLoader.fileManager.addCanvas(canvas);\n\n      cornerstone.loadImage(imageId).then(image => {\n        //this.t1 = performance.now()\n        //console.log(`performance load image: ${this.t1-this.t0} milliseconds`)\n\n        console.log('loadImageFromCanvas, image: ', image);\n\n        this.image = image;\n\n        this.isDicom = false;\n\n        cornerstone.displayImage(element, image);\n\n        this.enableTool();\n\n        //this.props.setActiveDcm({image: this.image, element: this.dicomImage, isDicom: this.isDicom})\n        this.props.setIsOpenStore({index: this.props.index, value: true})\n\n        //this.t2 = performance.now()\n        //console.log(`performance: ${this.t2-this.t1} milliseconds`)\n\n        //this.overlayImage()\n\n      }, (e) => {\n        console.log('error', e);\n        this.setState({errorOnOpenImage: \"This is not a valid canvas.\"})\n      })\n    };\n\n    loadImageFromCustomObject = (columns, rows, pixelData) => {\n      //console.log('loadImageFromCustomObject: ')\n\n      const element = this.dicomImage;\n      element.addEventListener(\"cornerstonenewimage\", this.onNewImage);\n      element.addEventListener(\"cornerstoneimagerendered\", this.onImageRendered);\n      element.addEventListener(\"cornerstonetoolsmeasurementadded\", this.onMeasurementAdded);\n      element.addEventListener(\"cornerstonetoolsmeasurementmodified\", this.onMeasurementModified);\n      element.addEventListener(\"cornerstonetoolsmeasurementcompleted\", this.onMeasurementCompleted);\n      cornerstone.enable(element);\n\n      let customObj = {\n        rows: rows,\n        columns: columns,\n        pixelData: pixelData,\n        image: this.originImage,\n      };\n\n      const imageId = cornerstoneFileImageLoader.fileManager.addCustom(customObj);\n\n      cornerstone.loadImage(imageId).then(image => {\n        //console.log('loadImageFromCustomObject, image: ', image)\n\n        this.image = image;\n\n        this.isDicom = true;\n\n        cornerstone.displayImage(element, image);\n\n        //this.enableTool()\n\n        this.props.setIsOpenStore({index: this.props.index, value: true})\n\n      }, (e) => {\n        console.log('error', e);\n        this.setState({errorOnOpenImage: \"This is not a valid canvas.\"})\n      })\n    };\n\n    loadImage = (localfile, url=undefined, fsItem=undefined) => {\n      console.log('loadImage, localfile: ', localfile);\n      console.log('loadImage, fsItem: ', fsItem);\n      console.log('loadImage, url: ', url);\n\n      if (localfile === undefined && url === undefined && fsItem === undefined) return;\n\n      if (fsItem !== undefined) {\n        this.fsItem = fsItem\n      } else if (localfile !== undefined) {\n        this.localfile = localfile\n      } else {\n        this.localurl = url\n      }\n\n      const element = this.dicomImage;\n\n      element.addEventListener(\"cornerstonenewimage\", this.onNewImage);\n      element.addEventListener(\"cornerstoneimagerendered\", this.onImageRendered);\n      element.addEventListener(\"cornerstonetoolsmeasurementadded\", this.onMeasurementAdded);\n      element.addEventListener(\"cornerstonetoolsmeasurementmodified\", this.onMeasurementModified);\n      element.addEventListener(\"cornerstonetoolsmeasurementcompleted\", this.onMeasurementCompleted);\n\n      let imageId = undefined;\n\n      cornerstone.enable(element);\n\n      let size = 0;\n\n      if (localfile === undefined && isUrlImage(url)) { // check if it's a simple image [jpeg or png] from url\n        //console.log('image: ', file)\n        cornerstone.loadImage(url).then(image => {\n          //console.log('loadImage, image from url: ', image)\n\n          this.hideOpenUrlDlg();\n\n          this.image = image;\n\n          this.isDicom = false;\n\n          cornerstone.displayImage(element, image);\n\n          this.enableTool();\n\n          this.props.setActiveDcm({image: this.image, element: this.dicomImage, isDicom: this.isDicom});\n          this.props.isOpenStore(true)\n\n        }, (e) => {\n          console.log('error', e);\n          this.setState({errorOnOpenImage: \"This is not a valid JPG or PNG file.\"})\n        })\n\n      } else if ((localfile !== undefined && isFileImage(localfile)) || (fsItem !== undefined && isFsFileImage(fsItem))) { // otherwise try to open as local image file (JPEG, PNG)\n        if (fsItem !== undefined) {\n          imageId = cornerstoneFileImageLoader.fileManager.addBuffer(fsItem.data)\n        } else {\n          imageId = cornerstoneFileImageLoader.fileManager.add(localfile)\n        }\n        cornerstone.loadImage(imageId).then(image => {\n          // console.log('loadImage, image from local: ', image);\n\n          this.image = image;\n          this.isDicom = false;\n          this.PatientsName = '';\n          // console.log(\"image data:\" + image.data);\n          cornerstone.displayImage(element, image);\n\n          this.enableTool();\n\n          this.props.setActiveDcm({image: this.image, element: this.dicomImage, isDicom: this.isDicom});\n          //this.props.isOpenStore(true)\n          this.props.setIsOpenStore({index: this.props.index, value: true})\n\n        }, (e) => {\n          console.log('error', e);\n          this.setState({errorOnOpenImage: \"This is not a valid JPG or PNG file.\"})\n        })\n\n      } else { // otherwise try to open as Dicom file\n\n        if (fsItem !== undefined) {\n          imageId = cornerstoneWADOImageLoader.wadouri.fileManager.addBuffer(fsItem.data);\n          this.filename = fsItem.name;\n          size = fsItem.size\n        } else if (localfile !== undefined) {\n          imageId = cornerstoneWADOImageLoader.wadouri.fileManager.add(localfile);\n          this.filename = localfile.name;\n          size = localfile.size\n        } else { // it's a web dicom image\n          imageId = \"wadouri:\"+url\n        }\n\n        // console.log('loadImage, imageId: ', imageId);\n\n        cornerstone.loadAndCacheImage(imageId).then(image => {\n          console.log('loadImage, image: ', image);\n          // let pixelDataElement = image.data.elements.x7fe00010;\n          // console.log('loadImage, pixelDataElement: ', pixelDataElement);\n          // console.log('loadImage, getPixelData: ', image.getPixelData());\n\n\n          this.hideOpenUrlDlg();\n\n          this.image = image;\n\n          this.isDicom = true;\n\n          let dataSet = dicomParser.parseDicom(image.data.byteArray);\n          console.log('image dataset -----: ' + dataSet.string('x00200011'));\n          console.log('Series Number: ' + image.data.string('x00200011'));\n\n\n          this.PatientsName = image.data.string('x00100010');\n          console.log('PatientsName: ' + this.PatientsName);\n          this.sopInstanceUid = this.getSopInstanceUID();\n\n          let stack = { currentImageIdIndex: 0, imageIds: \"\" };\n          this.numberOfFrames = image.data.intString('x00280008');\n          if (this.numberOfFrames > 0) {\n            let imageIds = [];\n            for(var i=0; i < this.numberOfFrames; ++i) {\n              imageIds.push(imageId + \"?frame=\"+i)\n            }\n            stack.imageIds = imageIds\n          }\n\n          cornerstone.displayImage(element, image);\n          //cornerstoneTools.mouseInput.enable(element);\n          //cornerstoneTools.mouseWheelInput.enable(element);\n\n          this.enableTool();\n\n          /*const viewport = cornerstone.getViewport(this.dicomImage)\n          const lut =  cornerstone.generateLut(this.image, viewport.voi.windowWidth, viewport.voi.windowCenter, viewport.invert, viewport.modalityLUT, viewport.voiLUT)\n          console.log('lut: ', lut)*/\n\n          if (this.numberOfFrames > 1) {\n            cornerstoneTools.addStackStateManager(element, ['stack', 'playClip']);\n            cornerstoneTools.addToolState(element, 'stack', stack);\n            //cornerstoneTools.setToolActive('StackScrollMouseWheel', { })\n            this.setState({frame: 1})\n          }\n\n          // Load the possible measurements from DB and save in the store\n          db.measurement.where('sopinstanceuid').equals(this.sopInstanceUid).each(measure => {\n            console.log('load measure from db: ', measure);\n            //this.props.measurementStore(measure)\n            this.measurementSave(measure);\n            cornerstoneTools.addToolState(element, measure.tool, measure.data);\n            this.runTool(measure.tool);\n            cornerstone.updateImage(element);\n            cornerstoneTools.setToolEnabled(measure.tool)\n          }).then(() => {\n            //console.log('this.measurements: ', this.measurements)\n            this.props.setActiveMeasurements(this.measurements);\n            this.props.setActiveDcm({name: this.filename, size: size, image: this.image, element: this.dicomImage, isDicom: this.isDicom});\n            this.props.setIsOpenStore({index: this.props.index, value: true})\n          });\n\n\n\n\n\n\n        }, (e) => {\n          console.log('error', e);\n          this.hideOpenUrlDlg();\n          //console.log('toString: ', e.error.toString())\n          const error = e.error.toString();\n          if (error === '[object XMLHttpRequest]') {\n            this.setState({errorOnCors: true})\n          } else {\n            const pos = error.indexOf(\":\");\n            this.setState({errorOnOpenImage: pos < 0 ? e.error : error.substring(pos+1)})\n          }\n        })\n      }\n    };\n\n    enableTool = (toolName, mouseButtonNumber) => {\n      // Enable all tools we want to use with this element\n      const WwwcTool = cornerstoneTools.WwwcTool;\n      const LengthTool = cornerstoneTools['LengthTool'];\n      const PanTool = cornerstoneTools.PanTool;\n      const ZoomTouchPinchTool = cornerstoneTools.ZoomTouchPinchTool;\n      const ZoomTool = cornerstoneTools.ZoomTool;\n      const ProbeTool = cornerstoneTools.ProbeTool;\n      const EllipticalRoiTool = cornerstoneTools.EllipticalRoiTool;\n      const RectangleRoiTool = cornerstoneTools.RectangleRoiTool;\n      const FreehandRoiTool = cornerstoneTools.FreehandRoiTool;\n      const AngleTool = cornerstoneTools.AngleTool;\n      const MagnifyTool = cornerstoneTools.MagnifyTool;\n      const StackScrollMouseWheelTool = cornerstoneTools.StackScrollMouseWheelTool;\n\n      cornerstoneTools.addTool(MagnifyTool);\n      cornerstoneTools.addTool(AngleTool);\n      cornerstoneTools.addTool(WwwcTool);\n      cornerstoneTools.addTool(LengthTool);\n      cornerstoneTools.addTool(PanTool);\n      cornerstoneTools.addTool(ZoomTouchPinchTool);\n      cornerstoneTools.addTool(ZoomTool);\n      cornerstoneTools.addTool(ProbeTool);\n      cornerstoneTools.addTool(EllipticalRoiTool);\n      cornerstoneTools.addTool(RectangleRoiTool);\n      cornerstoneTools.addTool(FreehandRoiTool);\n      cornerstoneTools.addTool(StackScrollMouseWheelTool)\n    };\n\n    // helper function used by the tool button handlers to disable the active tool\n    // before making a new tool active\n    disableAllTools = () => {\n      cornerstoneTools.setToolEnabled('Length');\n      cornerstoneTools.setToolEnabled('Pan');\n      cornerstoneTools.setToolEnabled('Magnify');\n      cornerstoneTools.setToolEnabled('Angle');\n      cornerstoneTools.setToolEnabled('RectangleRoi');\n      cornerstoneTools.setToolEnabled('Wwwc');\n      cornerstoneTools.setToolEnabled('ZoomTouchPinch');\n      cornerstoneTools.setToolEnabled('Probe');\n      cornerstoneTools.setToolEnabled('EllipticalRoi');\n      cornerstoneTools.setToolEnabled('FreehandRoi');\n      cornerstoneTools.setToolEnabled('StackScrollMouseWheel')\n    };\n\n    runTool2 = (index, image) => {\n      cornerstone.disable(this.dicomImage);\n      this.displayImageFromFilesByImage(index, image);\n    }\n\n    runTool = (toolName, opt) => {\n      //console.log('run tool: ', toolName)\n      // this.disableAllTools()\n      switch (toolName) {\n        case 'openImage': {\n          cornerstone.disable(this.dicomImage);\n          // this.displayImageFromFilesByImage(opt);\n          break\n        }\n        case 'openimage': {\n          //console.log('openimage: ', opt)\n          //console.log('openimage, this.dicomImage: ', this.dicomImage)\n          cornerstone.disable(this.dicomImage);\n          this.displayImageFromFiles(opt);\n          break\n        }\n        case 'Mohammad':{\n          cornerstone.disable(this.dicomImage);\n          this.displayImageFromFilesMohammad(opt);\n          break\n        }\n        // case 'openLocalFs': {\n        //   console.log('openLocalFs: ', opt);\n        //   cornerstone.disable(this.dicomImage);\n        //   // this.loadImage(opt);\n        //   break\n        // }\n        case 'openSandboxFs': {\n          console.log('openSandboxFs: ', opt)\n          cornerstone.disable(this.dicomImage);\n          this.setState({ file: opt })\n          this.loadImage(undefined, undefined, opt);\n          break\n        }\n        case 'openurl': {\n          //console.log('run tool opt: ', opt)\n          this.showOpenUrlDlg(opt);\n          break\n        }\n        case 'clear': {\n          this.setState({ visibleCinePlayer: false });\n          this.mprPlane = '';\n          //this.props.clearingStore()\n          cornerstone.disable(this.dicomImage);\n          break\n        }\n        case 'notool': {\n          this.disableAllTools();\n\n          //const element = this.dicomImage\n\n          //cornerstoneTools.clearToolState(element, 'Length')\n\n          //const toolStateManager = cornerstoneTools.getElementToolStateManager(element)\n          //console.log('toolStateManager.toolState: ', toolStateManager.toolState)\n          /*\n          const toolState = toolStateManager.toolState\n          // const allTools = Object.keys(toolState).map(key => toolState[key])\n          let key = Object.keys(toolState)[0]\n          let allTools = toolState[key]\n          //console.log('allTools: ', allTools)\n\n          for (let [tool, data] of Object.entries(allTools)) {\n            //console.log(`${tool}: `, data)\n            let key = Object.keys(data)[0]\n            let tools = data[key]\n            //console.log('tools: ', tools)\n            tools.forEach(item => {\n              //console.log('tool: ', tool)\n              //console.log(item)\n              const measure = {\n                tool: tool,\n                note: '',\n                data: item\n              }\n              console.log('measure: ', measure)\n              this.props.measurementStore(measure)\n            })\n          }\n          */\n          //const toolState = toolStateManager.get(element, 'Length')\n          //console.log('toolState: ', toolState)\n\n          /*\n          const measurementData = {\n            visible: true,\n            active: true,\n            invalidated: true,\n            handles: {\n                start: {\n                    x: 100,\n                    y: 100,\n                    highlight: true,\n                    active: false\n                },\n                end: {\n                    x: 200,\n                    y: 200,\n                    highlight: true,\n                    active: true\n                },\n                textBox: {\n                    active: false,\n                    hasMoved: false,\n                    movesIndependently: false,\n                    drawnIndependently: true,\n                    allowedOutsideImage: true,\n                    hasBoundingBox: true\n                }\n              }\n          }\n          cornerstoneTools.addToolState(element, 'RectangleRoi', measurementData)\n          cornerstoneTools.setToolActive('RectangleRoi', { mouseButtonMask: 1 })\n          */\n          //cornerstone.updateImage(element)\n          break\n        }\n        case 'Wwwc': {\n          cornerstoneTools.setToolActive('Wwwc', { mouseButtonMask: 1 });\n          break\n        }\n        case 'Pan': {\n          cornerstoneTools.setToolActive('Pan', { mouseButtonMask: 1 });\n          break\n        }\n        case 'Zoom': {\n          cornerstoneTools.setToolActive(isMobile ? 'ZoomTouchPinch' : 'Zoom', { mouseButtonMask: 1 });\n          break\n        }\n        case 'Length': {\n          cornerstoneTools.setToolActive('Length', isMobile ? { isTouchActive: true } : { mouseButtonMask: 1 });\n          break\n        }\n        case 'Probe': {\n            cornerstoneTools.setToolActive('Probe', { mouseButtonMask: 1 });\n          break\n        }\n        case 'EllipticalRoi': {\n          cornerstoneTools.setToolActive('EllipticalRoi', { mouseButtonMask: 1 });\n          break\n        }\n        case 'RectangleRoi': {\n          cornerstoneTools.setToolActive('RectangleRoi', { mouseButtonMask: 1 });\n          break\n        }\n        case 'Angle': {\n          cornerstoneTools.setToolActive('Angle', { mouseButtonMask: 1 });\n          break\n        }\n        case 'Magnify': {\n          cornerstoneTools.setToolActive('Magnify', { mouseButtonMask: 1 });\n          break\n        }\n        case 'FreehandRoi': {\n          cornerstoneTools.setToolActive('FreehandRoi', { mouseButtonMask: 1 });\n          break\n        }\n        case 'Invert': {\n          const element = this.dicomImage;\n          const viewport = cornerstone.getViewport(element);\n          viewport.invert = !viewport.invert;\n          cornerstone.setViewport(element, viewport);\n          break\n        }\n        case 'saveas': {\n            let type = localStorage.getItem(SETTINGS_SAVEAS);\n            if (getSettingsSaveInto() === 'local') {\n              // cornerstoneTools.SaveAs(this.dicomImage, `${this.filename}.${type}`, `image/${type}`)\n              const element = this.dicomImage;\n              const viewport = cornerstone.getViewport(element);\n              const canvas = document.getElementsByClassName('cornerstone-canvas')[this.props.activeDcmIndex];\n              const zoom = viewport.scale.toFixed(2);\n              const cols = this.image.columns * zoom;\n              const rows = this.image.rows * zoom;\n\n              let myCanvas = document.createElement('canvas');\n              myCanvas = this.cropCanvas(canvas,\n                Math.round(canvas.width / 2 - cols / 2),\n                Math.round(canvas.height / 2 - rows / 2),\n                cols, rows);\n\n              let a = document.createElement(\"a\");\n              a.href = myCanvas.toDataURL(`image/${type}`);\n              a.download = `${this.filename}.${type}`;\n              document.body.appendChild(a); // Required for this to work in FireFox\n              a.click()\n\n            } else { // store image into sandbox file system\n              const element = this.dicomImage;\n              const viewport = cornerstone.getViewport(element);\n              const canvas = document.getElementsByClassName('cornerstone-canvas')[this.props.activeDcmIndex];\n              const zoom = viewport.scale.toFixed(2);\n              const cols = this.image.columns * zoom;\n              const rows = this.image.rows * zoom;\n\n              let myCanvas = document.createElement('canvas');\n              myCanvas = this.cropCanvas(canvas,\n                Math.round(canvas.width / 2 - cols / 2),\n                Math.round(canvas.height / 2 - rows / 2),\n                cols, rows);\n\n              blobUtil.canvasToBlob(myCanvas, `image/${type}`).then(blob => {\n                blobUtil.blobToArrayBuffer(blob).then(arrayBuffer => {\n                  const name = `${getFileName(this.filename)}-MPR-${this.mprPlane}`;\n                  let newName = name;\n                  let counter = 1;\n                  let done = false;\n                  do {\n                      let filename = `${newName}.${type}`;\n                      const checkName = this.props.fsCurrentList.find(e => e.name === filename);\n                      if (checkName === undefined) {\n                          fs.transaction('rw', fs.files, async () => {\n                              await fs.files.add({\n                                  parent: this.props.fsCurrentDir,\n                                  name: filename,\n                                  type: type,\n                                  size: arrayBuffer.byteLength,\n                                  data: arrayBuffer\n                              })\n                          }).then(() => {\n                            this.props.makeFsRefresh()\n                          });\n                          done = true\n                      } else {\n                          newName = `${name} - ${counter}`;\n                          counter++\n                      }\n                  } while (!done)\n                })\n              })\n            }\n          break\n        }\n        case 'cine': {\n          this.setState({ visibleCinePlayer: !this.state.visibleCinePlayer });\n          break\n        }\n        case 'reset': {\n          this.reset();\n          break\n        }\n        case 'removetool': {\n          console.log('removetool index: ', opt);\n          const element = this.dicomImage;\n          cornerstoneTools.removeToolState(element, this.measurements[opt].tool, this.measurements[opt].data);\n          cornerstone.updateImage(element);\n          //this.props.measurementRemoveStore(opt)\n          this.measurementRemove(opt);\n          this.props.setActiveMeasurements(this.measurements);\n          break\n        }\n        case 'removetools': {\n          const element = this.dicomImage;\n          // for each measurement remove it\n          this.measurements.forEach(measure => {\n            cornerstoneTools.clearToolState(element, measure.tool)\n          });\n          cornerstone.updateImage(element);\n          this.measurementClear();\n          // also remove all measurements from db\n          db.measurement.where('sopinstanceuid').equals(this.sopInstanceUid).delete();\n          this.props.setActiveMeasurements(this.measurements);\n          break\n        }\n        case 'savetools': {\n          // first, remove eventually previous measurements from db\n          db.measurement.where('sopinstanceuid').equals(this.sopInstanceUid).delete();\n          // then save all the current measurements\n          this.measurements.forEach(measure => {\n            try {\n              db.measurement.add({\n                sopinstanceuid: this.sopInstanceUid,\n                tool: measure.tool,\n                note: measure.note,\n                data: measure.data\n              })\n            } catch(error) {\n              console.error(error)\n            }\n          });\n          break\n        }\n        default: {\n          break\n        }\n      }\n    };\n\n    cropCanvas = (canvas, x, y, width, height) => {\n      console.log(`canvas: ${canvas.width}, ${canvas.height}`);\n      console.log(`x, y: ${x}, ${y}`);\n      console.log(`width, height: ${width}, ${height}`);\n\n      // create a temp canvas\n      const newCanvas = document.createElement('canvas');\n      // set its dimensions\n      newCanvas.width = width;\n      newCanvas.height = height;\n      // draw the canvas in the new resized temp canvas\n      newCanvas.getContext('2d').drawImage(canvas, x, y, width, height, 0, 0, width, height);\n      return newCanvas\n    };\n\n    changeTool = (toolName, value) => {\n      console.log('change tool, value: ', toolName, value);\n\n      switch (toolName) {\n        case 'Wwwc':\n          if (value === 1) {\n            cornerstoneTools.setToolActive('Wwwc', { mouseButtonMask: 1 })\n          } else if (value === 0) {\n            cornerstoneTools.setToolPassive('Wwwc')\n          }\n          break;\n        case 'Pan':\n          if (value === 1) {\n            cornerstoneTools.setToolActive('Pan', { mouseButtonMask: 1 })\n          } else if (value === 0) {\n            cornerstoneTools.setToolPassive('Pan')\n          }\n          break;\n        case 'Zoom':\n          if (value === 1) {\n            cornerstoneTools.setToolActive(isMobile ? 'ZoomTouchPinch' : 'Zoom', { mouseButtonMask: 1 })\n          } else if (value === 0) {\n            cornerstoneTools.setToolPassive(isMobile ? 'ZoomTouchPinch' : 'Zoom')\n          }\n          break;\n        case 'Length':\n          if (value === 1) {\n            cornerstoneTools.setToolActive('Length', isMobile ? { isTouchActive: true } : { mouseButtonMask: 1 })\n          } else if (value === 0) {\n            cornerstoneTools.setToolPassive('Length')\n          }\n          break;\n        case 'Probe':\n          if (value === 1) {\n            cornerstoneTools.setToolActive('Probe', { mouseButtonMask: 1 })\n          } else if (value === 0) {\n            cornerstoneTools.setToolPassive('Probe')\n          }\n          break;\n        case 'Angle':\n          if (value === 1) {\n            cornerstoneTools.setToolActive('Angle', { mouseButtonMask: 1 })\n          } else if (value === 0) {\n            cornerstoneTools.setToolPassive('Angle')\n          }\n          break;\n        case 'Magnify':\n          if (value === 1) {\n            cornerstoneTools.setToolActive('Magnify', { mouseButtonMask: 1 })\n          } else if (value === 0) {\n            cornerstoneTools.setToolPassive('Magnify')\n          }\n          break;\n        case 'EllipticalRoi':\n          if (value === 1) {\n            cornerstoneTools.setToolActive('EllipticalRoi', { mouseButtonMask: 1 })\n          } else if (value === 0) {\n            cornerstoneTools.setToolPassive('EllipticalRoi')\n          }\n          break;\n        case 'RectangleRoi':\n          if (value === 1) {\n            cornerstoneTools.setToolActive('RectangleRoi', { mouseButtonMask: 1 })\n          } else if (value === 0) {\n            cornerstoneTools.setToolPassive('RectangleRoi')\n          }\n          break;\n        case 'FreehandRoi':\n          if (value === 1) {\n            cornerstoneTools.setToolActive('FreehandRoi', { mouseButtonMask: 1 })\n          } else if (value === 0) {\n            cornerstoneTools.setToolPassive('FreehandRoi')\n          }\n          break;\n        default:\n            break\n        }\n    };\n\n    runCinePlayer = (cmdName) => {\n      //console.log('this.state.frame: ', this.state.frame)\n      const element = this.dicomImage;\n      switch (cmdName) {\n        case 'firstframe': {\n          let frame = 1;\n          this.setState({frame: frame});\n          scrollToIndex(element, 0);\n          break\n        }\n        case 'previousframe': {\n          if (this.state.frame > 1) {\n            let frame = this.state.frame-1;\n            this.setState({frame: frame});\n            scrollToIndex(element, frame-1)\n          }\n          break\n        }\n        case 'play': {\n          cornerstoneTools.playClip(element, 30);\n          this.setState({inPlay: true});\n          break\n        }\n        case 'pause': {\n            cornerstoneTools.stopClip(element);\n            this.setState({inPlay: false});\n          break\n        }\n        case 'nextframe': {\n          if (this.state.frame < this.numberOfFrames) {\n            let frame = this.state.frame+1;\n            this.setState({frame: frame});\n            scrollToIndex(element, frame-1)\n          }\n          break\n        }\n        case 'lastframe': {\n          let frame = this.numberOfFrames;\n          this.setState({frame: frame});\n          scrollToIndex(element, frame-1);\n          break\n        }\n        default:\n          break\n      }\n    };\n\n    reset = () => {\n      const element = this.dicomImage;\n      const defaultViewport = cornerstone.getDefaultViewportForImage(element, this.image);\n      let viewport = cornerstone.getViewport(element);\n      viewport.voi.windowWidth = defaultViewport.voi.windowWidth;\n      viewport.voi.windowCenter = defaultViewport.voi.windowCenter;\n      viewport.invert = false;\n      cornerstone.setViewport(element, viewport)\n    };\n\n    // -------------------------------------------------------------------------------------------- MPR\n\n    mprPlanePosition = () => {\n      //console.log(\"mprPlanePosition: \")\n      try {\n        console.log(\"is dicom:   \" + this.isDicom);\n        if (!this.isDicom) return this.mprPlane;\n        console.log(\"image data:   \" + this.image.data);\n        const imageOrientation = this.image.data.string('x00200037').split('\\\\');\n        console.log(\"image imageOrientation:   \" + imageOrientation);\n        let v = new Array(6).fill(0);\n        v[0] = parseFloat(imageOrientation[0]); // the x direction cosines of the first row X\n        v[1] = parseFloat(imageOrientation[1]); // the y direction cosines of the first row X\n        v[2] = parseFloat(imageOrientation[2]); // the z direction cosines of the first row X\n        v[3] = parseFloat(imageOrientation[3]); // the x direction cosines of the first column Y\n        v[4] = parseFloat(imageOrientation[4]); // the y direction cosines of the first column Y\n        v[5] = parseFloat(imageOrientation[5]); // the z direction cosines of the first column Y\n        v = v.map((x) => Math.round(x));\n        let p = [v[1]*v[5] - v[2]*v[4], v[2]*v[3] - v[0]*v[5], v[0]*v[4] - v[1]*v[3]]; // cross product of X x Y\n        p = p.map((x) => Math.abs(x));\n        if (p[0] === 1) {\n          this.mprPlane = 'sagittal'\n        } else if (p[1] === 1) {\n          this.mprPlane = 'coronal'\n        } else if (p[2] === 1) {\n          this.mprPlane = 'axial'\n        }\n      } catch(error) { // it's not possible to build MPR\n        console.log('its not possible to build MPR');\n        this.mprPlane = ''\n      }\n      console.log(\"this.mprPlane: \" + this.mprPlane);\n      return this.mprPlane\n    };\n\n    transpose = (matrix) => {\n      return Object.keys(matrix[0]).map(colNumber => matrix.map(rowNumber => rowNumber[colNumber]));\n    };\n\n    mprRenderYZPlane = (filename, origin, x, mprData) => {\n      if (this.volume === null) return;\n      this.filename = filename;\n      cornerstone.disable(this.dicomImage);\n      //console.log(`mprRenderYZPlane, origin: ${origin}, x: ${x}`)\n      //console.log('mprRenderYZPlane, volume: ', this.volume)\n\n      if (origin === 'sagittal')\n        this.mprPlane = 'coronal';\n      else if (origin === 'axial')\n        this.mprPlane = 'sagittal';\n      else\n        this.mprPlane = 'sagittal';\n\n      this.xSize = this.props.files[0].columns;\n      this.ySize = this.props.files[0].rows;\n      this.zSize = mprData.zDim;\n\n      const i = Math.round(x / this.xSize * this.props.files.length);\n      this.originImage = this.props.files[i].image;\n\n      if (origin === 'sagittal') {\n        let xoffset = Math.floor(this.xSize / 2) - Math.floor(this.zSize / 2);\n        let plane = new Int16Array(this.xSize * this.ySize);\n        for (let y = 0; y < this.ySize; y++)\n          for (let z = 0; z < this.zSize; z++)\n            plane[z + this.ySize * y + xoffset] = this.volume[z][x + this.ySize * y];\n        this.loadImageFromCustomObject(this.xSize, this.ySize, plane)\n\n      } else if (origin === 'coronal') {\n        let xoffset = Math.floor(this.xSize / 2) - Math.floor(this.zSize / 2);\n        let plane = new Int16Array(this.xSize * this.ySize);\n        for (let y = 0; y < this.ySize; y++)\n          for (let z = 0; z < this.zSize; z++)\n            plane[z + this.ySize * y + xoffset] = this.volume[z][x + this.ySize * y];\n        this.loadImageFromCustomObject(this.xSize, this.ySize, plane)\n\n      } else { // axial\n        const yzPlane = this.mprBuildYZPlane(x);\n        this.loadImageFromCustomObject(this.ySize, this.zSize, yzPlane)\n      }\n    };\n\n    mprBuildYZPlane = (x) => {\n      //console.log(`mprBuildYZPlane, ySize: ${this.ySize}, zSize: ${this.zSize} `)\n      let plane = new Int16Array(this.ySize * this.zSize);\n      for (var y = 0; y < this.ySize; y++)\n        for (var z = 0; z < this.zSize; z++)\n          plane[y + this.ySize * z] = this.volume[z][x + this.ySize * y];\n      //console.log('mprBuildYZPlane, plane: ', plane)\n      return plane\n    };\n\n    mprRenderXZPlane = (filename, origin, y, mprData) => {\n      if (this.volume === null) return;\n      this.filename = filename;\n      cornerstone.disable(this.dicomImage);\n      //console.log(`mprRenderXZPlane, origin: ${origin}, y: ${y}`)\n      //console.log('mprRenderXZPlane, volume: ', this.volume)\n\n      if (origin === 'sagittal')\n        this.mprPlane = 'axial';\n      else if (origin === 'axial')\n        this.mprPlane = 'coronal';\n      else\n        this.mprPlane = 'axial';\n\n      this.xSize = this.props.files[0].columns;\n      this.ySize = this.props.files[0].rows;\n      this.zSize = mprData.zDim;\n\n      const i = Math.trunc(y / this.ySize * this.props.files.length);\n      this.originImage = this.props.files[i].image;\n\n      if (origin === 'sagittal') {\n        let xoffset = Math.floor(this.xSize / 2) - Math.floor(this.zSize / 2);\n        let plane = new Int16Array(this.xSize * this.ySize);\n        for (let x = 0; x < this.xSize; x++)\n          for (let z = 0; z < this.zSize; z++)\n            plane[z + this.xSize * x + xoffset] = this.volume[z][x + this.xSize * y];\n        this.loadImageFromCustomObject(this.xSize, this.ySize, plane)\n\n      } else {\n        const xzPlane = this.mprBuildXZPlane(y);\n        this.loadImageFromCustomObject(this.xSize, this.zSize, xzPlane)\n      }\n    };\n\n    mprBuildXZPlane = (y) => {\n      //console.log(`mprBuildXZPlane, xSize: ${this.xSize}, zSize: ${this.zSize} `)\n      let plane = new Int16Array(this.xSize * this.zSize);\n      for (let x = 0; x < this.xSize; x++)\n        for (let z = 0; z < this.zSize; z++)\n          plane[x + this.xSize * z] = this.volume[z][x + this.xSize * y];\n      //console.log('mprBuildXZPlane, plane: ', plane)\n      return plane\n    };\n\n    mprIsOrthogonalView = () => {\n      console.log('---------------------------------------');\n      console.log('mprPlane: ', this.mprPlane)\n      console.log('this.props.layout[0]: ', this.props.layout[0])\n      console.log('this.props.layout[1]: ', this.props.layout[1])\n      console.log('result: ' + (this.mprPlane !== '' && this.props.layout[0] === 1 && this.props.layout[1] === 3) ? 'true' : 'false')\n      console.log('---------------------------------------');\n      return (this.mprPlane !== '' && this.props.layout[0] === 1 && this.props.layout[1] === 3)\n    };\n\n    // -------------------------------------------------------------------------------------------- MPR\n\n    dicomImageRef = el => {\n      this.dicomImage = el\n    };\n\n    onImageClick = () => {\n      console.log('onImageClick: ')\n    };\n\n    render() {\n      //console.log('DicomViewer render: ')\n\n      //this.props.visible ? document.body.style = 'background: #000000;' : document.body.style = 'background: $md-grey-700;'\n\n      const isOpen = this.props.isOpen[this.props.index];\n      console.log('isOpen: ' + isOpen);\n      //const visibleHistogram = this.state.visibleHistogram\n      const visibleOpenUrlDlg = this.state.visibleOpenUrlDlg;\n      const errorOnOpenImage = this.state.errorOnOpenImage;\n      const progress = this.state.progress;\n\n      const styleContainer = {\n        width: '100%',\n        height: '100%',\n        border: this.props.activeDcmIndex === this.props.index && (this.props.layout[0] > 1 || this.props.layout[1] > 1) ? 'solid 1px #AAAAAA' : null,\n        position: 'relative',\n      };\n\n      const styleDicomImage = {\n        width: '100%',\n        height: '100%',\n        position: 'relative',\n      };\n\n      const overlay = getSettingsOverlay();\n      console.log('overlay: ' + overlay);\n\n      return (\n        <div className=\"container\" style={styleContainer} >\n\n          {visibleOpenUrlDlg ? <OpenUrlDlg progress={progress} onClose={this.hideOpenUrlDlg} /> : null}\n\n          <Dialog\n            open={errorOnOpenImage !== null}\n            onClose={this.onErrorOpenImageClose}\n          >\n            <DialogTitle id=\"alert-dialog-title\">{\"Error on opening image\"}</DialogTitle>\n            <DialogContent>\n              <DialogContentText id=\"alert-dialog-description\">\n                {this.state.errorOnOpenImage}\n              </DialogContentText>\n            </DialogContent>\n            <DialogActions>\n              <Button onClick={this.onErrorOpenImageClose} autoFocus>\n                Ok\n              </Button>\n            </DialogActions>\n          </Dialog>\n\n          <Dialog\n            open={this.state.errorOnCors}\n            onClose={this.onErrorCorsClose}\n            aria-labelledby=\"alert-dialog-title\"\n            aria-describedby=\"alert-dialog-description\"\n          >\n            <DialogTitle id=\"alert-dialog-title\">{\"Error on loading image\"}</DialogTitle>\n            <DialogContent>\n              <DialogContentText id=\"alert-dialog-description\">\n                <Typography gutterBottom>\n                  CORS or Cross Origin Resource Sharing is a browser security policy\n                  that prevents javascript from loading data from a server with a different base URL\n                  than the server that served up the javascript file.\n                </Typography>\n                <Typography gutterBottom>\n                  See the &nbsp;\n                  <Link href=\"http://enable-cors.org/\" target='_blank' color='textPrimary'>\n                    Enable CORS site\n                  </Link>\n                  &nbsp; for information about CORS.\n                </Typography>\n              </DialogContentText>\n            </DialogContent>\n            <DialogActions>\n              <Button onClick={this.onErrorCorsClose} autoFocus>\n                Ok\n              </Button>\n            </DialogActions>\n          </Dialog>\n\n          <div\n            style={{\n              width: '100%',\n              height: '100%',\n              position: \"relative\",\n              color: '#FFFFFF',\n              textShadow: '1px 1px #000000'\n            }}\n            onContextMenu={() => false}\n            className=\"cornerstone-enabled-image\"\n          >\n            <div\n              ref={this.dicomImageRef} style={styleDicomImage}\n            >\n            </div>\n\n            <div\n              id={`mrtopleft-${this.props.index}`}\n              style={{ position: \"absolute\", top: 0, left: 3, display: isOpen && overlay ? \"\" : \"none\" }}\n            >\n\n            </div>\n            <div\n              id={`mrtopright-${this.props.index}`}\n              style={{ position: \"absolute\", top: 0, right: 3, display: isOpen && overlay ? \"\" : \"none\" }}\n            >\n\n            </div>\n            <div\n              id={`mrbottomright-${this.props.index}`}\n              style={{ position: \"absolute\", bottom: 0, right: 3, display: isOpen && overlay ? \"\" : \"none\" }}\n            >\n\n            </div>\n            <div\n              id={`mrbottomleft-${this.props.index}`}\n              style={{ position: \"absolute\", bottom: 0, left: 3, display: isOpen && overlay ? \"\" : \"none\" }}\n            >\n\n            </div>\n\n            <div\n              id={`mrtopcenter-${this.props.index}`}\n              style={{ position: \"absolute\", top: 0, width: '60px', left: '50%', marginLeft: '0px', display: isOpen && overlay ? \"\" : \"none\" }}\n            >\n\n            </div>\n\n            <div\n              id={`mrleftcenter-${this.props.index}`}\n              style={{ position: \"absolute\", top: '50%', width: '30px', left: 3, marginLeft: '0px', display: isOpen && overlay ? \"\" : \"none\" }}\n            >\n\n            </div>\n\n            <div\n              id={`mrrightcenter-${this.props.index}`}\n              style={{ position: \"absolute\", top: '50%', width: '30px', right: 3, marginRight: '-20px', display: isOpen && overlay ? \"\" : \"none\" }}\n            >\n\n            </div>\n\n            <div\n              id={`mrbottomcenter-${this.props.index}`}\n              style={{ position: \"absolute\", bottom: 0, width: '60px', left: '50%', marginLeft: '0px', display: isOpen && overlay ? \"\" : \"none\" }}\n            >\n\n            </div>\n\n            { this.state.visibleCinePlayer && this.numberOfFrames > 1 ? (\n              <div style={{position:\"absolute\", width:'100%', bottom:0, textAlign:'center'}}>\n                <div style={{margin:'0 auto', width:'240px', backgroundColor:'rgba(136, 136, 136, 0.5)'}}>\n                  <CinePlayer runCinePlayer={this.runCinePlayer} inPlay={this.state.inPlay} />\n                  <div\n                    id={`frameLabel-${this.props.index}`}\n                    style={{ width:230, margin:'0 auto', marginTop:-10, textAlign:\"center\" }}\n                  >\n                    {this.state.frame} / {this.numberOfFrames}\n                  </div>\n                </div>\n              </div>\n              ) : null\n            }\n            {/*<div style={{position:\"absolute\", width:'100%', height:'100%', top:0, left:0}}></div>*/}\n          </div>\n        </div>\n      )\n    }\n  }\n\nconst mapStateToProps = (state) => {\n  return {\n    files: state.files,\n    url: state.url,\n    isOpen: state.isOpen,\n    tool: state.tool,\n    activeDcmIndex: state.activeDcmIndex,\n    activeDcm: state.activeDcm,\n    measurements: state.measurements,\n    layout: state.layout,\n    fsCurrentDir: state.fsCurrentDir,\n    fsCurrentList: state.fsCurrentList,\n    volume: state.volume,\n    lut: state.lut,\n    //sandboxedFile: state.sandboxedFile,\n  }\n};\n\nconst mapDispatchToProps = (dispatch) => {\n  return {\n    clearingStore: () => dispatch(clearStore()),\n    setIsOpenStore: (value) => dispatch(dcmIsOpen(value)),\n    toolStore: (tool) => dispatch(dcmTool(tool)),\n    setActiveDcm: (dcm) => dispatch(activeDcm(dcm)),\n    setActiveMeasurements: (measurements) => dispatch(activeMeasurements(measurements)),\n    makeFsRefresh: (dcm) => dispatch(doFsRefresh()),\n    //setLutStore: (lut) => dispatch(setLut(lut)),\n  }\n};\n\nexport default connect(mapStateToProps, mapDispatchToProps)(DicomViewer)\n"]},"metadata":{},"sourceType":"module"}